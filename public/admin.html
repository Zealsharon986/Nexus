<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citron Trades - Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="assets/icons/6629ad2a661a5bfd1a82b5c3_logo.svg" type="image/svg+xml">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            /* Dark theme variables */
            --bg-dark: #161625;
            --bg-card: #1A1A2E;
            --color-primary: #6474ff;
            --color-primary-hover: #5461e6;
            --color-text: #ffffff;
            --color-text-secondary: #a0a0b8;
            --color-border: #2a2a3d;
            --color-positive: #40B467;  /* Keep green for profits */
            --color-negative: #e74c3c;  /* Keep red for losses */
            --color-warning: #f39c12;
            --color-info: #3498db;
        }

        /* Light theme variables */
        :root[data-theme="light"] {
            --bg-dark: #f8f9fa;
            --bg-card: #ffffff;
            --color-text: #2d3436;
            --color-text-secondary: #636e72;
            --color-border: #dfe6e9;
            --color-primary: #6474ff;
            --color-primary-hover: #5461e6;
            --color-positive: #40B467;  /* Keep green for profits */
            --color-negative: #e74c3c;  /* Keep red for losses */
            --color-warning: #f39c12;
            --color-info: #3498db;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--color-text);
            min-height: 100vh;
            line-height: 1.5;
        }
        .dashboard {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 260px;
            background: var(--bg-dark);
            padding: 1.5rem 1rem;
            border-right: 1px solid var(--color-border);
            transition: transform 0.3s ease;
            position: fixed;
            height: 100%;
            z-index: 1000;
            overflow-y: auto;
        }
        .sidebar.hidden { transform: translateX(-260px); }
        .logo-container {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            padding-left: 0.5rem;
        }
        .logo {
            height: 32px;
            margin-right: 0.75rem;
            content: url("assets/icons/6629ad2a661a5bfd1a82b5c3_logo.svg");
        }
        
        /* Switch logo for light theme */
        :root[data-theme="light"] .logo {
            content: url("assets/icons/6629ad2a661a5bfd1a82b5c3_logo.svg");
        }
        
        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .nav-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin: 1.5rem 0 0.5rem 0.5rem;
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin: 0.25rem 0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            color: var(--color-text-secondary);
        }
        .nav-item svg {
            margin-right: 0.75rem;
        }
        .nav-item:hover {
            background: rgba(64, 180, 103, 0.1);
            color: var(--color-text);
        }
        .nav-item.active {
            background: rgba(64, 180, 103, 0.15);
            color: var(--color-primary);
        }
        .main {
            flex: 1;
            padding: 1.5rem;
            margin-left: 260px;
            transition: margin-left 0.3s ease;
        }
        .main.full { margin-left: 0; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--color-border);
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .toggle-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--color-text);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
        }
        .panel {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .panel.active {
            display: block;
            opacity: 1;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Admin-specific styles */
        .admin-badge {
            background: var(--color-primary);
            color: #fff;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }
        .admin-info {
            display: flex;
            align-items: center;
            color: var(--color-text);
            font-weight: 500;
        }

        /* Theme toggle button styles */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: none;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            cursor: pointer;
            margin-right: 1rem;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: rgba(64, 180, 103, 0.1);
        }

        .theme-toggle svg {
            width: 18px;
            height: 18px;
        }
    </style>
    <style>
        /* Admin dashboard specific components */
        .section {
            margin-bottom: 2rem;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-text);
        }
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--color-border);
            overflow: hidden;
            margin-bottom: 1.5rem;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--color-border);
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .card-content {
            padding: 1.25rem;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 1.25rem;
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: -0.5rem;
        }
        .form-col {
            flex: 1;
            padding: 0.5rem;
            min-width: 200px;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
        }
        input, select, textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            font-size: 0.95rem;
            transition: border-color 0.2s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--color-primary);
        }
        .input-hint {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            margin-top: 0.25rem;
        }
        
        /* Button styles */
        .btn, button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.65rem 1.25rem;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn:hover, button:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
        }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--color-primary);
            color: var(--color-primary);
        }
        .btn-outline:hover {
            background: rgba(64, 180, 103, 0.1);
        }
        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }
        .btn-warning {
            background-color: var(--color-warning);
        }
        .btn-warning:hover {
            background-color: #d68c10;
        }
        .btn-danger {
            background-color: var(--color-negative);
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .btn-group {
            display: flex;
            gap: 0.5rem;
        }
        
        /* Status badges */
        .status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .status.pending {
            background: rgba(243, 156, 18, 0.15);
            color: #f39c12;
        }
        .status.completed, .status.approved {
            background: rgba(64, 180, 103, 0.15);
            color: var(--color-positive);
        }
        .status.failed, .status.declined {
            background: rgba(231, 76, 60, 0.15);
            color: var(--color-negative);
        }
        
        /* Client management styles */
        .clients-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .client-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            overflow: hidden;
        }
        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .client-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .client-name {
            font-weight: 500;
        }
        .client-email {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }
        .client-balance {
            font-weight: 600;
            color: var(--color-primary);
        }
        .client-details {
            padding: 1rem;
            border-top: 1px solid var(--color-border);
            display: none;
        }
        .client-details.active {
            display: block;
        }
        .client-actions {
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .action-group {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .action-group-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--color-text);
        }
        
        /* Transaction management styles */
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--color-border);
        }
        .transaction-item:last-child {
            border-bottom: none;
        }
        .transaction-details {
            flex: 1;
        }
        .transaction-type {
            font-weight: 500;
        }
        .transaction-amount {
            font-weight: 600;
            color: var(--color-primary);
        }
        .transaction-date {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }
        .transaction-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        /* Admin log styles */
        .admin-log-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            padding: 0.75rem;
            border-bottom: 1px solid var(--color-border);
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-timestamp {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            margin-bottom: 0.25rem;
        }
        .log-message {
            color: var(--color-text);
        }
        .log-admin {
            font-weight: 500;
            color: var(--color-primary);
        }
        
        /* Payment methods and settings styles */
        .payment-methods-group {
            background: rgba(64, 180, 103, 0.05);
            border: 1px solid rgba(64, 180, 103, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        .payment-method-field {
            margin-bottom: 0.75rem;
        }
        .payment-method-field:last-child {
            margin-bottom: 0;
        }
        .input-group {
            display: flex;
            align-items: center;
        }
        .input-group input {
            flex: 1;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        .input-group button {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
        
        /* Settings section */
        .settings-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        .setting-card {
            background: var(--bg-card);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 1rem;
        }
        .setting-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .setting-description {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            margin-bottom: 1rem;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: auto;
            visibility: hidden;
        }

        .modal.show {
            opacity: 1;
            display: flex !important;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            position: relative;
            color: var(--color-text);
            border: 1px solid var(--color-border);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(0);
            transition: transform 0.3s ease-in-out;
            pointer-events: auto;
            z-index: 10000;
        }

        .transaction-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            border-bottom: 1px solid var(--color-border);
        }

        .transaction-detail-row:last-child {
            border-bottom: none;
        }

        .transaction-detail-label {
            font-weight: 500;
            color: var(--color-text-secondary);
        }

        .transaction-detail-value {
            color: var(--color-text);
            text-align: right;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--color-text-secondary);
            padding: 0.5rem;
            line-height: 1;
            transition: color 0.2s ease-in-out;
            z-index: 10001;
            pointer-events: auto;
        }

        .close-modal:hover {
            color: var(--color-text);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-right: 2rem;
            color: var(--color-text);
        }

        #transaction-details-content {
            margin: 1rem 0;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .form-actions {
            margin-top: 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        .form-actions .btn {
            min-width: 100px;
            pointer-events: auto;
        }
        
        /* Ensure modal is above all other content */
        .modal, .modal-content {
            z-index: 9999;
        }
        
        /* Ensure buttons are clickable */
        .btn {
            pointer-events: auto;
            cursor: pointer;
            position: relative;
            z-index: 1;
        }
        
        /* Responsive styles */
        @media (max-width: 1024px) {
            .main {
                margin-left: 0;
            }
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.visible {
                transform: translateX(0);
            }
        }
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
                padding: 1rem 0;
                position: relative;
            }
            .header-left {
                width: 100%;
                flex-direction: row;
                align-items: center;
                justify-content: flex-start;
                gap: 1rem;
            }
            .mobile-brand {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                position: relative;
                padding: 0 3.5rem;
            }
            .logo {
                height: 30px;
                width: auto;
                background: none;
                border-radius: 0;
                padding: 0;
                margin: 0;
            }
            .logo-text {
                display: none;
            }
            .header-title {
                display: none; /* Hide panel titles on mobile */
            }
            .toggle-btn {
                position: absolute;
                top: 1rem;
                left: 1rem;
                z-index: 10;
            }
            .theme-toggle {
                position: absolute;
                top: 1rem;
                right: 1rem;
                z-index: 10;
                margin-right: 0;
            }
            .admin-info {
                width: 100%;
                flex-direction: column;
                align-items: center;
                text-align: center;
                gap: 0.25rem;
                margin-top: 0.5rem;
            }
            .form-row {
                flex-direction: column;
            }
            .client-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
    <style>
        /* Mobile Responsive Styles */
        @media (max-width: 1024px) {
            .main {
                margin-left: 0;
                padding: 1rem;
            }
            .sidebar {
                transform: translateX(-100%);
                z-index: 1000;
                background: var(--bg-dark);
                box-shadow: 2px 0 8px rgba(0, 0, 0, 0.2);
                transition: transform 0.3s ease;
            }
            .sidebar.visible {
                transform: translateX(0);
            }
            .logo-container {
                padding: 1rem;
                margin-bottom: 1.5rem;
                border-bottom: 1px solid var(--color-border);
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            .logo-container .mobile-close {
                display: block;
                padding: 0.5rem;
                cursor: pointer;
                color: var(--color-text-secondary);
            }
            .mobile-header {
                display: flex;
                align-items: center;
                gap: 1rem;
                margin-bottom: 1rem;
            }
            .mobile-logo {
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: var(--color-primary);
                border-radius: 8px;
                color: white;
                font-weight: bold;
                font-size: 1.2rem;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
                padding: 1rem 0;
                position: relative;
            }
            .header-left {
                width: 100%;
                flex-direction: column;
                align-items: flex-start;
            }
            .mobile-brand {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                position: absolute;
                top: 1rem;
                left: 50%;
                transform: translateX(-50%);
                padding: 0 3.5rem;
            }
            .mobile-brand .logo {
                height: 30px;
                width: auto;
                background: none;
                border-radius: 0;
                padding: 0;
                margin: 0;
            }
            .mobile-brand .logo-text {
                display: none;
            }
            .mobile-logo {
                display: none !important;
            }
            .toggle-btn {
                position: absolute;
                top: 1rem;
                left: 1rem;
                z-index: 10;
            }
            .theme-toggle {
                position: absolute;
                top: 1rem;
                right: 1rem;
                z-index: 10;
                margin-right: 0;
            }
            .admin-info {
                width: 100%;
                flex-direction: column;
                align-items: center;
                text-align: center;
                gap: 0.25rem;
                margin-top: 4rem;
            }
            .admin-badge {
                margin-left: 0;
                margin-top: 0.25rem;
            }
            .mobile-header {
                display: none;
            }

            /* Card and form adjustments */
            .form-row {
                flex-direction: column;
            }
            .form-col {
                width: 100%;
                min-width: 100%;
            }
            .card {
                margin: 0 -1rem;
                border-radius: 0;
            }
            .card-content {
                padding: 1rem;
            }
            
            /* Stats grid adjustments */
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            .stat-card {
                padding: 1rem;
            }

            /* Table adjustments */
            .table-container {
                margin: 0 -1rem;
                width: calc(100% + 2rem);
                overflow-x: auto;
            }
            .table {
                font-size: 0.85rem;
            }
            .table th,
            .table td {
                padding: 0.75rem;
                white-space: nowrap;
            }

            /* Client management adjustments */
            .client-item {
                padding: 1rem;
            }
            .client-header {
                flex-direction: column;
                gap: 0.5rem;
            }
            .client-actions {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            .client-actions .btn {
                width: 100%;
            }

            /* Modal adjustments */
            .modal-content {
                width: 95%;
                margin: 1rem;
                max-height: 90vh;
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .header-title {
                font-size: 1.25rem;
            }
            .section-title {
                font-size: 1.1rem;
            }
            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
            .table th:nth-child(4),
            .table td:nth-child(4) {
                display: none;
            }
            .client-details {
                padding: 0.75rem;
            }
            .action-group {
                padding: 0.75rem;
            }
        }

        /* Hide mobile elements on desktop */
        .mobile-close,
        .mobile-header,
        .mobile-brand {
            display: none;
        }

        /* Show mobile brand only on mobile */
        @media (max-width: 768px) {
            .mobile-brand {
                display: flex;
            }
        }
    </style>
</head><body>
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="logo-container">
                <img src="https://gistcdn.githack.com/Zealsharon986/065de595e0ffdfa2d7cf23881e1e23d3/raw/b1b64e7237340a6aae8bb39f69dc2298a521dc10/logo.svg" alt="Citron Trades" class="logo">
            </div>
            
            <div class="nav-label">Dashboard</div>
            <div class="nav-item active" data-panel="overview">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></svg>
                Overview
            </div>
            <div class="nav-item" data-panel="clients">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                Clients
            </div>
            <div class="nav-item" data-panel="transactions">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                Transactions
            </div>
            
            <div class="nav-label">Administration</div>
            <div class="nav-item" data-panel="settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                Settings
            </div>
            <div class="nav-item" data-panel="logs">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                Admin Logs
            </div>
        </div>

        <!-- Main Content -->
        <div class="main" id="main">
            <!-- Add mobile header -->
            <div class="mobile-header">
                <div class="mobile-logo">C</div>
                <h1 class="header-title">Citron Trades</h1>
            </div>
            <div class="header">
                <div class="header-left">
                    <button class="toggle-btn" id="toggle-sidebar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </button>
                    <!-- Add mobile brand section -->
                    <div class="mobile-brand">
                        <img src="https://gistcdn.githack.com/Zealsharon986/065de595e0ffdfa2d7cf23881e1e23d3/raw/b1b64e7237340a6aae8bb39f69dc2298a521dc10/logo.svg" alt="Citron Trades" class="logo">
                    </div>
                    <h1 class="header-title" id="panel-title">Overview</h1>
                </div>
                <div class="admin-info">
                    <button class="theme-toggle" id="theme-toggle" title="Toggle theme">
                        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </button>
                    <span id="admin-email">admin@citrontrades.com</span>
                    <span class="admin-badge">Admin</span>
                </div>
                <button id="logout-btn" class="btn btn-outline">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    Logout
                </button>
            </div><!-- Overview Panel -->
            <div class="panel active" id="overview">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Platform Overview</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Platform Statistics</h3>
                        </div>
                        <div class="card-content">
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="stat-card">
                                        <div class="stat-card-header">
                                            <h3>Total Users</h3>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                                        </div>
                                        <div class="stat-card-value" id="total-users">0</div>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="stat-card">
                                        <div class="stat-card-header">
                                            <h3>Platform Balance</h3>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                                        </div>
                                        <div class="stat-card-value" id="total-balance">$0.00</div>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="stat-card">
                                        <div class="stat-card-header">
                                            <h3>Pending Requests</h3>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-warning"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                        </div>
                                        <div class="stat-card-value" id="pending-requests">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Recent Transactions</h2>
                        <a href="#" class="view-all" id="view-all-transactions">View All</a>
                    </div>
                    
                    <div class="card">
                        <div class="card-content">
                            <div id="recent-transactions">
                                <!-- Will be populated by JavaScript -->
                                <div class="no-data">Loading transactions...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Pending Requests</h2>
                        <a href="#" class="view-all" id="view-all-requests">View All</a>
                    </div>
                    
                    <div class="card">
                        <div class="card-content">
                            <div id="pending-transactions">
                                <!-- Will be populated by JavaScript -->
                                <div class="no-data">Loading pending requests...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Clients Panel -->
            <div class="panel" id="clients">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Client Management</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">All Clients</h3>
                            <div class="search-container">
                                <input type="text" id="client-search" placeholder="Search clients..." class="search-input">
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="clients-container" id="clients-container">
                                <!-- Will be populated by JavaScript -->
                                <div class="no-data">Loading clients...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- Transactions Panel -->
            <div class="panel" id="transactions">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Transaction Management</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">All Transactions</h3>
                            <div class="transaction-filters">
                                <select id="transaction-type-filter" class="styled-select">
                                    <option value="all">All Types</option>
                                    <option value="deposit">Deposits</option>
                                    <option value="withdrawal">Withdrawals</option>
                                    <option value="auto_profit">Auto Profit</option>
                                </select>
                                <select id="transaction-status-filter" class="styled-select">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="completed">Completed</option>
                                    <option value="failed">Failed</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-content">
                            <div id="all-transactions">
                                <!-- Will be populated by JavaScript -->
                                <div class="no-data">Loading transactions...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Panel -->
            <div class="panel" id="settings">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Platform Settings</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Payment Methods</h3>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label for="global-btc-address">Default Bitcoin Address</label>
                                <div class="input-group">
                                    <input type="text" id="global-btc-address" placeholder="e.g., bc1q...">
                                    <button id="save-btc-address" class="btn">Save</button>
                                </div>
                                <div class="input-hint">This address will be used for all users' Bitcoin deposits unless overridden.</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="global-nowpayments-link">Default NOWPayments Link</label>
                                <div class="input-group">
                                    <input type="text" id="global-nowpayments-link" placeholder="e.g., https://nowpayments.io/...">
                                    <button id="save-nowpayments-link" class="btn">Save</button>
                                </div>
                                <div class="input-hint">This link will be used for all users' crypto payments unless overridden.</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="global-simplex-link">Default Simplex Link</label>
                                <div class="input-group">
                                    <input type="text" id="global-simplex-link" placeholder="e.g., https://buy.simplex.com/...">
                                    <button id="save-simplex-link" class="btn">Save</button>
                                </div>
                                <div class="input-hint">This link will be used for all users' card payments.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Auto-Profit Settings</h3>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label for="default-profit-amount">Default Profit Amount ($)</label>
                                <div class="input-group">
                                    <input type="number" id="default-profit-amount" placeholder="e.g., 10" min="1" step="0.01">
                                    <button id="save-profit-amount" class="btn">Save</button>
                                </div>
                                <div class="input-hint">Default amount for auto-profit feature for new users.</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="default-profit-interval">Default Profit Interval (minutes)</label>
                                <div class="input-group">
                                    <input type="number" id="default-profit-interval" placeholder="e.g., 30" min="10" step="1">
                                    <button id="save-profit-interval" class="btn">Save</button>
                                </div>
                                <div class="input-hint">Default interval for auto-profit feature for new users (min: 10 minutes).</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Security Settings</h3>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="require-kyc-withdrawal">
                                    Require KYC for withdrawals
                                </label>
                                <div class="input-hint">If enabled, users must complete KYC verification before making withdrawals.</div>
                            </div>
                            
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="notify-large-transactions">
                                    Notify on large transactions
                                </label>
                                <div class="input-hint">Send admin notification for transactions above threshold.</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="large-transaction-threshold">Large Transaction Threshold ($)</label>
                                <input type="number" id="large-transaction-threshold" placeholder="e.g., 1000" min="100" step="10">
                            </div>
                            
                            <button id="save-security-settings" class="btn">Save Security Settings</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Logs Panel -->
            <div class="panel" id="logs">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Admin Activity Logs</h2>
                        <button id="refresh-logs" class="btn btn-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 2v6h6M21.5 22v-6h-6"></path><path d="M22 11.5A10 10 0 0 0 3.2 7.2M2 12.5a10 10 0 0 0 18.8 4.2"></path></svg>
                            Refresh
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Recent Activity</h3>
                        </div>
                        <div class="card-content">
                            <div class="admin-log-container" id="admin-logs">
                                <!-- Will be populated by JavaScript -->
                                <div class="no-data">Loading admin logs...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div></div>
    </div>
    
    <!-- Client Template (Hidden) -->
    <template id="client-template">
        <div class="client-item" data-uid="{uid}">
            <div class="client-header">
                <div>
                    <div class="client-name">{name}</div>
                    <div class="client-email">{email}</div>
                </div>
                <div>
                    <div class="client-balance">${balance}</div>
                    <div class="client-level">Level: {level}</div>
                </div>
            </div>
            <div class="client-details">
                <div class="action-group">
                    <div class="action-group-title">Account Information</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="account-level-{uid}">Account Level</label>
                                <select id="account-level-{uid}" class="account-level-select" data-uid="{uid}">
                                    <option value="Basic">Basic</option>
                                    <option value="Pro">Pro</option>
                                    <option value="Elite">Elite</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="balance-{uid}">Balance ($)</label>
                                <input type="number" id="balance-{uid}" class="balance-input" data-uid="{uid}" value="{balance}" step="0.01">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="account-manager-{uid}">Account Manager</label>
                                <input type="text" id="account-manager-{uid}" class="account-manager-input" data-uid="{uid}" value="{accountManager}" placeholder="Enter account manager name">
                            </div>
                        </div>
                    </div>
                    
                    <div class="client-actions">
                        <button class="btn update-account" data-uid="{uid}">Update Account</button>
                    </div>
                </div>
                
                <div class="action-group">
                    <div class="action-group-title">Warning Management</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="warning-message-{uid}">Warning Message</label>
                                <textarea id="warning-message-{uid}" class="warning-message-input" data-uid="{uid}" placeholder="Enter warning message"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="toggle-label">
                                    <input type="checkbox" id="show-warnings-{uid}" class="show-warnings-toggle" data-uid="{uid}">
                                    Show warnings to user
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="client-actions">
                        <button class="btn btn-warning add-warning" data-uid="{uid}">Add Warning</button>
                    </div>
                </div>
                
                <div class="action-group">
                    <div class="action-group-title">KYC Verification</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="kyc-status-{uid}">KYC Status</label>
                                <select id="kyc-status-{uid}" class="kyc-status-select" data-uid="{uid}">
                                    <option value="unverified">Unverified</option>
                                    <option value="pending">Pending</option>
                                    <option value="verified">Verified</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="kyc-reason-{uid}">Rejection Reason (if applicable)</label>
                                <input type="text" id="kyc-reason-{uid}" class="kyc-reason-input" data-uid="{uid}" placeholder="Reason for rejection">
                            </div>
                        </div>
                    </div>
                    
                    <div id="kyc-preview-container-{uid}" class="kyc-preview-container">
                        <!-- KYC image will be shown here if available -->
                    </div>
                    
                    <div class="client-actions">
                        <button class="btn update-kyc" data-uid="{uid}">Update KYC Status</button>
                    </div>
                </div>
                
                <div class="action-group">
                    <div class="action-group-title">Auto-Profit Settings</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="auto-profit-amount-{uid}">Profit Amount ($)</label>
                                <input type="number" id="auto-profit-amount-{uid}" class="auto-profit-amount-input" data-uid="{uid}" min="1" step="0.01">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="auto-profit-interval-{uid}">Interval (minutes)</label>
                                <input type="number" id="auto-profit-interval-{uid}" class="auto-profit-interval-input" data-uid="{uid}" min="10" step="1">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="auto-profit-toggle-{uid}">Status</label>
                                <select id="auto-profit-toggle-{uid}" class="auto-profit-toggle-select" data-uid="{uid}">
                                    <option value="enabled">Enabled</option>
                                    <option value="disabled">Disabled</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="auto-trade-block-{uid}">Block Auto-Trade</label>
                                <select id="auto-trade-block-{uid}" class="auto-trade-block-select" data-uid="{uid}">
                                    <option value="unblocked">Unblocked</option>
                                    <option value="blocked">Blocked</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="client-actions">
                        <button class="btn update-auto-profit" data-uid="{uid}">Update Auto-Trade</button>
                    </div>
                </div>
                
                <!-- New Payment Methods Section -->
                <div class="action-group payment-methods-group">
                    <div class="action-group-title">Payment Methods</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group payment-method-field">
                                <label for="nowpayments-link-{uid}">NOWPayments Link</label>
                                <input type="text" id="nowpayments-link-{uid}" class="nowpayments-input" data-uid="{uid}" value="{nowPaymentsLink}" placeholder="e.g., https://nowpayments.io/...">
                                <div class="input-hint">For user's 'Pay With Crypto' button</div>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group payment-method-field">
                                <label for="btc-address-{uid}">BTC Address</label>
                                <input type="text" id="btc-address-{uid}" class="btc-address-input" data-uid="{uid}" value="{btcAddress}" placeholder="e.g., bc1q...">
                                <div class="input-hint">For user's crypto deposits</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="client-actions">
                        <button class="btn update-payment-methods" data-uid="{uid}">Update Payment Methods</button>
                    </div>
                </div>
                
                <div class="action-group">
                    <div class="action-group-title">Withdrawal Settings</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="withdrawal-code-{uid}">Withdrawal Code</label>
                                <div class="input-group">
                                    <input type="text" id="withdrawal-code-{uid}" class="withdrawal-code-input" data-uid="{uid}" maxlength="6" placeholder="Enter 6-digit code">
                                    <button class="btn update-withdrawal-code" data-uid="{uid}">Set Code</button>
                                </div>
                                <div class="input-hint">Set a 6-digit code required for withdrawals</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="action-group">
                    <div class="action-group-title">Recent Transactions</div>
                    <div class="client-transactions" id="client-transactions-{uid}">
                        <div class="no-data">Loading transactions...</div>
                    </div>
                </div>
                
                <div class="action-group">
                    <div class="action-group-title">Support Chat</div>
                    <div class="client-chat" id="client-chat-{uid}">
                        <div class="form-group">
                            <textarea id="chat-message-{uid}" class="chat-message-input" data-uid="{uid}" placeholder="Type your message..."></textarea>
                        </div>
                        <div class="client-actions">
                            <button class="btn send-message" data-uid="{uid}">Send Message</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Transaction Template (Hidden) -->
    <template id="transaction-template">
        <div class="transaction-item" data-id="{id}">
            <div class="transaction-details">
                <div class="transaction-type">{type}</div>
                <div class="transaction-info">
                    <span class="transaction-amount">{amount}</span>
                    <span class="transaction-status">{status}</span>
                </div>
                <div class="transaction-date">{date}</div>
                <div class="transaction-user">User: {user}</div>
            </div>
            <div class="transaction-actions">
                {buttons}
            </div>
        </div>
    </template>
    
    <!-- Log Entry Template (Hidden) -->
    <template id="log-entry-template">
        <div class="log-entry">
            <div class="log-timestamp">{timestamp}</div>
            <div class="log-message">
                <span class="log-admin">{admin}</span> {action}
            </div>
        </div>
    </template>
    
    <!-- Client Transaction Template (Hidden) -->
    <template id="client-transaction-template">
        <div class="transaction-item client-transaction" data-id="{id}">
            <div class="transaction-details">
                <div class="transaction-type">{type}</div>
                <div class="transaction-info">
                    <span class="transaction-amount">{amount}</span>
                    <span class="transaction-status">{status}</span>
                </div>
                <div class="transaction-date">{date}</div>
            </div>
            <div class="transaction-actions">
                {buttons}
            </div>
        </div>
    </template>
    
    <!-- Add Warning Modal -->
    <div class="modal" id="warning-modal">
        <div class="modal-content">
            <button class="close-modal" id="close-warning-modal"></button>
            <h2 class="modal-title">Add Warning</h2>
            <p class="modal-desc">This warning will be displayed to the user on their dashboard.</p>
            
            <div class="form-group">
                <label for="warning-message">Warning Message</label>
                <textarea id="warning-message" placeholder="Enter warning message" rows="4"></textarea>
            </div>
            
            <input type="hidden" id="warning-user-id">
            
            <div class="form-actions">
                <button class="btn btn-outline" id="cancel-warning">Cancel</button>
                <button class="btn btn-warning" id="submit-warning">Add Warning</button>
            </div>
        </div>
    </div>
    
    <!-- Transaction Details Modal -->
    <div class="modal" id="transaction-details-modal">
        <div class="modal-content">
            <button class="close-modal" id="close-transaction-modal"></button>
            <h2 class="modal-title">Transaction Details</h2>
            
            <div id="transaction-details-content">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <div class="form-actions">
                <button class="btn" id="close-transaction-details">Close</button>
            </div>
        </div>
    </div><!-- Core Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            getDocs, 
            updateDoc, 
            addDoc, 
            arrayUnion, 
            query, 
            where, 
            orderBy, 
            Timestamp, 
            onSnapshot,
            serverTimestamp,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAEPH6zPhhmyrAL8YPKzJWZZVOT8LScpIg",
            authDomain: "invest-mgnt.firebaseapp.com",
            projectId: "invest-mgnt",
            storageBucket: "invest-mgnt.firebasestorage.app",
            messagingSenderId: "658245081425",
            appId: "1:658245081425:web:73eeaa2614e426030c1b70",
            measurementId: "G-F03JXGD2ZT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Global variables
        let currentAdmin = null;
        let allUsers = [];
        let adminName = 'Admin';
        let platformSettings = {};
        
        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const main = document.getElementById('main');
        const navItems = document.querySelectorAll('.nav-item');
        const logoutBtn = document.getElementById('logout-btn');
        const toggleSidebarBtn = document.getElementById('toggle-sidebar');
        
        // Wait for DOM to be loaded before setting up event listeners
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, setting up event listeners');
            setupNavigation();
            setupLogout();
            setupModals();
        });
        
        // Setup Navigation
        function setupNavigation() {
            // Toggle sidebar
            const toggleSidebarBtn = document.getElementById('toggle-sidebar');
            const closeSidebarBtn = document.getElementById('close-sidebar');
            const sidebar = document.getElementById('sidebar');
            const main = document.getElementById('main');
            
            toggleSidebarBtn.addEventListener('click', () => {
                console.log('Toggle sidebar clicked');
                if (window.innerWidth <= 1024) {
                    sidebar.classList.toggle('visible');
                } else {
                    sidebar.classList.toggle('hidden');
                    main.classList.toggle('full');
                }
            });

            // Close sidebar on mobile
            if (closeSidebarBtn) {
                closeSidebarBtn.addEventListener('click', () => {
                    sidebar.classList.remove('visible');
                });
            }

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 1024 && 
                    !sidebar.contains(e.target) && 
                    !toggleSidebarBtn.contains(e.target) &&
                    sidebar.classList.contains('visible')) {
                    sidebar.classList.remove('visible');
                }
            });

            // Close sidebar when clicking nav items on mobile
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    if (window.innerWidth <= 1024) {
                        sidebar.classList.remove('visible');
                    }
                });
            });
            
            // Panel switching
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const panelId = item.getAttribute('data-panel');
                    console.log(`Nav item clicked: ${panelId}`);
                    
                    // Remove active class from all nav items
                    navItems.forEach(nav => nav.classList.remove('active'));
                    
                    // Add active class to clicked nav item
                    item.classList.add('active');
                    
                    // Hide all panels
                    const panels = document.querySelectorAll('.panel');
                    panels.forEach(panel => panel.classList.remove('active'));
                    
                    // Show selected panel
                    const panel = document.getElementById(panelId);
                    if (panel) {
                        panel.classList.add('active');
                        document.getElementById('panel-title').textContent = panelId.charAt(0).toUpperCase() + panelId.slice(1);
                        console.log(`Panel ${panelId} activated`);
                    } else {
                        console.error(`Panel with ID ${panelId} not found`);
                    }
                });
            });
        }
        
        // Setup Logout Button
        function setupLogout() {
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Logout button clicked');
                    
                    signOut(auth)
                        .then(() => {
                            console.log('Admin signed out successfully');
                            window.location.href = 'login.html';
                        })
                        .catch((error) => {
                            console.error('Error signing out:', error);
                            alert('Error signing out: ' + error.message);
                        });
                });
            } else {
                console.error('Logout button not found in DOM');
            }
        }
        
        // Setup Modals
        function setupModals() {
            // Transaction Modal
            const transactionModal = document.getElementById('transaction-modal');
            const closeTransactionModal = document.getElementById('close-transaction-modal');
            const closeTransactionDetails = document.getElementById('close-transaction-details');
            
            if (transactionModal) {
                closeTransactionModal.addEventListener('click', () => {
                    transactionModal.style.display = 'none';
                });
                
                closeTransactionDetails.addEventListener('click', () => {
                    transactionModal.style.display = 'none';
                });
            }
        }
        
        // Authentication Check
        onAuthStateChanged(auth, async (user) => {
            console.log('Auth state changed', user ? 'Admin logged in' : 'No user');
            
            if (user) {
                try {
                    // Check if user is an admin
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    
                    if (!userDoc.exists() || userDoc.data().role !== 'admin') {
                        console.log('User is not an admin, redirecting to user dashboard');
                        window.location.href = 'dashboard.html';
                        return;
                    }
                    
                    // Store admin info
                    currentAdmin = user;
                    adminName = userDoc.data().name || user.email.split('@')[0];
                    document.getElementById('admin-email').textContent = user.email;
                    
                    console.log('Admin verified:', adminName);
                    
                    // Initialize the admin dashboard
                    initializeAdminDashboard();
                    
                } catch (error) {
                    console.error('Error checking admin status:', error);
                    alert('Error verifying admin credentials: ' + error.message);
                    signOut(auth);
                }
            } else {
                console.log('No user logged in, redirecting to login page');
                window.location.href = 'login.html';
            }
        });
        
        // Ensure Transaction Modal Exists
        function ensureModalExists() {
            let modal = document.getElementById('transaction-details-modal');
            if (!modal) {
                console.log('Creating transaction details modal');
                modal = document.createElement('div');
                modal.id = 'transaction-details-modal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <button class="close-modal" id="close-transaction-modal"></button>
                        <h2 class="modal-title">Transaction Details</h2>
                        <div id="transaction-details-content"></div>
                        <div class="form-actions">
                            <button class="btn" id="close-transaction-details">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                console.log('Modal appended to body:', modal.outerHTML);
                
                // Set up close handlers
                setupModalCloseHandlers(modal);
                
                // Add click handler to close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal);
                    }
                });
            }
            return modal;
        }

        // Call it during initialization
        document.addEventListener('DOMContentLoaded', ensureModalExists);
        
        // Initialize Admin Dashboard
        async function initializeAdminDashboard() {
            console.log('Initializing admin dashboard');
            
            try {
                // Load platform settings
                await loadPlatformSettings();
                
                // Load all users
                await loadAllUsers();
                
                // Initialize panels
                initializeOverviewPanel();
                initializeClientsPanel();
                initializeTransactionsPanel();
                initializeSettingsPanel();
                initializeLogsPanel();
                
                console.log('Admin dashboard initialized successfully');
            } catch (error) {
                console.error('Error initializing admin dashboard:', error);
                alert('Error loading dashboard: ' + error.message);
            }
        }
        
        // Load Platform Settings
        async function loadPlatformSettings() {
            console.log('Loading platform settings');
            
            try {
                const settingsDoc = await getDoc(doc(db, 'settings', 'platform'));
                
                if (settingsDoc.exists()) {
                    platformSettings = settingsDoc.data();
                } else {
                    // Create default settings if not exists
                    platformSettings = {
                        requireKycWithdrawal: false,
                        notifyLargeTransactions: false,
                        largeTransactionThreshold: 1000,
                        defaultProfitAmount: 10,
                        defaultProfitInterval: 30,
                        btcAddress: '',
                        nowPaymentsLink: '',
                        simplexLink: 'https://buy.simplex.com'
                    };
                    
                    // Save default settings to Firestore
                    await updateDoc(doc(db, 'settings', 'platform'), platformSettings);
                }
                
                console.log('Platform settings loaded:', platformSettings);
                
                // Update settings UI
                updateSettingsUI();
            } catch (error) {
                console.error('Error loading platform settings:', error);
                platformSettings = {};
            }
        }
        
        // Update Settings UI
        function updateSettingsUI() {
            // Set form values based on loaded settings
            const requireKycCheckbox = document.getElementById('require-kyc-withdrawal');
            const notifyLargeCheckbox = document.getElementById('notify-large-transactions');
            const largeThresholdInput = document.getElementById('large-transaction-threshold');
            const defaultProfitAmountInput = document.getElementById('default-profit-amount');
            const defaultProfitIntervalInput = document.getElementById('default-profit-interval');
            const globalBtcAddressInput = document.getElementById('global-btc-address');
            const globalNowpaymentsInput = document.getElementById('global-nowpayments-link');
            const globalSimplexInput = document.getElementById('global-simplex-link');
            
            if (requireKycCheckbox) {
                requireKycCheckbox.checked = platformSettings.requireKycWithdrawal || false;
            }
            
            if (notifyLargeCheckbox) {
                notifyLargeCheckbox.checked = platformSettings.notifyLargeTransactions || false;
            }
            
            if (largeThresholdInput) {
                largeThresholdInput.value = platformSettings.largeTransactionThreshold || 1000;
            }
            
            if (defaultProfitAmountInput) {
                defaultProfitAmountInput.value = platformSettings.defaultProfitAmount || 10;
            }
            
            if (defaultProfitIntervalInput) {
                defaultProfitIntervalInput.value = platformSettings.defaultProfitInterval || 30;
            }
            
            if (globalBtcAddressInput) {
                globalBtcAddressInput.value = platformSettings.btcAddress || '';
            }
            
            if (globalNowpaymentsInput) {
                globalNowpaymentsInput.value = platformSettings.nowPaymentsLink || '';
            }
            
            if (globalSimplexInput) {
                globalSimplexInput.value = platformSettings.simplexLink || 'https://buy.simplex.com';
            }
        }
        
        // Load All Users
        async function loadAllUsers() {
            console.log('Loading all users');
            
            try {
                // Get all non-admin users
                const usersQuery = query(
                    collection(db, 'users'),
                    where('role', '!=', 'admin')
                );
                
                const querySnapshot = await getDocs(usersQuery);
                allUsers = [];
                
                querySnapshot.forEach((doc) => {
                    allUsers.push({
                        uid: doc.id,
                        ...doc.data()
                    });
                });
                
                console.log(`Loaded ${allUsers.length} users`);
                
                // Update platform stats
                updatePlatformStats();
                
                return allUsers;
            } catch (error) {
                console.error('Error loading users:', error);
                throw error;
            }
        }
        
        // Update Platform Stats
        function updatePlatformStats() {
            const totalUsersElement = document.getElementById('total-users');
            const totalBalanceElement = document.getElementById('total-balance');
            const pendingRequestsElement = document.getElementById('pending-requests');
            
            if (totalUsersElement) {
                totalUsersElement.textContent = allUsers.length;
            }
            
            if (totalBalanceElement) {
                // Calculate total platform balance
                const totalBalance = allUsers.reduce((total, user) => {
                    return total + (user.balance || 0);
                }, 0);
                
                totalBalanceElement.textContent = formatCurrency(totalBalance);
            }
            
            if (pendingRequestsElement) {
                // Count pending requests
                let pendingCount = 0;
                
                allUsers.forEach(user => {
                    if (user.history && Array.isArray(user.history)) {
                        pendingCount += user.history.filter(tx => 
                            tx.type && tx.type.includes('request')
                        ).length;
                    }
                });
                
                pendingRequestsElement.textContent = pendingCount;
            }
        }
        
        // Format Timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Unknown date';
            
            try {
                let date;
                if (timestamp.toDate && typeof timestamp.toDate === 'function') {
                    // Handle Firestore Timestamp
                    date = timestamp.toDate();
                } else if (timestamp.seconds) {
                    // Handle Firestore Timestamp object format
                    date = new Date(timestamp.seconds * 1000);
                } else {
                    // Handle regular Date or timestamp
                    date = new Date(timestamp);
                }
                
                if (isNaN(date.getTime())) {
                    throw new Error('Invalid date');
                }
                
                return date.toLocaleString();
            } catch (error) {
                console.error('Error formatting timestamp:', error, timestamp);
                return 'Invalid date';
            }
        }
        
        // Format Currency
        function formatCurrency(value) {
            if (isNaN(value)) return '$0.00';
            
            return '$' + parseFloat(value).toFixed(2);
        }
        
        // Get Transaction Type Label
        function getTransactionTypeLabel(transaction) {
            const type = transaction.type || '';
            
            if (type.includes('deposit_request')) return 'Deposit Request';
            if (type.includes('deposit_approved')) return 'Deposit';
            if (type.includes('deposit_declined')) return 'Deposit (Declined)';
            if (type.includes('withdrawal_request')) return 'Withdrawal Request';
            if (type.includes('withdrawal_approved')) return 'Withdrawal';
            if (type.includes('withdrawal_declined')) return 'Withdrawal (Declined)';
            if (type === 'auto_profit') return 'Auto Profit';
            
            return 'Transaction';
        }
        
        // Get Transaction Status
        function getTransactionStatus(transaction) {
            const type = transaction.type || '';
            
            if (type.includes('request')) return 'pending';
            if (type.includes('approved') || type === 'auto_profit') return 'completed';
            if (type.includes('declined')) return 'failed';
            
            return 'pending';
        }
        
        // Get Status HTML
        function getStatusHTML(status) {
            switch(status) {
                case 'pending':
                    return '<span class="status pending">Pending</span>';
                case 'completed':
                case 'approved':
                    return '<span class="status completed">Completed</span>';
                case 'failed':
                case 'declined':
                    return '<span class="status failed">Failed</span>';
                default:
                    return '<span class="status pending">Processing</span>';
            }
        }
        
        // Log Admin Action
        async function logAdminAction(action) {
            console.log('Logging admin action:', action);
            
            try {
                const logEntry = {
                    admin: currentAdmin.email,
                    adminUid: currentAdmin.uid,
                    action: action,
                    timestamp: serverTimestamp()
                };
                
                await addDoc(collection(db, 'adminLogs'), logEntry);
                console.log('Admin action logged successfully');
                
                // Refresh logs if on logs panel
                if (document.getElementById('logs').classList.contains('active')) {
                    loadAdminLogs();
                }
            } catch (error) {
                console.error('Error logging admin action:', error);
            }
        }// Initialize Overview Panel
        function initializeOverviewPanel() {
            console.log('Initializing overview panel');
            
            // Load transactions first
            loadRecentTransactions();
            loadPendingRequests();
            
            // Add event listeners after a short delay to ensure DOM is updated
            setTimeout(() => {
                console.log('Setting up overview panel event listeners');
                const recentTransactionsContainer = document.getElementById('recent-transactions');
                const pendingTransactionsContainer = document.getElementById('pending-transactions');
                
                if (recentTransactionsContainer) {
                    console.log('Adding listeners to recent transactions');
                    addTransactionViewEventListeners(recentTransactionsContainer);
                }
                
                if (pendingTransactionsContainer) {
                    console.log('Adding listeners to pending transactions');
                    addTransactionViewEventListeners(pendingTransactionsContainer);
                }
            }, 100);
        }
        
        // Load Recent Transactions
        function loadRecentTransactions() {
            const recentTransactionsContainer = document.getElementById('recent-transactions');
            
            if (!recentTransactionsContainer) {
                console.error('Recent transactions container not found');
                return;
            }
            
            // Collect all transactions from all users
            let allTransactions = [];
            
            allUsers.forEach(user => {
                if (user.history && Array.isArray(user.history)) {
                    const userTransactions = user.history.map(tx => ({
                        ...tx,
                        userUid: user.uid,
                        userEmail: user.email,
                        userName: user.name || user.email.split('@')[0]
                    }));
                    
                    allTransactions = [...allTransactions, ...userTransactions];
                }
            });
            
            // Sort by date (most recent first)
            allTransactions.sort((a, b) => {
                const dateA = a.date && a.date.toMillis ? a.date.toMillis() : (a.date ? new Date(a.date).getTime() : 0);
                const dateB = b.date && b.date.toMillis ? b.date.toMillis() : (b.date ? new Date(b.date).getTime() : 0);
                return dateB - dateA;
            });
            
            // Take only the 5 most recent
            const recentTransactions = allTransactions.slice(0, 5);
            
            if (recentTransactions.length === 0) {
                recentTransactionsContainer.innerHTML = '<div class="no-data">No recent transactions found.</div>';
                return;
            }
            
            // Render transactions
            recentTransactionsContainer.innerHTML = '';
            
            recentTransactions.forEach(transaction => {
                const transactionEl = renderTransactionItem(transaction);
                recentTransactionsContainer.appendChild(transactionEl);
            });
        }
        
        // Load Pending Requests
        function loadPendingRequests() {
            console.log('Loading pending requests');
            
            const pendingTransactionsContainer = document.getElementById('pending-transactions');
            
            if (!pendingTransactionsContainer) {
                console.error('Pending transactions container not found');
                return;
            }
            
            // Collect all pending requests from all users
            let pendingRequests = [];
            
            allUsers.forEach(user => {
                if (user.history && Array.isArray(user.history)) {
                    // Filter for pending requests and add user info
                    const userPendingRequests = user.history
                        .filter(tx => tx.type && tx.type.includes('request'))
                        .map(tx => ({
                            ...tx,
                            userUid: user.uid,
                            userEmail: user.email,
                            userName: user.name || user.email.split('@')[0]
                        }));
                    
                    pendingRequests = [...pendingRequests, ...userPendingRequests];
                }
            });
            
            // Sort by date (most recent first)
            pendingRequests.sort((a, b) => {
                const dateA = a.date && a.date.toMillis ? a.date.toMillis() : (a.date ? new Date(a.date).getTime() : 0);
                const dateB = b.date && b.date.toMillis ? b.date.toMillis() : (b.date ? new Date(b.date).getTime() : 0);
                return dateB - dateA;
            });
            
            if (pendingRequests.length === 0) {
                pendingTransactionsContainer.innerHTML = '<div class="no-data">No pending requests found.</div>';
                return;
            }
            
            // Render pending requests
            pendingTransactionsContainer.innerHTML = '';
            
            pendingRequests.forEach(request => {
                const requestEl = renderTransactionItem(request, true);
                pendingTransactionsContainer.appendChild(requestEl);
            });
        }
        
        // Render Transaction Item
            function renderTransactionItem(transaction, showActions = false) {
            // Remove unnecessary transaction log
            const template = document.createElement('template');
            
            // Store transaction data as a JSON string, properly escaped for HTML
            const transactionData = JSON.stringify(transaction).replace(/"/g, '&quot;');
            
            template.innerHTML = `
                <div class="transaction-item" data-transaction='${transactionData}'>
                    <div class="transaction-info">
                        <div class="transaction-type">${getTransactionTypeLabel(transaction)}</div>
                        <div class="transaction-status">${getStatusHTML(getTransactionStatus(transaction))}</div>
                        <div class="transaction-amount">${formatCurrency(transaction.details?.amount || transaction.amount || 0)}</div>
                        <div class="transaction-date">${formatTimestamp(transaction.date) || 'N/A'}</div>
                        <div class="transaction-user">${transaction.userName || transaction.userEmail || 'Unknown'}</div>
                    </div>
                    <div class="transaction-actions">
                        ${transaction.type && transaction.type.includes('request') 
                            ? `<button class="btn btn-sm approve-transaction" data-transaction='${transactionData}' data-id="${transaction.id || ''}" data-uid="${transaction.userUid || ''}">Approve</button>
                               <button class="btn btn-sm btn-outline decline-transaction" data-transaction='${transactionData}' data-id="${transaction.id || ''}" data-uid="${transaction.userUid || ''}">Decline</button>`
                            : `<button class="btn btn-sm view-transaction" data-transaction='${transactionData}'>View</button>`
                        }
                    </div>
                </div>
            `;
            
            const item = template.content.firstElementChild;
            
            // Add click handler for view button
            const viewButton = item.querySelector('.view-transaction');
            if (viewButton) {
                viewButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    try {
                        const transactionData = JSON.parse(e.currentTarget.getAttribute('data-transaction'));
                        showTransactionDetails(transactionData);
                    } catch (error) {
                        console.error('Error parsing transaction data:', error);
                        alert('Error viewing transaction details');
                            }
                        });
                    }
            
            return item;
        }
        
        // Show Transaction Details
            function showTransactionDetails(transaction) {
            const modal = document.getElementById('transaction-details-modal');
            if (!modal) {
                console.error('Transaction modal not found');
                return;
            }
            
            const content = modal.querySelector('#transaction-details-content');
                if (!content) {
                console.error('Transaction details content element not found');
                    return;
                }
                
                if (!transaction) {
                console.error('No transaction data provided');
                    content.innerHTML = '<p>No transaction data available</p>';
                    return;
                }
                
            try {
                let typeText = getTransactionTypeLabel(transaction);
                let statusText = getStatusHTML(getTransactionStatus(transaction));
                let amount = transaction.details?.amount || transaction.amount || 0;
                let dateStr = formatTimestamp(transaction.date);
                
            content.innerHTML = `
                <div class="transaction-detail-row">
                    <div class="transaction-detail-label">Type</div>
                    <div class="transaction-detail-value">${typeText}</div>
                </div>
                <div class="transaction-detail-row">
                    <div class="transaction-detail-label">Status</div>
                    <div class="transaction-detail-value">${statusText}</div>
                </div>
                <div class="transaction-detail-row">
                    <div class="transaction-detail-label">Amount</div>
                        <div class="transaction-detail-value">${formatCurrency(amount)}</div>
                </div>
                <div class="transaction-detail-row">
                    <div class="transaction-detail-label">Date</div>
                    <div class="transaction-detail-value">${dateStr}</div>
                </div>
                <div class="transaction-detail-row">
                    <div class="transaction-detail-label">User</div>
                    <div class="transaction-detail-value">${transaction.userName || transaction.userEmail || 'Unknown'}</div>
                </div>
            `;
            
            // Add additional details if available
            if (transaction.details) {
                if (transaction.details.method) {
                        content.innerHTML += `
                        <div class="transaction-detail-row">
                            <div class="transaction-detail-label">Payment Method</div>
                            <div class="transaction-detail-value">${transaction.details.method}</div>
                        </div>
                    `;
                }
                if (transaction.details.address) {
                        content.innerHTML += `
                        <div class="transaction-detail-row">
                                <div class="transaction-detail-label">Wallet Address</div>
                            <div class="transaction-detail-value">${transaction.details.address}</div>
                        </div>
                    `;
                }
                if (transaction.details.notes) {
                        content.innerHTML += `
                        <div class="transaction-detail-row">
                            <div class="transaction-detail-label">Notes</div>
                            <div class="transaction-detail-value">${transaction.details.notes}</div>
                        </div>
                    `;
                    }
                }
                
                // Show modal
                modal.style.display = 'flex';
                modal.classList.add('show');
                
                // Ensure close buttons work
                const closeButtons = modal.querySelectorAll('.close-modal, #close-transaction-details');
                closeButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        closeModal(modal);
                    });
                });
                
                // Add click-outside handler
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal);
                    }
                });
                
            } catch (error) {
                console.error('Error displaying transaction details:', error);
                content.innerHTML = '<p>Error displaying transaction details</p>';
            }
        }

        // Update close handlers
        function setupModalCloseHandlers(modal) {
            console.log('Setting up modal close handlers');
            const closeButtons = modal.querySelectorAll('.close-modal, #close-transaction-details');
            closeButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    console.log('Close button clicked');
                    e.preventDefault();
                    e.stopPropagation();
                    closeModal(modal);
                });
            });
        }
        
        // Initialize Clients Panel
        function initializeClientsPanel() {
            console.log('Initializing clients panel');
            
            renderClientList();
            
            // Set up client search
            const searchInput = document.getElementById('client-search');
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    const query = searchInput.value.toLowerCase();
                    filterClients(query);
                });
            }
        }
        
        // Render Client List
        function renderClientList() {
            console.log('Rendering client list');
            
            const clientsContainer = document.getElementById('clients-container');
            
            if (!clientsContainer) {
                console.error('Clients container not found');
                return;
            }
            
            if (allUsers.length === 0) {
                clientsContainer.innerHTML = '<div class="no-data">No clients found.</div>';
                return;
            }
            
            // Sort clients by email
            allUsers.sort((a, b) => {
                return (a.email || '').localeCompare(b.email || '');
            });
            
            // Clear container
            clientsContainer.innerHTML = '';
            
            // Render each client
            allUsers.forEach(user => {
                const clientElement = renderClientItem(user);
                clientsContainer.appendChild(clientElement);
            });
            
            // Attach client event listeners
            attachClientListeners();
        }
        
        // Render Client Item
        function renderClientItem(user) {
            const template = document.getElementById('client-template');
            const clone = document.importNode(template.content, true);
            
            // Replace placeholders in template
            const html = clone.firstElementChild.outerHTML
                .replace(/{uid}/g, user.uid || '')
                .replace(/{name}/g, user.name || 'User')
                .replace(/{email}/g, user.email || '')
                .replace(/{balance}/g, user.balance ? user.balance.toFixed(2) : '0.00')
                .replace(/{level}/g, user.accountLevel || 'Basic')
                .replace(/{accountManager}/g, user.accountManager || '')
                .replace(/{nowPaymentsLink}/g, user.nowPaymentsLink || '')
                .replace(/{btcAddress}/g, user.btcAddress || '');
            
            // Create element from HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const clientElement = tempDiv.firstElementChild;
            
            // Set selected values for dropdowns
            setTimeout(() => {
                // Account level
                const accountLevelSelect = clientElement.querySelector(`#account-level-${user.uid}`);
                if (accountLevelSelect) {
                    accountLevelSelect.value = user.accountLevel || 'Basic';
                }
                
                // Account manager
                const accountManagerInput = clientElement.querySelector(`#account-manager-${user.uid}`);
                if (accountManagerInput) {
                    accountManagerInput.value = user.accountManager || '';
                }
                
                // KYC status
                const kycStatusSelect = clientElement.querySelector(`#kyc-status-${user.uid}`);
                if (kycStatusSelect) {
                    kycStatusSelect.value = user.kycStatus || 'unverified';
                }
                
                // KYC reason
                const kycReasonInput = clientElement.querySelector(`#kyc-reason-${user.uid}`);
                if (kycReasonInput) {
                    kycReasonInput.value = user.kycRejectionReason || '';
                }
                
                // Auto-profit settings
                const autoProfitAmountInput = clientElement.querySelector(`#auto-profit-amount-${user.uid}`);
                if (autoProfitAmountInput) {
                    autoProfitAmountInput.value = user.autoProfitAmount || '';
                }
                
                const autoProfitIntervalInput = clientElement.querySelector(`#auto-profit-interval-${user.uid}`);
                if (autoProfitIntervalInput) {
                    autoProfitIntervalInput.value = user.autoProfitInterval || '';
                }
                
                const autoProfitToggleSelect = clientElement.querySelector(`#auto-profit-toggle-${user.uid}`);
                if (autoProfitToggleSelect) {
                    autoProfitToggleSelect.value = user.autoProfitEnabled ? 'enabled' : 'disabled';
                }
                
                // Display KYC image if available
                if (user.kycPhotoBase64) {
                    const kycPreviewContainer = clientElement.querySelector(`#kyc-preview-container-${user.uid}`);
                    if (kycPreviewContainer) {
                        kycPreviewContainer.innerHTML = `
                            <div class="kyc-preview">
                                <img src="${user.kycPhotoBase64}" alt="KYC Document" style="max-width: 100%;">
                            </div>
                        `;
                    }
                }
                
                // Load client transactions
                loadClientTransactions(user.uid);
                
                // Load client chat messages
                loadClientChat(user.uid);
            }, 0);
            
            return clientElement;
        }
        
        // Filter Clients
        function filterClients(query) {
            const clientItems = document.querySelectorAll('.client-item');
            
            clientItems.forEach(item => {
                const name = item.querySelector('.client-name').textContent.toLowerCase();
                const email = item.querySelector('.client-email').textContent.toLowerCase();
                
                if (name.includes(query) || email.includes(query)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // Attach Client Listeners
        function attachClientListeners() {
            console.log('Attaching client listeners');
            
            // Client header toggle
            const clientHeaders = document.querySelectorAll('.client-header');
            clientHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const clientItem = header.closest('.client-item');
                    const clientDetails = clientItem.querySelector('.client-details');
                    clientDetails.classList.toggle('active');
                });
            });
            
            // Update Account button
            const updateAccountBtns = document.querySelectorAll('.update-account');
            updateAccountBtns.forEach(btn => {
                btn.addEventListener('click', handleUpdateAccount);
            });
            
            // Update KYC button
            const updateKycBtns = document.querySelectorAll('.update-kyc');
            updateKycBtns.forEach(btn => {
                btn.addEventListener('click', handleUpdateKyc);
            });
            
            // Update Auto-Profit button
            const updateAutoProfitBtns = document.querySelectorAll('.update-auto-profit');
            updateAutoProfitBtns.forEach(btn => {
                btn.addEventListener('click', handleUpdateAutoProfit);
            });
            
            // Add Warning button
            const addWarningBtns = document.querySelectorAll('.add-warning');
            addWarningBtns.forEach(btn => {
                btn.addEventListener('click', handleAddWarning);
            });

            // Warning visibility toggle
            const warningToggles = document.querySelectorAll('.show-warnings-toggle');
            warningToggles.forEach(toggle => {
                // Set initial state
                const uid = toggle.getAttribute('data-uid');
                const userIndex = allUsers.findIndex(u => u.uid === uid);
                if (userIndex !== -1) {
                    toggle.checked = allUsers[userIndex].showWarnings !== false;
                }
                // Add change listener
                toggle.addEventListener('change', handleWarningToggle);
            });
            
            // Send Message button
            const sendMessageBtns = document.querySelectorAll('.send-message');
            sendMessageBtns.forEach(btn => {
                btn.addEventListener('click', handleSendMessage);
            });
            
            // Update Payment Methods button
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citron Trades - Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            /* Dark theme variables */
            --bg-dark: #161625;
            --bg-card: #1A1A2E;
            --color-primary: #3B82F6;
            --color-primary-hover: #2563EB;
            --color-text: #ffffff;
            --color-text-secondary: #a0a0b8;
            --color-border: #2a2a3d;
            --color-positive: #40B467;  /* Keep green for profits */
            --color-negative: #e74c3c;  /* Keep red for losses */
            --color-warning: #f39c12;
            --color-info: #3498db;
        }

        /* Light theme variables */
        :root[data-theme="light"] {
            --bg-dark: #f8f9fa;
            --bg-card: #ffffff;
            --color-text: #2d3436;
            --color-text-secondary: #636e72;
            --color-border: #dfe6e9;
            --color-primary: #3B82F6;
            --color-primary-hover: #2563EB;
            --color-positive: #40B467;  /* Keep green for profits */
            --color-negative: #e74c3c;  /* Keep red for losses */
            --color-warning: #f39c12;
            --color-info: #3498db;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--color-text);
            min-height: 100vh;
            line-height: 1.5;
        }
        .dashboard {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 260px;
            background: var(--bg-dark);
            padding: 1.5rem 1rem;
            border-right: 1px solid var(--color-border);
            transition: transform 0.3s ease;
            position: fixed;
            height: 100%;
            z-index: 1000;
            overflow-y: auto;
        }
        .sidebar.hidden { transform: translateX(-260px); }
        .logo-container {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            padding-left: 0.5rem;
        }
        .logo {
            height: 32px;
            margin-right: 0.75rem;
        }
        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .nav-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin: 1.5rem 0 0.5rem 0.5rem;
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin: 0.25rem 0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            color: var(--color-text-secondary);
        }
        .nav-item svg {
            margin-right: 0.75rem;
        }
        .nav-item:hover {
            background: rgba(64, 180, 103, 0.1);
            color: var(--color-text);
        }
        .nav-item.active {
            background: rgba(64, 180, 103, 0.15);
            color: var(--color-primary);
        }
        .main {
            flex: 1;
            padding: 1.5rem;
            margin-left: 260px;
            transition: margin-left 0.3s ease;
        }
        .main.full { margin-left: 0; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--color-border);
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .toggle-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--color-text);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
        }
        .panel {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .panel.active {
            display: block;
            opacity: 1;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Admin-specific styles */
        .admin-badge {
            background: var(--color-primary);
            color: #fff;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }
        .admin-info {
            display: flex;
            align-items: center;
            color: var(--color-text);
            font-weight: 500;
        }

        /* Theme toggle button styles */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: none;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            cursor: pointer;
            margin-right: 1rem;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: rgba(64, 180, 103, 0.1);
        }

        .theme-toggle svg {
            width: 18px;
            height: 18px;
        }
    </style>
    <style>
        /* Admin dashboard specific components */
        .section {
            margin-bottom: 2rem;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-text);
        }
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--color-border);
            overflow: hidden;
            margin-bottom: 1.5rem;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--color-border);
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .card-content {
            padding: 1.25rem;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 1.25rem;
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: -0.5rem;
        }
        .form-col {
            flex: 1;
            padding: 0.5rem;
            min-width: 200px;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
        }
        input, select, textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            font-size: 0.95rem;
            transition: border-color 0.2s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--color-primary);
        }
        .input-hint {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            margin-top: 0.25rem;
        }
        
        /* Button styles */
        .btn, button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.65rem 1.25rem;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn:hover, button:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
        }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--color-primary);
            color: var(--color-primary);
        }
        .btn-outline:hover {
            background: rgba(64, 180, 103, 0.1);
        }
        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }
        .btn-warning {
            background-color: var(--color-warning);
        }
        .btn-warning:hover {
            background-color: #d68c10;
        }
        .btn-danger {
            background-color: var(--color-negative);
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .btn-group {
            display: flex;
            gap: 0.5rem;
        }
        
        /* Status badges */
        .status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .status.pending {
            background: rgba(243, 156, 18, 0.15);
            color: #f39c12;
        }
        .status.completed, .status.approved {
            background: rgba(64, 180, 103, 0.15);
            color: var(--color-positive);
        }
        .status.failed, .status.declined {
            background: rgba(231, 76, 60, 0.15);
            color: var(--color-negative);
        }
        
        /* Client management styles */
        .clients-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .client-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            overflow: hidden;
        }
        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .client-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .client-name {
            font-weight: 500;
        }
        .client-email {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }
        .client-balance {
            font-weight: 600;
            color: var(--color-primary);
        }
        .client-details {
            padding: 1rem;
            border-top: 1px solid var(--color-border);
            display: none;
        }
        .client-details.active {
            display: block;
        }
        .client-actions {
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .action-group {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .action-group-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--color-text);
        }
        
        /* Transaction management styles */
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--color-border);
        }
        .transaction-item:last-child {
            border-bottom: none;
        }
        .transaction-details {
            flex: 1;
        }
        .transaction-type {
            font-weight: 500;
        }
        .transaction-amount {
            font-weight: 600;
            color: var(--color-primary);
        }
        .transaction-date {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }
        .transaction-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        /* Admin log styles */
        .admin-log-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            padding: 0.75rem;
            border-bottom: 1px solid var(--color-border);
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-timestamp {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            margin-bottom: 0.25rem;
        }
        .log-message {
            color: var(--color-text);
        }
        .log-admin {
            font-weight: 500;
            color: var(--color-primary);
        }
        
        /* Payment methods and settings styles */
        .payment-methods-group {
            background: rgba(64, 180, 103, 0.05);
            border: 1px solid rgba(64, 180, 103, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        .payment-method-field {
            margin-bottom: 0.75rem;
        }
        .payment-method-field:last-child {
            margin-bottom: 0;
        }
        .input-group {
            display: flex;
            align-items: center;
        }
        .input-group input {
            flex: 1;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        .input-group button {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
        
        /* Settings section */
        .settings-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        .setting-card {
            background: var(--bg-card);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 1rem;
        }
        .setting-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .setting-description {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            margin-bottom: 1rem;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: auto;
            visibility: hidden;
        }

        .modal.show {
            opacity: 1;
            display: flex !important;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            position: relative;
            color: var(--color-text);
            border: 1px solid var(--color-border);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(0);
            transition: transform 0.3s ease-in-out;
            pointer-events: auto;
            z-index: 10000;
        }

        .transaction-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            border-bottom: 1px solid var(--color-border);
        }

        .transaction-detail-row:last-child {
            border-bottom: none;
        }

        .transaction-detail-label {
            font-weight: 500;
            color: var(--color-text-secondary);
        }

        .transaction-detail-value {
            color: var(--color-text);
            text-align: right;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--color-text-secondary);
            padding: 0.5rem;
            line-height: 1;
            transition: color 0.2s ease-in-out;
            z-index: 10001;
            pointer-events: auto;
        }

        .close-modal:hover {
            color: var(--color-text);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-right: 2rem;
            color: var(--color-text);
        }

        #transaction-details-content {
            margin: 1rem 0;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .form-actions {
            margin-top: 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        .form-actions .btn {
            min-width: 100px;
            pointer-events: auto;
        }
        
        /* Ensure modal is above all other content */
        .modal, .modal-content {
            z-index: 9999;
        }
        
        /* Ensure buttons are clickable */
        .btn {
            pointer-events: auto;
            cursor: pointer;
            position: relative;
            z-index: 1;
        }
        
        /* Responsive styles */
        @media (max-width: 1024px) {
            .main {
                margin-left: 0;
            }
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.visible {
                transform: translateX(0);
            }
        }
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
                padding: 1rem 0;
                position: relative;
            }
            .header-left {
                width: 100%;
                flex-direction: row;
                align-items: center;
                justify-content: flex-start;
                gap: 1rem;
            }
            .mobile-brand {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                position: relative;
                padding: 0 3.5rem;
            }
            .logo {
                height: 32px;
                width: auto;
            }
            .logo-text {
                display: none; /* Hide the text */
            }
            .header-title {
                display: none; /* Hide panel titles on mobile */
            }
            .toggle-btn {
                position: absolute;
                top: 1rem;
                left: 1rem;
                z-index: 10;
            }
            .theme-toggle {
                position: absolute;
                top: 1rem;
                right: 1rem;
                z-index: 10;
                margin-right: 0;
            }
            .admin-info {
                width: 100%;
                flex-direction: column;
                align-items: center;
                text-align: center;
                gap: 0.25rem;
                margin-top: 0.5rem;
            }
            .form-row {
                flex-direction: column;
            }
            .client-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
    <style>
        /* Mobile Responsive Styles */
        @media (max-width: 1024px) {
            .main {
                margin-left: 0;
                padding: 1rem;
            }
            .sidebar {
                transform: translateX(-100%);
                z-index: 1000;
                background: var(--bg-dark);
                box-shadow: 2px 0 8px rgba(0, 0, 0, 0.2);
                transition: transform 0.3s ease;
            }
            .sidebar.visible {
                transform: translateX(0);
            }
            .logo-container {
                padding: 1rem;
                margin-bottom: 1.5rem;
                border-bottom: 1px solid var(--color-border);
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            .logo-container .mobile-close {
                display: block;
                padding: 0.5rem;
                cursor: pointer;
                color: var(--color-text-secondary);
            }
            .mobile-header {
                display: flex;
                align-items: center;
                gap: 1rem;
                margin-bottom: 1rem;
            }
            .mobile-logo {
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: var(--color-primary);
                border-radius: 8px;
                color: white;
                font-weight: bold;
                font-size: 1.2rem;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
                padding: 1rem 0;
                position: relative;
            }
            .header-left {
                width: 100%;
                flex-direction: column;
                align-items: flex-start;
            }
            .mobile-brand {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                position: absolute;
                top: 1rem;
                left: 50%;
                transform: translateX(-50%);
                padding: 0 3.5rem;
            }
            .mobile-brand .logo {
                height: 32px;
                width: 32px;
                background: var(--color-primary);
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                font-size: 1.1rem;
                margin-right: 0;
            }
            .mobile-brand .logo-text {
                font-size: 1.2rem;
                font-weight: 600;
                color: var(--color-text);
                white-space: nowrap;
                margin-left: 0;
            }
            .toggle-btn {
                position: absolute;
                top: 1rem;
                left: 1rem;
                z-index: 10;
            }
            .theme-toggle {
                position: absolute;
                top: 1rem;
                right: 1rem;
                z-index: 10;
                margin-right: 0;
            }
            .admin-info {
                width: 100%;
                flex-direction: column;
                align-items: center;
                text-align: center;
                gap: 0.25rem;
                margin-top: 4rem;
            }
            .admin-badge {
                margin-left: 0;
                margin-top: 0.25rem;
            }
            .mobile-header {
                display: none;
            }

            /* Card and form adjustments */
            .form-row {
                flex-direction: column;
            }
            .form-col {
                width: 100%;
                min-width: 100%;
            }
            .card {
                margin: 0 -1rem;
                border-radius: 0;
            }
            .card-content {
                padding: 1rem;
            }
            
            /* Stats grid adjustments */
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            .stat-card {
                padding: 1rem;
            }

            /* Table adjustments */
            .table-container {
                margin: 0 -1rem;
                width: calc(100% + 2rem);
                overflow-x: auto;
            }
            .table {
                font-size: 0.85rem;
            }
            .table th,
            .table td {
                padding: 0.75rem;
                white-space: nowrap;
            }

            /* Client management adjustments */
            .client-item {
                padding: 1rem;
            }
            .client-header {
                flex-direction: column;
                gap: 0.5rem;
            }
            .client-actions {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            .client-actions .btn {
                width: 100%;
            }

            /* Modal adjustments */
            .modal-content {
                width: 95%;
                margin: 1rem;
                max-height: 90vh;
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .header-title {
                font-size: 1.25rem;
            }
            .section-title {
                font-size: 1.1rem;
            }
            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
            .table th:nth-child(4),
            .table td:nth-child(4) {
                display: none;
            }
            .client-details {
                padding: 0.75rem;
            }
            .action-group {
                padding: 0.75rem;
            }
        }

        /* Hide mobile elements on desktop */
        .mobile-close,
        .mobile-header,
        .mobile-brand {
            display: none;
        }

        /* Show mobile brand only on mobile */
        @media (max-width: 768px) {
            .mobile-brand {
                display: flex;
            }
        }
    </style>
</head><body>
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="logo-container">
                <img src="https://gistcdn.githack.com/Zealsharon986/065de595e0ffdfa2d7cf23881e1e23d3/raw/b1b64e7237340a6aae8bb39f69dc2298a521dc10/logo.svg" alt="Citron Trades" class="logo">
            </div>
            
            <div class="nav-label">Dashboard</div>
            <div class="nav-item active" data-panel="overview">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></svg>
                Overview
            </div>
            <div class="nav-item" data-panel="clients">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                Clients
            </div>
            <div class="nav-item" data-panel="transactions">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                Transactions
            </div>
            
            <div class="nav-label">Administration</div>
            <div class="nav-item" data-panel="settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                Settings
            </div>
            <div class="nav-item" data-panel="logs">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                Admin Logs
            </div>
        </div>

        <!-- Main Content -->
        <div class="main" id="main">
            <!-- Add mobile header -->
            <div class="mobile-header">
                <div class="mobile-logo">C</div>
                <h1 class="header-title">Citron Trades</h1>
            </div>
            <div class="header">
                <div class="header-left">
                    <button class="toggle-btn" id="toggle-sidebar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </button>
                    <!-- Add mobile brand section -->
                    <div class="mobile-brand">
                        <img src="https://gistcdn.githack.com/Zealsharon986/065de595e0ffdfa2d7cf23881e1e23d3/raw/b1b64e7237340a6aae8bb39f69dc2298a521dc10/logo.svg" alt="Citron Trades" class="logo">
                    </div>
                    <h1 class="header-title" id="panel-title">Overview</h1>
                </div>
                <div class="admin-info">
                    <button class="theme-toggle" id="theme-toggle" title="Toggle theme">
                        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </button>
                    <span id="admin-email">admin@citrontrades.com</span>
                    <span class="admin-badge">Admin</span>
                </div>
                <button id="logout-btn" class="btn btn-outline">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    Logout
                </button>
            </div><!-- Overview Panel -->
            <div class="panel active" id="overview">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Platform Overview</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Platform Statistics</h3>
                        </div>
                        <div class="card-content">
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="stat-card">
                                        <div class="stat-card-header">
                                            <h3>Total Users</h3>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                                        </div>
                                        <div class="stat-card-value" id="total-users">0</div>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="stat-card">
                                        <div class="stat-card-header">
                                            <h3>Platform Balance</h3>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                                        </div>
                                        <div class="stat-card-value" id="total-balance">$0.00</div>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="stat-card">
                                        <div class="stat-card-header">
                                            <h3>Pending Requests</h3>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-warning"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                        </div>
                                        <div class="stat-card-value" id="pending-requests">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Recent Transactions</h2>
                        <a href="#" class="view-all" id="view-all-transactions">View All</a>
                    </div>
                    
                    <div class="card">
                        <div class="card-content">
                            <div id="recent-transactions">
                                <!-- Will be populated by JavaScript -->
                                <div class="no-data">Loading transactions...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Pending Requests</h2>
                        <a href="#" class="view-all" id="view-all-requests">View All</a>
                    </div>
                    
                    <div class="card">
                        <div class="card-content">
                            <div id="pending-transactions">
                                <!-- Will be populated by JavaScript -->
                                <div class="no-data">Loading pending requests...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Clients Panel -->
            <div class="panel" id="clients">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Client Management</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">All Clients</h3>
                            <div class="search-container">
                                <input type="text" id="client-search" placeholder="Search clients..." class="search-input">
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="clients-container" id="clients-container">
                                <!-- Will be populated by JavaScript -->
                                <div class="no-data">Loading clients...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- Transactions Panel -->
            <div class="panel" id="transactions">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Transaction Management</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">All Transactions</h3>
                            <div class="transaction-filters">
                                <select id="transaction-type-filter" class="styled-select">
                                    <option value="all">All Types</option>
                                    <option value="deposit">Deposits</option>
                                    <option value="withdrawal">Withdrawals</option>
                                    <option value="auto_profit">Auto Profit</option>
                                </select>
                                <select id="transaction-status-filter" class="styled-select">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="completed">Completed</option>
                                    <option value="failed">Failed</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-content">
                            <div id="all-transactions">
                                <!-- Will be populated by JavaScript -->
                                <div class="no-data">Loading transactions...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Panel -->
            <div class="panel" id="settings">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Platform Settings</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Payment Methods</h3>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label for="global-btc-address">Default Bitcoin Address</label>
                                <div class="input-group">
                                    <input type="text" id="global-btc-address" placeholder="e.g., bc1q...">
                                    <button id="save-btc-address" class="btn">Save</button>
                                </div>
                                <div class="input-hint">This address will be used for all users' Bitcoin deposits unless overridden.</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="global-nowpayments-link">Default NOWPayments Link</label>
                                <div class="input-group">
                                    <input type="text" id="global-nowpayments-link" placeholder="e.g., https://nowpayments.io/...">
                                    <button id="save-nowpayments-link" class="btn">Save</button>
                                </div>
                                <div class="input-hint">This link will be used for all users' crypto payments unless overridden.</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="global-simplex-link">Default Simplex Link</label>
                                <div class="input-group">
                                    <input type="text" id="global-simplex-link" placeholder="e.g., https://buy.simplex.com/...">
                                    <button id="save-simplex-link" class="btn">Save</button>
                                </div>
                                <div class="input-hint">This link will be used for all users' card payments.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Auto-Profit Settings</h3>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label for="default-profit-amount">Default Profit Amount ($)</label>
                                <div class="input-group">
                                    <input type="number" id="default-profit-amount" placeholder="e.g., 10" min="1" step="0.01">
                                    <button id="save-profit-amount" class="btn">Save</button>
                                </div>
                                <div class="input-hint">Default amount for auto-profit feature for new users.</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="default-profit-interval">Default Profit Interval (minutes)</label>
                                <div class="input-group">
                                    <input type="number" id="default-profit-interval" placeholder="e.g., 30" min="10" step="1">
                                    <button id="save-profit-interval" class="btn">Save</button>
                                </div>
                                <div class="input-hint">Default interval for auto-profit feature for new users (min: 10 minutes).</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Security Settings</h3>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="require-kyc-withdrawal">
                                    Require KYC for withdrawals
                                </label>
                                <div class="input-hint">If enabled, users must complete KYC verification before making withdrawals.</div>
                            </div>
                            
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="notify-large-transactions">
                                    Notify on large transactions
                                </label>
                                <div class="input-hint">Send admin notification for transactions above threshold.</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="large-transaction-threshold">Large Transaction Threshold ($)</label>
                                <input type="number" id="large-transaction-threshold" placeholder="e.g., 1000" min="100" step="10">
                            </div>
                            
                            <button id="save-security-settings" class="btn">Save Security Settings</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Logs Panel -->
            <div class="panel" id="logs">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Admin Activity Logs</h2>
                        <button id="refresh-logs" class="btn btn-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 2v6h6M21.5 22v-6h-6"></path><path d="M22 11.5A10 10 0 0 0 3.2 7.2M2 12.5a10 10 0 0 0 18.8 4.2"></path></svg>
                            Refresh
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Recent Activity</h3>
                        </div>
                        <div class="card-content">
                            <div class="admin-log-container" id="admin-logs">
                                <!-- Will be populated by JavaScript -->
                                <div class="no-data">Loading admin logs...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div></div>
    </div>
    
    <!-- Client Template (Hidden) -->
    <template id="client-template">
        <div class="client-item" data-uid="{uid}">
            <div class="client-header">
                <div>
                    <div class="client-name">{name}</div>
                    <div class="client-email">{email}</div>
                </div>
                <div>
                    <div class="client-balance">${balance}</div>
                    <div class="client-level">Level: {level}</div>
                </div>
            </div>
            <div class="client-details">
                <div class="action-group">
                    <div class="action-group-title">Account Information</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="account-level-{uid}">Account Level</label>
                                <select id="account-level-{uid}" class="account-level-select" data-uid="{uid}">
                                    <option value="Basic">Basic</option>
                                    <option value="Pro">Pro</option>
                                    <option value="Elite">Elite</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="balance-{uid}">Balance ($)</label>
                                <input type="number" id="balance-{uid}" class="balance-input" data-uid="{uid}" value="{balance}" step="0.01">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="account-manager-{uid}">Account Manager</label>
                                <input type="text" id="account-manager-{uid}" class="account-manager-input" data-uid="{uid}" value="{accountManager}" placeholder="Enter account manager name">
                            </div>
                        </div>
                    </div>
                    
                    <div class="client-actions">
                        <button class="btn update-account" data-uid="{uid}">Update Account</button>
                    </div>
                </div>
                
                <div class="action-group">
                    <div class="action-group-title">Warning Management</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="warning-message-{uid}">Warning Message</label>
                                <textarea id="warning-message-{uid}" class="warning-message-input" data-uid="{uid}" placeholder="Enter warning message"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="toggle-label">
                                    <input type="checkbox" id="show-warnings-{uid}" class="show-warnings-toggle" data-uid="{uid}">
                                    Show warnings to user
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="client-actions">
                        <button class="btn btn-warning add-warning" data-uid="{uid}">Add Warning</button>
                    </div>
                </div>
                
                <div class="action-group">
                    <div class="action-group-title">KYC Verification</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="kyc-status-{uid}">KYC Status</label>
                                <select id="kyc-status-{uid}" class="kyc-status-select" data-uid="{uid}">
                                    <option value="unverified">Unverified</option>
                                    <option value="pending">Pending</option>
                                    <option value="verified">Verified</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="kyc-reason-{uid}">Rejection Reason (if applicable)</label>
                                <input type="text" id="kyc-reason-{uid}" class="kyc-reason-input" data-uid="{uid}" placeholder="Reason for rejection">
                            </div>
                        </div>
                    </div>
                    
                    <div id="kyc-preview-container-{uid}" class="kyc-preview-container">
                        <!-- KYC image will be shown here if available -->
                    </div>
                    
                    <div class="client-actions">
                        <button class="btn update-kyc" data-uid="{uid}">Update KYC Status</button>
                    </div>
                </div>
                
                <div class="action-group">
                    <div class="action-group-title">Auto-Profit Settings</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="auto-profit-amount-{uid}">Profit Amount ($)</label>
                                <input type="number" id="auto-profit-amount-{uid}" class="auto-profit-amount-input" data-uid="{uid}" min="1" step="0.01">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="auto-profit-interval-{uid}">Interval (minutes)</label>
                                <input type="number" id="auto-profit-interval-{uid}" class="auto-profit-interval-input" data-uid="{uid}" min="10" step="1">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="auto-profit-toggle-{uid}">Status</label>
                                <select id="auto-profit-toggle-{uid}" class="auto-profit-toggle-select" data-uid="{uid}">
                                    <option value="enabled">Enabled</option>
                                    <option value="disabled">Disabled</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="auto-trade-block-{uid}">Block Auto-Trade</label>
                                <select id="auto-trade-block-{uid}" class="auto-trade-block-select" data-uid="{uid}">
                                    <option value="unblocked">Unblocked</option>
                                    <option value="blocked">Blocked</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="client-actions">
                        <button class="btn update-auto-profit" data-uid="{uid}">Update Auto-Trade</button>
                    </div>
                </div>
                
                <!-- New Payment Methods Section -->
                <div class="action-group payment-methods-group">
                    <div class="action-group-title">Payment Methods</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group payment-method-field">
                                <label for="nowpayments-link-{uid}">NOWPayments Link</label>
                                <input type="text" id="nowpayments-link-{uid}" class="nowpayments-input" data-uid="{uid}" value="{nowPaymentsLink}" placeholder="e.g., https://nowpayments.io/...">
                                <div class="input-hint">For user's 'Pay With Crypto' button</div>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group payment-method-field">
                                <label for="btc-address-{uid}">BTC Address</label>
                                <input type="text" id="btc-address-{uid}" class="btc-address-input" data-uid="{uid}" value="{btcAddress}" placeholder="e.g., bc1q...">
                                <div class="input-hint">For user's crypto deposits</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="client-actions">
                        <button class="btn update-payment-methods" data-uid="{uid}">Update Payment Methods</button>
                    </div>
                </div>
                
                <div class="action-group">
                    <div class="action-group-title">Withdrawal Settings</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="withdrawal-code-{uid}">Withdrawal Code</label>
                                <div class="input-group">
                                    <input type="text" id="withdrawal-code-{uid}" class="withdrawal-code-input" data-uid="{uid}" maxlength="6" placeholder="Enter 6-digit code">
                                    <button class="btn update-withdrawal-code" data-uid="{uid}">Set Code</button>
                                </div>
                                <div class="input-hint">Set a 6-digit code required for withdrawals</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="action-group">
                    <div class="action-group-title">Recent Transactions</div>
                    <div class="client-transactions" id="client-transactions-{uid}">
                        <div class="no-data">Loading transactions...</div>
                    </div>
                </div>
                
                <div class="action-group">
                    <div class="action-group-title">Support Chat</div>
                    <div class="client-chat" id="client-chat-{uid}">
                        <div class="form-group">
                            <textarea id="chat-message-{uid}" class="chat-message-input" data-uid="{uid}" placeholder="Type your message..."></textarea>
                        </div>
                        <div class="client-actions">
                            <button class="btn send-message" data-uid="{uid}">Send Message</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Transaction Template (Hidden) -->
    <template id="transaction-template">
        <div class="transaction-item" data-id="{id}">
            <div class="transaction-details">
                <div class="transaction-type">{type}</div>
                <div class="transaction-info">
                    <span class="transaction-amount">{amount}</span>
                    <span class="transaction-status">{status}</span>
                </div>
                <div class="transaction-date">{date}</div>
                <div class="transaction-user">User: {user}</div>
            </div>
            <div class="transaction-actions">
                {buttons}
            </div>
        </div>
    </template>
    
    <!-- Log Entry Template (Hidden) -->
    <template id="log-entry-template">
        <div class="log-entry">
            <div class="log-timestamp">{timestamp}</div>
            <div class="log-message">
                <span class="log-admin">{admin}</span> {action}
            </div>
        </div>
    </template>
    
    <!-- Client Transaction Template (Hidden) -->
    <template id="client-transaction-template">
        <div class="transaction-item client-transaction" data-id="{id}">
            <div class="transaction-details">
                <div class="transaction-type">{type}</div>
                <div class="transaction-info">
                    <span class="transaction-amount">{amount}</span>
                    <span class="transaction-status">{status}</span>
                </div>
                <div class="transaction-date">{date}</div>
            </div>
            <div class="transaction-actions">
                {buttons}
            </div>
        </div>
    </template>
    
    <!-- Add Warning Modal -->
    <div class="modal" id="warning-modal">
        <div class="modal-content">
            <button class="close-modal" id="close-warning-modal"></button>
            <h2 class="modal-title">Add Warning</h2>
            <p class="modal-desc">This warning will be displayed to the user on their dashboard.</p>
            
            <div class="form-group">
                <label for="warning-message">Warning Message</label>
                <textarea id="warning-message" placeholder="Enter warning message" rows="4"></textarea>
            </div>
            
            <input type="hidden" id="warning-user-id">
            
            <div class="form-actions">
                <button class="btn btn-outline" id="cancel-warning">Cancel</button>
                <button class="btn btn-warning" id="submit-warning">Add Warning</button>
            </div>
        </div>
    </div>
    
    <!-- Transaction Details Modal -->
    <div class="modal" id="transaction-details-modal">
        <div class="modal-content">
            <button class="close-modal" id="close-transaction-modal"></button>
            <h2 class="modal-title">Transaction Details</h2>
            
            <div id="transaction-details-content">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <div class="form-actions">
                <button class="btn" id="close-transaction-details">Close</button>
            </div>
        </div>
    </div><!-- Core Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            getDocs, 
            updateDoc, 
            addDoc, 
            arrayUnion, 
            query, 
            where, 
            orderBy, 
            Timestamp, 
            onSnapshot,
            serverTimestamp,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAEPH6zPhhmyrAL8YPKzJWZZVOT8LScpIg",
            authDomain: "invest-mgnt.firebaseapp.com",
            projectId: "invest-mgnt",
            storageBucket: "invest-mgnt.firebasestorage.app",
            messagingSenderId: "658245081425",
            appId: "1:658245081425:web:73eeaa2614e426030c1b70",
            measurementId: "G-F03JXGD2ZT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Global variables
        let currentAdmin = null;
        let allUsers = [];
        let adminName = 'Admin';
        let platformSettings = {};
        
        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const main = document.getElementById('main');
        const navItems = document.querySelectorAll('.nav-item');
        const logoutBtn = document.getElementById('logout-btn');
        const toggleSidebarBtn = document.getElementById('toggle-sidebar');
        
        // Wait for DOM to be loaded before setting up event listeners
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, setting up event listeners');
            setupNavigation();
            setupLogout();
            setupModals();
        });
        
        // Setup Navigation
        function setupNavigation() {
            // Toggle sidebar
            const toggleSidebarBtn = document.getElementById('toggle-sidebar');
            const closeSidebarBtn = document.getElementById('close-sidebar');
            const sidebar = document.getElementById('sidebar');
            const main = document.getElementById('main');
            
            toggleSidebarBtn.addEventListener('click', () => {
                console.log('Toggle sidebar clicked');
                if (window.innerWidth <= 1024) {
                    sidebar.classList.toggle('visible');
                } else {
                    sidebar.classList.toggle('hidden');
                    main.classList.toggle('full');
                }
            });

            // Close sidebar on mobile
            if (closeSidebarBtn) {
                closeSidebarBtn.addEventListener('click', () => {
                    sidebar.classList.remove('visible');
                });
            }

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 1024 && 
                    !sidebar.contains(e.target) && 
                    !toggleSidebarBtn.contains(e.target) &&
                    sidebar.classList.contains('visible')) {
                    sidebar.classList.remove('visible');
                }
            });

            // Close sidebar when clicking nav items on mobile
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    if (window.innerWidth <= 1024) {
                        sidebar.classList.remove('visible');
                    }
                });
            });
            
            // Panel switching
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const panelId = item.getAttribute('data-panel');
                    console.log(`Nav item clicked: ${panelId}`);
                    
                    // Remove active class from all nav items
                    navItems.forEach(nav => nav.classList.remove('active'));
                    
                    // Add active class to clicked nav item
                    item.classList.add('active');
                    
                    // Hide all panels
                    const panels = document.querySelectorAll('.panel');
                    panels.forEach(panel => panel.classList.remove('active'));
                    
                    // Show selected panel
                    const panel = document.getElementById(panelId);
                    if (panel) {
                        panel.classList.add('active');
                        document.getElementById('panel-title').textContent = panelId.charAt(0).toUpperCase() + panelId.slice(1);
                        console.log(`Panel ${panelId} activated`);
                    } else {
                        console.error(`Panel with ID ${panelId} not found`);
                    }
                });
            });
        }
        
        // Setup Logout Button
        function setupLogout() {
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Logout button clicked');
                    
                    signOut(auth)
                        .then(() => {
                            console.log('Admin signed out successfully');
                            window.location.href = 'login.html';
                        })
                        .catch((error) => {
                            console.error('Error signing out:', error);
                            alert('Error signing out: ' + error.message);
                        });
                });
            } else {
                console.error('Logout button not found in DOM');
            }
        }
        
        // Setup Modals
        function setupModals() {
            // Transaction Modal
            const transactionModal = document.getElementById('transaction-modal');
            const closeTransactionModal = document.getElementById('close-transaction-modal');
            const closeTransactionDetails = document.getElementById('close-transaction-details');
            
            if (transactionModal) {
                closeTransactionModal.addEventListener('click', () => {
                    transactionModal.style.display = 'none';
                });
                
                closeTransactionDetails.addEventListener('click', () => {
                    transactionModal.style.display = 'none';
                });
            }
        }
        
        // Authentication Check
        onAuthStateChanged(auth, async (user) => {
            console.log('Auth state changed', user ? 'Admin logged in' : 'No user');
            
            if (user) {
                try {
                    // Check if user is an admin
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    
                    if (!userDoc.exists() || userDoc.data().role !== 'admin') {
                        console.log('User is not an admin, redirecting to user dashboard');
                        window.location.href = 'dashboard.html';
                        return;
                    }
                    
                    // Store admin info
                    currentAdmin = user;
                    adminName = userDoc.data().name || user.email.split('@')[0];
                    document.getElementById('admin-email').textContent = user.email;
                    
                    console.log('Admin verified:', adminName);
                    
                    // Initialize the admin dashboard
                    initializeAdminDashboard();
                    
                } catch (error) {
                    console.error('Error checking admin status:', error);
                    alert('Error verifying admin credentials: ' + error.message);
                    signOut(auth);
                }
            } else {
                console.log('No user logged in, redirecting to login page');
                window.location.href = 'login.html';
            }
        });
        
        // Ensure Transaction Modal Exists
        function ensureModalExists() {
            let modal = document.getElementById('transaction-details-modal');
            if (!modal) {
                console.log('Creating transaction details modal');
                modal = document.createElement('div');
                modal.id = 'transaction-details-modal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <button class="close-modal" id="close-transaction-modal"></button>
                        <h2 class="modal-title">Transaction Details</h2>
                        <div id="transaction-details-content"></div>
                        <div class="form-actions">
                            <button class="btn" id="close-transaction-details">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                console.log('Modal appended to body:', modal.outerHTML);
                
                // Set up close handlers
                setupModalCloseHandlers(modal);
                
                // Add click handler to close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal);
                    }
                });
            }
            return modal;
        }

        // Call it during initialization
        document.addEventListener('DOMContentLoaded', ensureModalExists);
        
        // Initialize Admin Dashboard
        async function initializeAdminDashboard() {
            console.log('Initializing admin dashboard');
            
            try {
                // Load platform settings
                await loadPlatformSettings();
                
                // Load all users
                await loadAllUsers();
                
                // Initialize panels
                initializeOverviewPanel();
                initializeClientsPanel();
                initializeTransactionsPanel();
                initializeSettingsPanel();
                initializeLogsPanel();
                
                console.log('Admin dashboard initialized successfully');
            } catch (error) {
                console.error('Error initializing admin dashboard:', error);
                alert('Error loading dashboard: ' + error.message);
            }
        }
        
        // Load Platform Settings
        async function loadPlatformSettings() {
            console.log('Loading platform settings');
            
            try {
                const settingsDoc = await getDoc(doc(db, 'settings', 'platform'));
                
                if (settingsDoc.exists()) {
                    platformSettings = settingsDoc.data();
                } else {
                    // Create default settings if not exists
                    platformSettings = {
                        requireKycWithdrawal: false,
                        notifyLargeTransactions: false,
                        largeTransactionThreshold: 1000,
                        defaultProfitAmount: 10,
                        defaultProfitInterval: 30,
                        btcAddress: '',
                        nowPaymentsLink: '',
                        simplexLink: 'https://buy.simplex.com'
                    };
                    
                    // Save default settings to Firestore
                    await updateDoc(doc(db, 'settings', 'platform'), platformSettings);
                }
                
                console.log('Platform settings loaded:', platformSettings);
                
                // Update settings UI
                updateSettingsUI();
            } catch (error) {
                console.error('Error loading platform settings:', error);
                platformSettings = {};
            }
        }
        
        // Update Settings UI
        function updateSettingsUI() {
            // Set form values based on loaded settings
            const requireKycCheckbox = document.getElementById('require-kyc-withdrawal');
            const notifyLargeCheckbox = document.getElementById('notify-large-transactions');
            const largeThresholdInput = document.getElementById('large-transaction-threshold');
            const defaultProfitAmountInput = document.getElementById('default-profit-amount');
            const defaultProfitIntervalInput = document.getElementById('default-profit-interval');
            const globalBtcAddressInput = document.getElementById('global-btc-address');
            const globalNowpaymentsInput = document.getElementById('global-nowpayments-link');
            const globalSimplexInput = document.getElementById('global-simplex-link');
            
            if (requireKycCheckbox) {
                requireKycCheckbox.checked = platformSettings.requireKycWithdrawal || false;
            }
            
            if (notifyLargeCheckbox) {
                notifyLargeCheckbox.checked = platformSettings.notifyLargeTransactions || false;
            }
            
            if (largeThresholdInput) {
                largeThresholdInput.value = platformSettings.largeTransactionThreshold || 1000;
            }
            
            if (defaultProfitAmountInput) {
                defaultProfitAmountInput.value = platformSettings.defaultProfitAmount || 10;
            }
            
            if (defaultProfitIntervalInput) {
                defaultProfitIntervalInput.value = platformSettings.defaultProfitInterval || 30;
            }
            
            if (globalBtcAddressInput) {
                globalBtcAddressInput.value = platformSettings.btcAddress || '';
            }
            
            if (globalNowpaymentsInput) {
                globalNowpaymentsInput.value = platformSettings.nowPaymentsLink || '';
            }
            
            if (globalSimplexInput) {
                globalSimplexInput.value = platformSettings.simplexLink || 'https://buy.simplex.com';
            }
        }
        
        // Load All Users
        async function loadAllUsers() {
            console.log('Loading all users');
            
            try {
                // Get all non-admin users
                const usersQuery = query(
                    collection(db, 'users'),
                    where('role', '!=', 'admin')
                );
                
                const querySnapshot = await getDocs(usersQuery);
                allUsers = [];
                
                querySnapshot.forEach((doc) => {
                    allUsers.push({
                        uid: doc.id,
                        ...doc.data()
                    });
                });
                
                console.log(`Loaded ${allUsers.length} users`);
                
                // Update platform stats
                updatePlatformStats();
                
                return allUsers;
            } catch (error) {
                console.error('Error loading users:', error);
                throw error;
            }
        }
        
        // Update Platform Stats
        function updatePlatformStats() {
            const totalUsersElement = document.getElementById('total-users');
            const totalBalanceElement = document.getElementById('total-balance');
            const pendingRequestsElement = document.getElementById('pending-requests');
            
            if (totalUsersElement) {
                totalUsersElement.textContent = allUsers.length;
            }
            
            if (totalBalanceElement) {
                // Calculate total platform balance
                const totalBalance = allUsers.reduce((total, user) => {
                    return total + (user.balance || 0);
                }, 0);
                
                totalBalanceElement.textContent = formatCurrency(totalBalance);
            }
            
            if (pendingRequestsElement) {
                // Count pending requests
                let pendingCount = 0;
                
                allUsers.forEach(user => {
                    if (user.history && Array.isArray(user.history)) {
                        pendingCount += user.history.filter(tx => 
                            tx.type && tx.type.includes('request')
                        ).length;
                    }
                });
                
                pendingRequestsElement.textContent = pendingCount;
            }
        }
        
        // Format Timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Unknown date';
            
            try {
                let date;
                if (timestamp.toDate && typeof timestamp.toDate === 'function') {
                    // Handle Firestore Timestamp
                    date = timestamp.toDate();
                } else if (timestamp.seconds) {
                    // Handle Firestore Timestamp object format
                    date = new Date(timestamp.seconds * 1000);
                } else {
                    // Handle regular Date or timestamp
                    date = new Date(timestamp);
                }
                
                if (isNaN(date.getTime())) {
                    throw new Error('Invalid date');
                }
                
                return date.toLocaleString();
            } catch (error) {
                console.error('Error formatting timestamp:', error, timestamp);
                return 'Invalid date';
            }
        }
        
        // Format Currency
        function formatCurrency(value) {
            if (isNaN(value)) return '$0.00';
            
            return '$' + parseFloat(value).toFixed(2);
        }
        
        // Get Transaction Type Label
        function getTransactionTypeLabel(transaction) {
            const type = transaction.type || '';
            
            if (type.includes('deposit_request')) return 'Deposit Request';
            if (type.includes('deposit_approved')) return 'Deposit';
            if (type.includes('deposit_declined')) return 'Deposit (Declined)';
            if (type.includes('withdrawal_request')) return 'Withdrawal Request';
            if (type.includes('withdrawal_approved')) return 'Withdrawal';
            if (type.includes('withdrawal_declined')) return 'Withdrawal (Declined)';
            if (type === 'auto_profit') return 'Auto Profit';
            
            return 'Transaction';
        }
        
        // Get Transaction Status
        function getTransactionStatus(transaction) {
            const type = transaction.type || '';
            
            if (type.includes('request')) return 'pending';
            if (type.includes('approved') || type === 'auto_profit') return 'completed';
            if (type.includes('declined')) return 'failed';
            
            return 'pending';
        }
        
        // Get Status HTML
        function getStatusHTML(status) {
            switch(status) {
                case 'pending':
                    return '<span class="status pending">Pending</span>';
                case 'completed':
                case 'approved':
                    return '<span class="status completed">Completed</span>';
                case 'failed':
                case 'declined':
                    return '<span class="status failed">Failed</span>';
                default:
                    return '<span class="status pending">Processing</span>';
            }
        }
        
        // Log Admin Action
        async function logAdminAction(action) {
            console.log('Logging admin action:', action);
            
            try {
                const logEntry = {
                    admin: currentAdmin.email,
                    adminUid: currentAdmin.uid,
                    action: action,
                    timestamp: serverTimestamp()
                };
                
                await addDoc(collection(db, 'adminLogs'), logEntry);
                console.log('Admin action logged successfully');
                
                // Refresh logs if on logs panel
                if (document.getElementById('logs').classList.contains('active')) {
                    loadAdminLogs();
                }
            } catch (error) {
                console.error('Error logging admin action:', error);
            }
        }// Initialize Overview Panel
        function initializeOverviewPanel() {
            console.log('Initializing overview panel');
            
            // Load transactions first
            loadRecentTransactions();
            loadPendingRequests();
            
            // Add event listeners after a short delay to ensure DOM is updated
            setTimeout(() => {
                console.log('Setting up overview panel event listeners');
                const recentTransactionsContainer = document.getElementById('recent-transactions');
                const pendingTransactionsContainer = document.getElementById('pending-transactions');
                
                if (recentTransactionsContainer) {
                    console.log('Adding listeners to recent transactions');
                    addTransactionViewEventListeners(recentTransactionsContainer);
                }
                
                if (pendingTransactionsContainer) {
                    console.log('Adding listeners to pending transactions');
                    addTransactionViewEventListeners(pendingTransactionsContainer);
                }
            }, 100);
        }
        
        // Load Recent Transactions
        function loadRecentTransactions() {
            const recentTransactionsContainer = document.getElementById('recent-transactions');
            
            if (!recentTransactionsContainer) {
                console.error('Recent transactions container not found');
                return;
            }
            
            // Collect all transactions from all users
            let allTransactions = [];
            
            allUsers.forEach(user => {
                if (user.history && Array.isArray(user.history)) {
                    const userTransactions = user.history.map(tx => ({
                        ...tx,
                        userUid: user.uid,
                        userEmail: user.email,
                        userName: user.name || user.email.split('@')[0]
                    }));
                    
                    allTransactions = [...allTransactions, ...userTransactions];
                }
            });
            
            // Sort by date (most recent first)
            allTransactions.sort((a, b) => {
                const dateA = a.date && a.date.toMillis ? a.date.toMillis() : (a.date ? new Date(a.date).getTime() : 0);
                const dateB = b.date && b.date.toMillis ? b.date.toMillis() : (b.date ? new Date(b.date).getTime() : 0);
                return dateB - dateA;
            });
            
            // Take only the 5 most recent
            const recentTransactions = allTransactions.slice(0, 5);
            
            if (recentTransactions.length === 0) {
                recentTransactionsContainer.innerHTML = '<div class="no-data">No recent transactions found.</div>';
                return;
            }
            
            // Render transactions
            recentTransactionsContainer.innerHTML = '';
            
            recentTransactions.forEach(transaction => {
                const transactionEl = renderTransactionItem(transaction);
                recentTransactionsContainer.appendChild(transactionEl);
            });
        }
        
        // Load Pending Requests
        function loadPendingRequests() {
            console.log('Loading pending requests');
            
            const pendingTransactionsContainer = document.getElementById('pending-transactions');
            
            if (!pendingTransactionsContainer) {
                console.error('Pending transactions container not found');
                return;
            }
            
            // Collect all pending requests from all users
            let pendingRequests = [];
            
            allUsers.forEach(user => {
                if (user.history && Array.isArray(user.history)) {
                    // Filter for pending requests and add user info
                    const userPendingRequests = user.history
                        .filter(tx => tx.type && tx.type.includes('request'))
                        .map(tx => ({
                            ...tx,
                            userUid: user.uid,
                            userEmail: user.email,
                            userName: user.name || user.email.split('@')[0]
                        }));
                    
                    pendingRequests = [...pendingRequests, ...userPendingRequests];
                }
            });
            
            // Sort by date (most recent first)
            pendingRequests.sort((a, b) => {
                const dateA = a.date && a.date.toMillis ? a.date.toMillis() : (a.date ? new Date(a.date).getTime() : 0);
                const dateB = b.date && b.date.toMillis ? b.date.toMillis() : (b.date ? new Date(b.date).getTime() : 0);
                return dateB - dateA;
            });
            
            if (pendingRequests.length === 0) {
                pendingTransactionsContainer.innerHTML = '<div class="no-data">No pending requests found.</div>';
                return;
            }
            
            // Render pending requests
            pendingTransactionsContainer.innerHTML = '';
            
            pendingRequests.forEach(request => {
                const requestEl = renderTransactionItem(request, true);
                pendingTransactionsContainer.appendChild(requestEl);
            });
        }
        
        // Render Transaction Item
            function renderTransactionItem(transaction, showActions = false) {
            // Remove unnecessary transaction log
            const template = document.createElement('template');
            
            // Store transaction data as a JSON string, properly escaped for HTML
            const transactionData = JSON.stringify(transaction).replace(/"/g, '&quot;');
            
            template.innerHTML = `
                <div class="transaction-item" data-transaction='${transactionData}'>
                    <div class="transaction-info">
                        <div class="transaction-type">${getTransactionTypeLabel(transaction)}</div>
                        <div class="transaction-status">${getStatusHTML(getTransactionStatus(transaction))}</div>
                        <div class="transaction-amount">${formatCurrency(transaction.details?.amount || transaction.amount || 0)}</div>
                        <div class="transaction-date">${formatTimestamp(transaction.date) || 'N/A'}</div>
                        <div class="transaction-user">${transaction.userName || transaction.userEmail || 'Unknown'}</div>
                    </div>
                    <div class="transaction-actions">
                        ${transaction.type && transaction.type.includes('request') 
                            ? `<button class="btn btn-sm approve-transaction" data-transaction='${transactionData}' data-id="${transaction.id || ''}" data-uid="${transaction.userUid || ''}">Approve</button>
                               <button class="btn btn-sm btn-outline decline-transaction" data-transaction='${transactionData}' data-id="${transaction.id || ''}" data-uid="${transaction.userUid || ''}">Decline</button>`
                            : `<button class="btn btn-sm view-transaction" data-transaction='${transactionData}'>View</button>`
                        }
                    </div>
                </div>
            `;
            
            const item = template.content.firstElementChild;
            
            // Add click handler for view button
            const viewButton = item.querySelector('.view-transaction');
            if (viewButton) {
                viewButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    try {
                        const transactionData = JSON.parse(e.currentTarget.getAttribute('data-transaction'));
                        showTransactionDetails(transactionData);
                    } catch (error) {
                        console.error('Error parsing transaction data:', error);
                        alert('Error viewing transaction details');
                            }
                        });
                    }
            
            return item;
        }
        
        // Show Transaction Details
            function showTransactionDetails(transaction) {
            const modal = document.getElementById('transaction-details-modal');
            if (!modal) {
                console.error('Transaction modal not found');
                return;
            }
            
            const content = modal.querySelector('#transaction-details-content');
                if (!content) {
                console.error('Transaction details content element not found');
                    return;
                }
                
                if (!transaction) {
                console.error('No transaction data provided');
                    content.innerHTML = '<p>No transaction data available</p>';
                    return;
                }
                
            try {
                let typeText = getTransactionTypeLabel(transaction);
                let statusText = getStatusHTML(getTransactionStatus(transaction));
                let amount = transaction.details?.amount || transaction.amount || 0;
                let dateStr = formatTimestamp(transaction.date);
                
            content.innerHTML = `
                <div class="transaction-detail-row">
                    <div class="transaction-detail-label">Type</div>
                    <div class="transaction-detail-value">${typeText}</div>
                </div>
                <div class="transaction-detail-row">
                    <div class="transaction-detail-label">Status</div>
                    <div class="transaction-detail-value">${statusText}</div>
                </div>
                <div class="transaction-detail-row">
                    <div class="transaction-detail-label">Amount</div>
                        <div class="transaction-detail-value">${formatCurrency(amount)}</div>
                </div>
                <div class="transaction-detail-row">
                    <div class="transaction-detail-label">Date</div>
                    <div class="transaction-detail-value">${dateStr}</div>
                </div>
                <div class="transaction-detail-row">
                    <div class="transaction-detail-label">User</div>
                    <div class="transaction-detail-value">${transaction.userName || transaction.userEmail || 'Unknown'}</div>
                </div>
            `;
            
            // Add additional details if available
            if (transaction.details) {
                if (transaction.details.method) {
                        content.innerHTML += `
                        <div class="transaction-detail-row">
                            <div class="transaction-detail-label">Payment Method</div>
                            <div class="transaction-detail-value">${transaction.details.method}</div>
                        </div>
                    `;
                }
                if (transaction.details.address) {
                        content.innerHTML += `
                        <div class="transaction-detail-row">
                                <div class="transaction-detail-label">Wallet Address</div>
                            <div class="transaction-detail-value">${transaction.details.address}</div>
                        </div>
                    `;
                }
                if (transaction.details.notes) {
                        content.innerHTML += `
                        <div class="transaction-detail-row">
                            <div class="transaction-detail-label">Notes</div>
                            <div class="transaction-detail-value">${transaction.details.notes}</div>
                        </div>
                    `;
                    }
                }
                
                // Show modal
                modal.style.display = 'flex';
                modal.classList.add('show');
                
                // Ensure close buttons work
                const closeButtons = modal.querySelectorAll('.close-modal, #close-transaction-details');
                closeButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        closeModal(modal);
                    });
                });
                
                // Add click-outside handler
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal);
                    }
                });
                
            } catch (error) {
                console.error('Error displaying transaction details:', error);
                content.innerHTML = '<p>Error displaying transaction details</p>';
            }
        }

        // Update close handlers
        function setupModalCloseHandlers(modal) {
            console.log('Setting up modal close handlers');
            const closeButtons = modal.querySelectorAll('.close-modal, #close-transaction-details');
            closeButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    console.log('Close button clicked');
                    e.preventDefault();
                    e.stopPropagation();
                    closeModal(modal);
                });
            });
        }
        
        // Initialize Clients Panel
        function initializeClientsPanel() {
            console.log('Initializing clients panel');
            
            renderClientList();
            
            // Set up client search
            const searchInput = document.getElementById('client-search');
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    const query = searchInput.value.toLowerCase();
                    filterClients(query);
                });
            }
        }
        
        // Render Client List
        function renderClientList() {
            console.log('Rendering client list');
            
            const clientsContainer = document.getElementById('clients-container');
            
            if (!clientsContainer) {
                console.error('Clients container not found');
                return;
            }
            
            if (allUsers.length === 0) {
                clientsContainer.innerHTML = '<div class="no-data">No clients found.</div>';
                return;
            }
            
            // Sort clients by email
            allUsers.sort((a, b) => {
                return (a.email || '').localeCompare(b.email || '');
            });
            
            // Clear container
            clientsContainer.innerHTML = '';
            
            // Render each client
            allUsers.forEach(user => {
                const clientElement = renderClientItem(user);
                clientsContainer.appendChild(clientElement);
            });
            
            // Attach client event listeners
            attachClientListeners();
        }
        
        // Render Client Item
        function renderClientItem(user) {
            const template = document.getElementById('client-template');
            const clone = document.importNode(template.content, true);
            
            // Replace placeholders in template
            const html = clone.firstElementChild.outerHTML
                .replace(/{uid}/g, user.uid || '')
                .replace(/{name}/g, user.name || 'User')
                .replace(/{email}/g, user.email || '')
                .replace(/{balance}/g, user.balance ? user.balance.toFixed(2) : '0.00')
                .replace(/{level}/g, user.accountLevel || 'Basic')
                .replace(/{accountManager}/g, user.accountManager || '')
                .replace(/{nowPaymentsLink}/g, user.nowPaymentsLink || '')
                .replace(/{btcAddress}/g, user.btcAddress || '');
            
            // Create element from HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const clientElement = tempDiv.firstElementChild;
            
            // Set selected values for dropdowns
            setTimeout(() => {
                // Account level
                const accountLevelSelect = clientElement.querySelector(`#account-level-${user.uid}`);
                if (accountLevelSelect) {
                    accountLevelSelect.value = user.accountLevel || 'Basic';
                }
                
                // Account manager
                const accountManagerInput = clientElement.querySelector(`#account-manager-${user.uid}`);
                if (accountManagerInput) {
                    accountManagerInput.value = user.accountManager || '';
                }
                
                // KYC status
                const kycStatusSelect = clientElement.querySelector(`#kyc-status-${user.uid}`);
                if (kycStatusSelect) {
                    kycStatusSelect.value = user.kycStatus || 'unverified';
                }
                
                // KYC reason
                const kycReasonInput = clientElement.querySelector(`#kyc-reason-${user.uid}`);
                if (kycReasonInput) {
                    kycReasonInput.value = user.kycRejectionReason || '';
                }
                
                // Auto-profit settings
                const autoProfitAmountInput = clientElement.querySelector(`#auto-profit-amount-${user.uid}`);
                if (autoProfitAmountInput) {
                    autoProfitAmountInput.value = user.autoProfitAmount || '';
                }
                
                const autoProfitIntervalInput = clientElement.querySelector(`#auto-profit-interval-${user.uid}`);
                if (autoProfitIntervalInput) {
                    autoProfitIntervalInput.value = user.autoProfitInterval || '';
                }
                
                const autoProfitToggleSelect = clientElement.querySelector(`#auto-profit-toggle-${user.uid}`);
                if (autoProfitToggleSelect) {
                    autoProfitToggleSelect.value = user.autoProfitEnabled ? 'enabled' : 'disabled';
                }
                
                // Display KYC image if available
                if (user.kycPhotoBase64) {
                    const kycPreviewContainer = clientElement.querySelector(`#kyc-preview-container-${user.uid}`);
                    if (kycPreviewContainer) {
                        kycPreviewContainer.innerHTML = `
                            <div class="kyc-preview">
                                <img src="${user.kycPhotoBase64}" alt="KYC Document" style="max-width: 100%;">
                            </div>
                        `;
                    }
                }
                
                // Load client transactions
                loadClientTransactions(user.uid);
                
                // Load client chat messages
                loadClientChat(user.uid);
            }, 0);
            
            return clientElement;
        }
        
        // Filter Clients
        function filterClients(query) {
            const clientItems = document.querySelectorAll('.client-item');
            
            clientItems.forEach(item => {
                const name = item.querySelector('.client-name').textContent.toLowerCase();
                const email = item.querySelector('.client-email').textContent.toLowerCase();
                
                if (name.includes(query) || email.includes(query)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // Attach Client Listeners
        function attachClientListeners() {
            console.log('Attaching client listeners');
            
            // Client header toggle
            const clientHeaders = document.querySelectorAll('.client-header');
            clientHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const clientItem = header.closest('.client-item');
                    const clientDetails = clientItem.querySelector('.client-details');
                    clientDetails.classList.toggle('active');
                });
            });
            
            // Update Account button
            const updateAccountBtns = document.querySelectorAll('.update-account');
            updateAccountBtns.forEach(btn => {
                btn.addEventListener('click', handleUpdateAccount);
            });
            
            // Update KYC button
            const updateKycBtns = document.querySelectorAll('.update-kyc');
            updateKycBtns.forEach(btn => {
                btn.addEventListener('click', handleUpdateKyc);
            });
            
            // Update Auto-Profit button
            const updateAutoProfitBtns = document.querySelectorAll('.update-auto-profit');
            updateAutoProfitBtns.forEach(btn => {
                btn.addEventListener('click', handleUpdateAutoProfit);
            });
            
            // Add Warning button
            const addWarningBtns = document.querySelectorAll('.add-warning');
            addWarningBtns.forEach(btn => {
                btn.addEventListener('click', handleAddWarning);
            });

            // Warning visibility toggle
            const warningToggles = document.querySelectorAll('.show-warnings-toggle');
            warningToggles.forEach(toggle => {
                // Set initial state
                const uid = toggle.getAttribute('data-uid');
                const userIndex = allUsers.findIndex(u => u.uid === uid);
                if (userIndex !== -1) {
                    toggle.checked = allUsers[userIndex].showWarnings !== false;
                }
                // Add change listener
                toggle.addEventListener('change', handleWarningToggle);
            });
            
            // Send Message button
            const sendMessageBtns = document.querySelectorAll('.send-message');
            sendMessageBtns.forEach(btn => {
                btn.addEventListener('click', handleSendMessage);
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citron Trades - Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            /* Dark theme variables */
            --bg-dark: #161625;
            --bg-card: #1A1A2E;
            --color-primary: #3B82F6;
            --color-primary-hover: #2563EB;
            --color-text: #ffffff;
            --color-text-secondary: #a0a0b8;
            --color-border: #2a2a3d;
            --color-positive: #40B467;  /* Keep green for profits */
            --color-negative: #e74c3c;  /* Keep red for losses */
            --color-warning: #f39c12;
            --color-info: #3498db;
        }

        /* Light theme variables */
        :root[data-theme="light"] {
            --bg-dark: #f8f9fa;
            --bg-card: #ffffff;
            --color-text: #2d3436;
            --color-text-secondary: #636e72;
            --color-border: #dfe6e9;
            --color-primary: #3B82F6;
            --color-primary-hover: #2563EB;
            --color-positive: #40B467;  /* Keep green for profits */
            --color-negative: #e74c3c;  /* Keep red for losses */
            --color-warning: #f39c12;
            --color-info: #3498db;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--color-text);
            min-height: 100vh;
            line-height: 1.5;
        }
        .dashboard {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 260px;
            background: var(--bg-dark);
            padding: 1.5rem 1rem;
            border-right: 1px solid var(--color-border);
            transition: transform 0.3s ease;
            position: fixed;
            height: 100%;
            z-index: 1000;
            overflow-y: auto;
        }
        .sidebar.hidden { transform: translateX(-260px); }
        .logo-container {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            padding-left: 0.5rem;
        }
        .logo {
            height: 32px;
            margin-right: 0.75rem;
        }
        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .nav-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin: 1.5rem 0 0.5rem 0.5rem;
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin: 0.25rem 0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            color: var(--color-text-secondary);
        }
        .nav-item svg {
            margin-right: 0.75rem;
        }
        .nav-item:hover {
            background: rgba(64, 180, 103, 0.1);
            color: var(--color-text);
        }
        .nav-item.active {
            background: rgba(64, 180, 103, 0.15);
            color: var(--color-primary);
        }
        .main {
            flex: 1;
            padding: 1.5rem;
            margin-left: 260px;
            transition: margin-left 0.3s ease;
        }
        .main.full { margin-left: 0; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--color-border);
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .toggle-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--color-text);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
        }
        .panel {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .panel.active {
            display: block;
            opacity: 1;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Admin-specific styles */
        .admin-badge {
            background: var(--color-primary);
            color: #fff;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }
        .admin-info {
            display: flex;
            align-items: center;
            color: var(--color-text);
            font-weight: 500;
        }

        /* Theme toggle button styles */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: none;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            cursor: pointer;
            margin-right: 1rem;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: rgba(64, 180, 103, 0.1);
        }

        .theme-toggle svg {
            width: 18px;
            height: 18px;
        }
    </style>
    <style>
        /* Admin dashboard specific components */
        .section {
            margin-bottom: 2rem;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-text);
        }
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--color-border);
            overflow: hidden;
            margin-bottom: 1.5rem;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--color-border);
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .card-content {
            padding: 1.25rem;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 1.25rem;
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: -0.5rem;
        }
        .form-col {
            flex: 1;
            padding: 0.5rem;
            min-width: 200px;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
        }
        input, select, textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            font-size: 0.95rem;
            transition: border-color 0.2s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--color-primary);
        }
        .input-hint {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            margin-top: 0.25rem;
        }
        
        /* Button styles */
        .btn, button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.65rem 1.25rem;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn:hover, button:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
        }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--color-primary);
            color: var(--color-primary);
        }
        .btn-outline:hover {
            background: rgba(64, 180, 103, 0.1);
        }
        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }
        .btn-warning {
            background-color: var(--color-warning);
        }
        .btn-warning:hover {
            background-color: #d68c10;
        }
        .btn-danger {
            background-color: var(--color-negative);
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .btn-group {
            display: flex;
            gap: 0.5rem;
        }
        
        /* Status badges */
        .status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .status.pending {
            background: rgba(243, 156, 18, 0.15);
            color: #f39c12;
        }
        .status.completed, .status.approved {
            background: rgba(64, 180, 103, 0.15);
            color: var(--color-positive);
        }
        .status.failed, .status.declined {
            background: rgba(231, 76, 60, 0.15);
            color: var(--color-negative);
        }
        
        /* Client management styles */
        .clients-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .client-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            overflow: hidden;
        }
        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .client-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .client-name {
            font-weight: 500;
        }
        .client-email {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }
        .client-balance {
            font-weight: 600;
            color: var(--color-primary);
        }
        .client-details {
            padding: 1rem;
            border-top: 1px solid var(--color-border);
            display: none;
        }
        .client-details.active {
            display: block;
        }
        .client-actions {
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .action-group {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .action-group-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--color-text);
        }
        
        /* Transaction management styles */
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--color-border);
        }
        .transaction-item:last-child {
            border-bottom: none;
        }
        .transaction-details {
            flex: 1;
        }
        .transaction-type {
            font-weight: 500;
        }
        .transaction-amount {
            font-weight: 600;
            color: var(--color-primary);
        }
        .transaction-date {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }
        .transaction-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        /* Admin log styles */
        .admin-log-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            padding: 0.75rem;
            border-bottom: 1px solid var(--color-border);
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-timestamp {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            margin-bottom: 0.25rem;
        }
        .log-message {
            color: var(--color-text);
        }
        .log-admin {
            font-weight: 500;
            color: var(--color-primary);
        }
        
        /* Payment methods and settings styles */
        .payment-methods-group {
            background: rgba(64, 180, 103, 0.05);
            border: 1px solid rgba(64, 180, 103, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        .payment-method-field {
            margin-bottom: 0.75rem;
        }
        .payment-method-field:last-child {
            margin-bottom: 0;
        }
        .input-group {
            display: flex;
            align-items: center;
        }
        .input-group input {
            flex: 1;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        .input-group button {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
        
        /* Settings section */
        .settings-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        .setting-card {
            background: var(--bg-card);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 1rem;
        }
        .setting-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .setting-description {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            margin-bottom: 1rem;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: auto;
            visibility: hidden;
        }

        .modal.show {
            opacity: 1;
            display: flex !important;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            position: relative;
            color: var(--color-text);
            border: 1px solid var(--color-border);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(0);
            transition: transform 0.3s ease-in-out;
            pointer-events: auto;
            z-index: 10000;
        }

        .transaction-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            border-bottom: 1px solid var(--color-border);
        }

        .transaction-detail-row:last-child {
            border-bottom: none;
        }

        .transaction-detail-label {
            font-weight: 500;
            color: var(--color-text-secondary);
        }

        .transaction-detail-value {
            color: var(--color-text);
            text-align: right;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--color-text-secondary);
            padding: 0.5rem;
            line-height: 1;
            transition: color 0.2s ease-in-out;
            z-index: 10001;
            pointer-events: auto;
        }

        .close-modal:hover {
            color: var(--color-text);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-right: 2rem;
            color: var(--color-text);
        }

        #transaction-details-content {
            margin: 1rem 0;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .form-actions {
            margin-top: 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        .form-actions .btn {
            min-width: 100px;
            pointer-events: auto;
        }
        
        /* Ensure modal is above all other content */
        .modal, .modal-content {
            z-index: 9999;
        }
        
        /* Ensure buttons are clickable */
        .btn {
            pointer-events: auto;
            cursor: pointer;
            position: relative;
            z-index: 1;
        }
        
        /* Responsive styles */
        @media (max-width: 1024px) {
            .main {
                margin-left: 0;
            }
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.visible {
                transform: translateX(0);
            }
        }
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
                padding: 1rem 0;
                position: relative;
            }
            .header-left {
                width: 100%;
                flex-direction: row;
                align-items: center;
                justify-content: flex-start;
                gap: 1rem;
            }
            .mobile-brand {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                position: relative;
                padding: 0 3.5rem;
            }
            .logo {
                height: 32px;
                width: auto;
            }
            .logo-text {
                display: none; /* Hide the text */
            }
            .header-title {
                display: none; /* Hide panel titles on mobile */
            }
            .toggle-btn {
                position: absolute;
                top: 1rem;
                left: 1rem;
                z-index: 10;
            }
            .theme-toggle {
                position: absolute;
                top: 1rem;
                right: 1rem;
                z-index: 10;
                margin-right: 0;
            }
            .admin-info {
                width: 100%;
                flex-direction: column;
                align-items: center;
                text-align: center;
                gap: 0.25rem;
                margin-top: 0.5rem;
            }
            .form-row {
                flex-direction: column;
            }
            .client-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
    <style>
        /* Mobile Responsive Styles */
        @media (max-width: 1024px) {
            .main {
                margin-left: 0;
                padding: 1rem;
            }
            .sidebar {
                transform: translateX(-100%);
                z-index: 1000;
                background: var(--bg-dark);
                box-shadow: 2px 0 8px rgba(0, 0, 0, 0.2);
                transition: transform 0.3s ease;
            }
            .sidebar.visible {
                transform: translateX(0);
            }
            .logo-container {
                padding: 1rem;
                margin-bottom: 1.5rem;
                border-bottom: 1px solid var(--color-border);
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            .logo-container .mobile-close {
                display: block;
                padding: 0.5rem;
                cursor: pointer;
                color: var(--color-text-secondary);
            }
            .mobile-header {
                display: flex;
                align-items: center;
                gap: 1rem;
                margin-bottom: 1rem;
            }
            .mobile-logo {
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: var(--color-primary);
                border-radius: 8px;
                color: white;
                font-weight: bold;
                font-size: 1.2rem;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
                padding: 1rem 0;
                position: relative;
            }
            .header-left {
                width: 100%;
                flex-direction: column;
                align-items: flex-start;
            }
            .mobile-brand {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                position: absolute;
                top: 1rem;
                left: 50%;
                transform: translateX(-50%);
                padding: 0 3.5rem;
            }
            .mobile-brand .logo {
                width: 32px;
                height: 32px;
                background: var(--color-primary);
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                font-size: 1.1rem;
                margin-right: 0;
            }
            .mobile-brand .logo-text {
                font-size: 1.2rem;
                font-weight: 600;
                color: var(--color-text);
                white-space: nowrap;
                margin-left: 0;
            }
            .toggle-btn {
                position: absolute;
                top: 1rem;
                left: 1rem;
                z-index: 10;
            }
            .theme-toggle {
                position: absolute;
                top: 1rem;
                right: 1rem;
                z-index: 10;
                margin-right: 0;
            }
            .admin-info {
                width: 100%;
                flex-direction: column;
                align-items: center;
                text-align: center;
                gap: 0.25rem;
                margin-top: 4rem;
            }
            .admin-badge {
                margin-left: 0;
                margin-top: 0.25rem;
            }
            .mobile-header {
                display: none;
            }

            /* Card and form adjustments */
            .form-row {
                flex-direction: column;
            }
            .form-col {
                width: 100%;
                min-width: 100%;
            }
            .card {
                margin: 0 -1rem;
                border-radius: 0;
            }
            .card-content {
                padding: 1rem;
            }
            
            /* Stats grid adjustments */
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            .stat-card {
                padding: 1rem;
            }

            /* Table adjustments */
            .table-container {
                margin: 0 -1rem;
                width: calc(100% + 2rem);
                overflow-x: auto;
            }
            .table {
                font-size: 0.85rem;
            }
            .table th,
            .table td {
                padding: 0.75rem;
                white-space: nowrap;
            }

            /* Client management adjustments */
            .client-item {
                padding: 1rem;
            }
            .client-header {
                flex-direction: column;
                gap: 0.5rem;
            }
            .client-actions {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            .client-actions .btn {
                width: 100%;
            }

            /* Modal adjustments */
            .modal-content {
                width: 95%;
                margin: 1rem;
                max-height: 90vh;
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .header-title {
                font-size: 1.25rem;
            }
            .section-title {
                font-size: 1.1rem;
            }
            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
            .table th:nth-child(4),
            .table td:nth-child(4) {
                display: none;
            }
            .client-details {
                padding: 0.75rem;
            }
            .action-group {
                padding: 0.75rem;
            }
        }

        /* Hide mobile elements on desktop */
        .mobile-close,
        .mobile-header,
        .mobile-brand {
            display: none;
        }

        /* Show mobile brand only on mobile */
        @media (max-width: 768px) {
            .mobile-brand {
                display: flex;
            }
        }
    </style>
</head><body>
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="logo-container">
                <img src="https://gistcdn.githack.com/Zealsharon986/065de595e0ffdfa2d7cf23881e1e23d3/raw/b1b64e7237340a6aae8bb39f69dc2298a521dc10/logo.svg" alt="Citron Trades" class="logo">
            </div>
            
            <div class="nav-label">Dashboard</div>
            <div class="nav-item active" data-panel="overview">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></svg>
                Overview
            </div>
            <div class="nav-item" data-panel="clients">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                Clients
            </div>
            <div class="nav-item" data-panel="transactions">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                Transactions
            </div>
            
            <div class="nav-label">Administration</div>
            <div class="nav-item" data-panel="settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                Settings
            </div>
            <div class="nav-item" data-panel="logs">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                Admin Logs
            </div>
        </div>

        <!-- Main Content -->
        <div class="main" id="main">
            <!-- Add mobile header -->
            <div class="mobile-header">
                <div class="mobile-logo">C</div>
                <h1 class="header-title">Citron Trades</h1>
            </div>
            <div class="header">
                <div class="header-left">
                    <button class="toggle-btn" id="toggle-sidebar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </button>
                    <!-- Add mobile brand section -->
                    <div class="mobile-brand">
                        <img src="https://gistcdn.githack.com/Zealsharon986/065de595e0ffdfa2d7cf23881e1e23d3/raw/b1b64e7237340a6aae8bb39f69dc2298a521dc10/logo.svg" alt="Citron Trades" class="logo">
                    </div>
                    <h1 class="header-title" id="panel-title">Overview</h1>
                </div>
                <div class="admin-info">
                    <button class="theme-toggle" id="theme-toggle" title="Toggle theme">
                        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </button>
                    <span id="admin-email">admin@citrontrades.com</span>
                    <span class="admin-badge">Admin</span>
                </div>
                <button id="logout-btn" class="btn btn-outline">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    Logout
                </button>
            </div><!-- Overview Panel -->
            <div class="panel active" id="overview">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Platform Overview</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Platform Statistics</h3>
                        </div>
                        <div class="card-content">
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="stat-card">
                                        <div class="stat-card-header">
                                            <h3>Total Users</h3>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                                        </div>
                                        <div class="stat-card-value" id="total-users">0</div>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="stat-card">
                                        <div class="stat-card-header">
                                            <h3>Platform Balance</h3>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                                        </div>
                                        <div class="stat-card-value" id="total-balance">$0.00</div>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="stat-card">
                                        <div class="stat-card-header">
                                            <h3>Pending Requests</h3>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-warning"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                        </div>
                                        <div class="stat-card-value" id="pending-requests">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Recent Transactions</h2>
                        <a href="#" class="view-all" id="view-all-transactions">View All</a>
                    </div>
                    
                    <div class="card">
                        <div class="card-content">
                            <div id="recent-transactions">
                                <!-- Will be populated by JavaScript -->
                                <div class="no-data">Loading transactions...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Pending Requests</h2>
                        <a href="#" class="view-all" id="view-all-requests">View All</a>
                    </div>
                    
                    <div class="card">
                        <div class="card-content">
                            <div id="pending-transactions">
                                <!-- Will be populated by JavaScript -->
                                <div class="no-data">Loading pending requests...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Clients Panel -->
            <div class="panel" id="clients">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Client Management</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">All Clients</h3>
                            <div class="search-container">
                                <input type="text" id="client-search" placeholder="Search clients..." class="search-input">
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="clients-container" id="clients-container">
                                <!-- Will be populated by JavaScript -->
                                <div class="no-data">Loading clients...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- Transactions Panel -->
            <div class="panel" id="transactions">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Transaction Management</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">All Transactions</h3>
                            <div class="transaction-filters">
                                <select id="transaction-type-filter" class="styled-select">
                                    <option value="all">All Types</option>
                                    <option value="deposit">Deposits</option>
                                    <option value="withdrawal">Withdrawals</option>
                                    <option value="auto_profit">Auto Profit</option>
                                </select>
                                <select id="transaction-status-filter" class="styled-select">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="completed">Completed</option>
                                    <option value="failed">Failed</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-content">
                            <div id="all-transactions">
                                <!-- Will be populated by JavaScript -->
                                <div class="no-data">Loading transactions...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Panel -->
            <div class="panel" id="settings">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Platform Settings</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Payment Methods</h3>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label for="global-btc-address">Default Bitcoin Address</label>
                                <div class="input-group">
                                    <input type="text" id="global-btc-address" placeholder="e.g., bc1q...">
                                    <button id="save-btc-address" class="btn">Save</button>
                                </div>
                                <div class="input-hint">This address will be used for all users' Bitcoin deposits unless overridden.</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="global-nowpayments-link">Default NOWPayments Link</label>
                                <div class="input-group">
                                    <input type="text" id="global-nowpayments-link" placeholder="e.g., https://nowpayments.io/...">
                                    <button id="save-nowpayments-link" class="btn">Save</button>
                                </div>
                                <div class="input-hint">This link will be used for all users' crypto payments unless overridden.</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="global-simplex-link">Default Simplex Link</label>
                                <div class="input-group">
                                    <input type="text" id="global-simplex-link" placeholder="e.g., https://buy.simplex.com/...">
                                    <button id="save-simplex-link" class="btn">Save</button>
                                </div>
                                <div class="input-hint">This link will be used for all users' card payments.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Auto-Profit Settings</h3>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label for="default-profit-amount">Default Profit Amount ($)</label>
                                <div class="input-group">
                                    <input type="number" id="default-profit-amount" placeholder="e.g., 10" min="1" step="0.01">
                                    <button id="save-profit-amount" class="btn">Save</button>
                                </div>
                                <div class="input-hint">Default amount for auto-profit feature for new users.</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="default-profit-interval">Default Profit Interval (minutes)</label>
                                <div class="input-group">
                                    <input type="number" id="default-profit-interval" placeholder="e.g., 30" min="10" step="1">
                                    <button id="save-profit-interval" class="btn">Save</button>
                                </div>
                                <div class="input-hint">Default interval for auto-profit feature for new users (min: 10 minutes).</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Security Settings</h3>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="require-kyc-withdrawal">
                                    Require KYC for withdrawals
                                </label>
                                <div class="input-hint">If enabled, users must complete KYC verification before making withdrawals.</div>
                            </div>
                            
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="notify-large-transactions">
                                    Notify on large transactions
                                </label>
                                <div class="input-hint">Send admin notification for transactions above threshold.</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="large-transaction-threshold">Large Transaction Threshold ($)</label>
                                <input type="number" id="large-transaction-threshold" placeholder="e.g., 1000" min="100" step="10">
                            </div>
                            
                            <button id="save-security-settings" class="btn">Save Security Settings</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Logs Panel -->
            <div class="panel" id="logs">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Admin Activity Logs</h2>
                        <button id="refresh-logs" class="btn btn-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 2v6h6M21.5 22v-6h-6"></path><path d="M22 11.5A10 10 0 0 0 3.2 7.2M2 12.5a10 10 0 0 0 18.8 4.2"></path></svg>
                            Refresh
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Recent Activity</h3>
                        </div>
                        <div class="card-content">
                            <div class="admin-log-container" id="admin-logs">
                                <!-- Will be populated by JavaScript -->
                                <div class="no-data">Loading admin logs...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div></div>
    </div>
    
    <!-- Client Template (Hidden) -->
    <template id="client-template">
        <div class="client-item" data-uid="{uid}">
            <div class="client-header">
                <div>
                    <div class="client-name">{name}</div>
                    <div class="client-email">{email}</div>
                </div>
                <div>
                    <div class="client-balance">${balance}</div>
                    <div class="client-level">Level: {level}</div>
                </div>
            </div>
            <div class="client-details">
                <div class="action-group">
                    <div class="action-group-title">Account Information</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="account-level-{uid}">Account Level</label>
                                <select id="account-level-{uid}" class="account-level-select" data-uid="{uid}">
                                    <option value="Basic">Basic</option>
                                    <option value="Pro">Pro</option>
                                    <option value="Elite">Elite</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="balance-{uid}">Balance ($)</label>
                                <input type="number" id="balance-{uid}" class="balance-input" data-uid="{uid}" value="{balance}" step="0.01">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="account-manager-{uid}">Account Manager</label>
                                <input type="text" id="account-manager-{uid}" class="account-manager-input" data-uid="{uid}" value="{accountManager}" placeholder="Enter account manager name">
                            </div>
                        </div>
                    </div>
                    
                    <div class="client-actions">
                        <button class="btn update-account" data-uid="{uid}">Update Account</button>
                    </div>
                </div>
                
                <div class="action-group">
                    <div class="action-group-title">Warning Management</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="warning-message-{uid}">Warning Message</label>
                                <textarea id="warning-message-{uid}" class="warning-message-input" data-uid="{uid}" placeholder="Enter warning message"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="toggle-label">
                                    <input type="checkbox" id="show-warnings-{uid}" class="show-warnings-toggle" data-uid="{uid}">
                                    Show warnings to user
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="client-actions">
                        <button class="btn btn-warning add-warning" data-uid="{uid}">Add Warning</button>
                    </div>
                </div>
                
                <div class="action-group">
                    <div class="action-group-title">KYC Verification</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="kyc-status-{uid}">KYC Status</label>
                                <select id="kyc-status-{uid}" class="kyc-status-select" data-uid="{uid}">
                                    <option value="unverified">Unverified</option>
                                    <option value="pending">Pending</option>
                                    <option value="verified">Verified</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="kyc-reason-{uid}">Rejection Reason (if applicable)</label>
                                <input type="text" id="kyc-reason-{uid}" class="kyc-reason-input" data-uid="{uid}" placeholder="Reason for rejection">
                            </div>
                        </div>
                    </div>
                    
                    <div id="kyc-preview-container-{uid}" class="kyc-preview-container">
                        <!-- KYC image will be shown here if available -->
                    </div>
                    
                    <div class="client-actions">
                        <button class="btn update-kyc" data-uid="{uid}">Update KYC Status</button>
                    </div>
                </div>
                
                <div class="action-group">
                    <div class="action-group-title">Auto-Profit Settings</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="auto-profit-amount-{uid}">Profit Amount ($)</label>
                                <input type="number" id="auto-profit-amount-{uid}" class="auto-profit-amount-input" data-uid="{uid}" min="1" step="0.01">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="auto-profit-interval-{uid}">Interval (minutes)</label>
                                <input type="number" id="auto-profit-interval-{uid}" class="auto-profit-interval-input" data-uid="{uid}" min="10" step="1">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="auto-profit-toggle-{uid}">Status</label>
                                <select id="auto-profit-toggle-{uid}" class="auto-profit-toggle-select" data-uid="{uid}">
                                    <option value="enabled">Enabled</option>
                                    <option value="disabled">Disabled</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="auto-trade-block-{uid}">Block Auto-Trade</label>
                                <select id="auto-trade-block-{uid}" class="auto-trade-block-select" data-uid="{uid}">
                                    <option value="unblocked">Unblocked</option>
                                    <option value="blocked">Blocked</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="client-actions">
                        <button class="btn update-auto-profit" data-uid="{uid}">Update Auto-Trade</button>
                    </div>
                </div>
                
                <!-- New Payment Methods Section -->
                <div class="action-group payment-methods-group">
                    <div class="action-group-title">Payment Methods</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group payment-method-field">
                                <label for="nowpayments-link-{uid}">NOWPayments Link</label>
                                <input type="text" id="nowpayments-link-{uid}" class="nowpayments-input" data-uid="{uid}" value="{nowPaymentsLink}" placeholder="e.g., https://nowpayments.io/...">
                                <div class="input-hint">For user's 'Pay With Crypto' button</div>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group payment-method-field">
                                <label for="btc-address-{uid}">BTC Address</label>
                                <input type="text" id="btc-address-{uid}" class="btc-address-input" data-uid="{uid}" value="{btcAddress}" placeholder="e.g., bc1q...">
                                <div class="input-hint">For user's crypto deposits</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="client-actions">
                        <button class="btn update-payment-methods" data-uid="{uid}">Update Payment Methods</button>
                    </div>
                </div>
                
                <div class="action-group">
                    <div class="action-group-title">Withdrawal Settings</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="withdrawal-code-{uid}">Withdrawal Code</label>
                                <div class="input-group">
                                    <input type="text" id="withdrawal-code-{uid}" class="withdrawal-code-input" data-uid="{uid}" maxlength="6" placeholder="Enter 6-digit code">
                                    <button class="btn update-withdrawal-code" data-uid="{uid}">Set Code</button>
                                </div>
                                <div class="input-hint">Set a 6-digit code required for withdrawals</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="action-group">
                    <div class="action-group-title">Recent Transactions</div>
                    <div class="client-transactions" id="client-transactions-{uid}">
                        <div class="no-data">Loading transactions...</div>
                    </div>
                </div>
                
                <div class="action-group">
                    <div class="action-group-title">Support Chat</div>
                    <div class="client-chat" id="client-chat-{uid}">
                        <div class="form-group">
                            <textarea id="chat-message-{uid}" class="chat-message-input" data-uid="{uid}" placeholder="Type your message..."></textarea>
                        </div>
                        <div class="client-actions">
                            <button class="btn send-message" data-uid="{uid}">Send Message</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Transaction Template (Hidden) -->
    <template id="transaction-template">
        <div class="transaction-item" data-id="{id}">
            <div class="transaction-details">
                <div class="transaction-type">{type}</div>
                <div class="transaction-info">
                    <span class="transaction-amount">{amount}</span>
                    <span class="transaction-status">{status}</span>
                </div>
                <div class="transaction-date">{date}</div>
                <div class="transaction-user">User: {user}</div>
            </div>
            <div class="transaction-actions">
                {buttons}
            </div>
        </div>
    </template>
    
    <!-- Log Entry Template (Hidden) -->
    <template id="log-entry-template">
        <div class="log-entry">
            <div class="log-timestamp">{timestamp}</div>
            <div class="log-message">
                <span class="log-admin">{admin}</span> {action}
            </div>
        </div>
    </template>
    
    <!-- Client Transaction Template (Hidden) -->
    <template id="client-transaction-template">
        <div class="transaction-item client-transaction" data-id="{id}">
            <div class="transaction-details">
                <div class="transaction-type">{type}</div>
                <div class="transaction-info">
                    <span class="transaction-amount">{amount}</span>
                    <span class="transaction-status">{status}</span>
                </div>
                <div class="transaction-date">{date}</div>
            </div>
            <div class="transaction-actions">
                {buttons}
            </div>
        </div>
    </template>
    
    <!-- Add Warning Modal -->
    <div class="modal" id="warning-modal">
        <div class="modal-content">
            <button class="close-modal" id="close-warning-modal"></button>
            <h2 class="modal-title">Add Warning</h2>
            <p class="modal-desc">This warning will be displayed to the user on their dashboard.</p>
            
            <div class="form-group">
                <label for="warning-message">Warning Message</label>
                <textarea id="warning-message" placeholder="Enter warning message" rows="4"></textarea>
            </div>
            
            <input type="hidden" id="warning-user-id">
            
            <div class="form-actions">
                <button class="btn btn-outline" id="cancel-warning">Cancel</button>
                <button class="btn btn-warning" id="submit-warning">Add Warning</button>
            </div>
        </div>
    </div>
    
    <!-- Transaction Details Modal -->
    <div class="modal" id="transaction-details-modal">
        <div class="modal-content">
            <button class="close-modal" id="close-transaction-modal"></button>
            <h2 class="modal-title">Transaction Details</h2>
            
            <div id="transaction-details-content">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <div class="form-actions">
                <button class="btn" id="close-transaction-details">Close</button>
            </div>
        </div>
    </div><!-- Core Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            getDocs, 
            updateDoc, 
            addDoc, 
            arrayUnion, 
            query, 
            where, 
            orderBy, 
            Timestamp, 
            onSnapshot,
            serverTimestamp,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAEPH6zPhhmyrAL8YPKzJWZZVOT8LScpIg",
            authDomain: "invest-mgnt.firebaseapp.com",
            projectId: "invest-mgnt",
            storageBucket: "invest-mgnt.firebasestorage.app",
            messagingSenderId: "658245081425",
            appId: "1:658245081425:web:73eeaa2614e426030c1b70",
            measurementId: "G-F03JXGD2ZT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Global variables
        let currentAdmin = null;
        let allUsers = [];
        let adminName = 'Admin';
        let platformSettings = {};
        
        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const main = document.getElementById('main');
        const navItems = document.querySelectorAll('.nav-item');
        const logoutBtn = document.getElementById('logout-btn');
        const toggleSidebarBtn = document.getElementById('toggle-sidebar');
        
        // Wait for DOM to be loaded before setting up event listeners
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, setting up event listeners');
            setupNavigation();
            setupLogout();
            setupModals();
        });
        
        // Setup Navigation
        function setupNavigation() {
            // Toggle sidebar
            const toggleSidebarBtn = document.getElementById('toggle-sidebar');
            const closeSidebarBtn = document.getElementById('close-sidebar');
            const sidebar = document.getElementById('sidebar');
            const main = document.getElementById('main');
            
            toggleSidebarBtn.addEventListener('click', () => {
                console.log('Toggle sidebar clicked');
                if (window.innerWidth <= 1024) {
                    sidebar.classList.toggle('visible');
                } else {
                    sidebar.classList.toggle('hidden');
                    main.classList.toggle('full');
                }
            });

            // Close sidebar on mobile
            if (closeSidebarBtn) {
                closeSidebarBtn.addEventListener('click', () => {
                    sidebar.classList.remove('visible');
                });
            }

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 1024 && 
                    !sidebar.contains(e.target) && 
                    !toggleSidebarBtn.contains(e.target) &&
                    sidebar.classList.contains('visible')) {
                    sidebar.classList.remove('visible');
                }
            });

            // Close sidebar when clicking nav items on mobile
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    if (window.innerWidth <= 1024) {
                        sidebar.classList.remove('visible');
                    }
                });
            });
            
            // Panel switching
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const panelId = item.getAttribute('data-panel');
                    console.log(`Nav item clicked: ${panelId}`);
                    
                    // Remove active class from all nav items
                    navItems.forEach(nav => nav.classList.remove('active'));
                    
                    // Add active class to clicked nav item
                    item.classList.add('active');
                    
                    // Hide all panels
                    const panels = document.querySelectorAll('.panel');
                    panels.forEach(panel => panel.classList.remove('active'));
                    
                    // Show selected panel
                    const panel = document.getElementById(panelId);
                    if (panel) {
                        panel.classList.add('active');
                        document.getElementById('panel-title').textContent = panelId.charAt(0).toUpperCase() + panelId.slice(1);
                        console.log(`Panel ${panelId} activated`);
                    } else {
                        console.error(`Panel with ID ${panelId} not found`);
                    }
                });
            });
        }
        
        // Setup Logout Button
        function setupLogout() {
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Logout button clicked');
                    
                    signOut(auth)
                        .then(() => {
                            console.log('Admin signed out successfully');
                            window.location.href = 'login.html';
                        })
                        .catch((error) => {
                            console.error('Error signing out:', error);
                            alert('Error signing out: ' + error.message);
                        });
                });
            } else {
                console.error('Logout button not found in DOM');
            }
        }
        
        // Setup Modals
        function setupModals() {
            // Transaction Modal
            const transactionModal = document.getElementById('transaction-modal');
            const closeTransactionModal = document.getElementById('close-transaction-modal');
            const closeTransactionDetails = document.getElementById('close-transaction-details');
            
            if (transactionModal) {
                closeTransactionModal.addEventListener('click', () => {
                    transactionModal.style.display = 'none';
                });
                
                closeTransactionDetails.addEventListener('click', () => {
                    transactionModal.style.display = 'none';
                });
            }
        }
        
        // Authentication Check
        onAuthStateChanged(auth, async (user) => {
            console.log('Auth state changed', user ? 'Admin logged in' : 'No user');
            
            if (user) {
                try {
                    // Check if user is an admin
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    
                    if (!userDoc.exists() || userDoc.data().role !== 'admin') {
                        console.log('User is not an admin, redirecting to user dashboard');
                        window.location.href = 'dashboard.html';
                        return;
                    }
                    
                    // Store admin info
                    currentAdmin = user;
                    adminName = userDoc.data().name || user.email.split('@')[0];
                    document.getElementById('admin-email').textContent = user.email;
                    
                    console.log('Admin verified:', adminName);
                    
                    // Initialize the admin dashboard
                    initializeAdminDashboard();
                    
                } catch (error) {
                    console.error('Error checking admin status:', error);
                    alert('Error verifying admin credentials: ' + error.message);
                    signOut(auth);
                }
            } else {
                console.log('No user logged in, redirecting to login page');
                window.location.href = 'login.html';
            }
        });
        
        // Ensure Transaction Modal Exists
        function ensureModalExists() {
            let modal = document.getElementById('transaction-details-modal');
            if (!modal) {
                console.log('Creating transaction details modal');
                modal = document.createElement('div');
                modal.id = 'transaction-details-modal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <button class="close-modal" id="close-transaction-modal"></button>
                        <h2 class="modal-title">Transaction Details</h2>
                        <div id="transaction-details-content"></div>
                        <div class="form-actions">
                            <button class="btn" id="close-transaction-details">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                console.log('Modal appended to body:', modal.outerHTML);
                
                // Set up close handlers
                setupModalCloseHandlers(modal);
                
                // Add click handler to close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal);
                    }
                });
            }
            return modal;
        }

        // Call it during initialization
        document.addEventListener('DOMContentLoaded', ensureModalExists);
        
        // Initialize Admin Dashboard
        async function initializeAdminDashboard() {
            console.log('Initializing admin dashboard');
            
            try {
                // Load platform settings
                await loadPlatformSettings();
                
                // Load all users
                await loadAllUsers();
                
                // Initialize panels
                initializeOverviewPanel();
                initializeClientsPanel();
                initializeTransactionsPanel();
                initializeSettingsPanel();
                initializeLogsPanel();
                
                console.log('Admin dashboard initialized successfully');
            } catch (error) {
                console.error('Error initializing admin dashboard:', error);
                alert('Error loading dashboard: ' + error.message);
            }
        }
        
        // Load Platform Settings
        async function loadPlatformSettings() {
            console.log('Loading platform settings');
            
            try {
                const settingsDoc = await getDoc(doc(db, 'settings', 'platform'));
                
                if (settingsDoc.exists()) {
                    platformSettings = settingsDoc.data();
                } else {
                    // Create default settings if not exists
                    platformSettings = {
                        requireKycWithdrawal: false,
                        notifyLargeTransactions: false,
                        largeTransactionThreshold: 1000,
                        defaultProfitAmount: 10,
                        defaultProfitInterval: 30,
                        btcAddress: '',
                        nowPaymentsLink: '',
                        simplexLink: 'https://buy.simplex.com'
                    };
                    
                    // Save default settings to Firestore
                    await updateDoc(doc(db, 'settings', 'platform'), platformSettings);
                }
                
                console.log('Platform settings loaded:', platformSettings);
                
                // Update settings UI
                updateSettingsUI();
            } catch (error) {
                console.error('Error loading platform settings:', error);
                platformSettings = {};
            }
        }
        
        // Update Settings UI
        function updateSettingsUI() {
            // Set form values based on loaded settings
            const requireKycCheckbox = document.getElementById('require-kyc-withdrawal');
            const notifyLargeCheckbox = document.getElementById('notify-large-transactions');
            const largeThresholdInput = document.getElementById('large-transaction-threshold');
            const defaultProfitAmountInput = document.getElementById('default-profit-amount');
            const defaultProfitIntervalInput = document.getElementById('default-profit-interval');
            const globalBtcAddressInput = document.getElementById('global-btc-address');
            const globalNowpaymentsInput = document.getElementById('global-nowpayments-link');
            const globalSimplexInput = document.getElementById('global-simplex-link');
            
            if (requireKycCheckbox) {
                requireKycCheckbox.checked = platformSettings.requireKycWithdrawal || false;
            }
            
            if (notifyLargeCheckbox) {
                notifyLargeCheckbox.checked = platformSettings.notifyLargeTransactions || false;
            }
            
            if (largeThresholdInput) {
                largeThresholdInput.value = platformSettings.largeTransactionThreshold || 1000;
            }
            
            if (defaultProfitAmountInput) {
                defaultProfitAmountInput.value = platformSettings.defaultProfitAmount || 10;
            }
            
            if (defaultProfitIntervalInput) {
                defaultProfitIntervalInput.value = platformSettings.defaultProfitInterval || 30;
            }
            
            if (globalBtcAddressInput) {
                globalBtcAddressInput.value = platformSettings.btcAddress || '';
            }
            
            if (globalNowpaymentsInput) {
                globalNowpaymentsInput.value = platformSettings.nowPaymentsLink || '';
            }
            
            if (globalSimplexInput) {
                globalSimplexInput.value = platformSettings.simplexLink || 'https://buy.simplex.com';
            }
        }
        
        // Load All Users
        async function loadAllUsers() {
            console.log('Loading all users');
            
            try {
                // Get all non-admin users
                const usersQuery = query(
                    collection(db, 'users'),
                    where('role', '!=', 'admin')
                );
                
                const querySnapshot = await getDocs(usersQuery);
                allUsers = [];
                
                querySnapshot.forEach((doc) => {
                    allUsers.push({
                        uid: doc.id,
                        ...doc.data()
                    });
                });
                
                console.log(`Loaded ${allUsers.length} users`);
                
                // Update platform stats
                updatePlatformStats();
                
                return allUsers;
            } catch (error) {
                console.error('Error loading users:', error);
                throw error;
            }
        }
        
        // Update Platform Stats
        function updatePlatformStats() {
            const totalUsersElement = document.getElementById('total-users');
            const totalBalanceElement = document.getElementById('total-balance');
            const pendingRequestsElement = document.getElementById('pending-requests');
            
            if (totalUsersElement) {
                totalUsersElement.textContent = allUsers.length;
            }
            
            if (totalBalanceElement) {
                // Calculate total platform balance
                const totalBalance = allUsers.reduce((total, user) => {
                    return total + (user.balance || 0);
                }, 0);
                
                totalBalanceElement.textContent = formatCurrency(totalBalance);
            }
            
            if (pendingRequestsElement) {
                // Count pending requests
                let pendingCount = 0;
                
                allUsers.forEach(user => {
                    if (user.history && Array.isArray(user.history)) {
                        pendingCount += user.history.filter(tx => 
                            tx.type && tx.type.includes('request')
                        ).length;
                    }
                });
                
                pendingRequestsElement.textContent = pendingCount;
            }
        }
        
        // Format Timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Unknown date';
            
            try {
                let date;
                if (timestamp.toDate && typeof timestamp.toDate === 'function') {
                    // Handle Firestore Timestamp
                    date = timestamp.toDate();
                } else if (timestamp.seconds) {
                    // Handle Firestore Timestamp object format
                    date = new Date(timestamp.seconds * 1000);
                } else {
                    // Handle regular Date or timestamp
                    date = new Date(timestamp);
                }
                
                if (isNaN(date.getTime())) {
                    throw new Error('Invalid date');
                }
                
                return date.toLocaleString();
            } catch (error) {
                console.error('Error formatting timestamp:', error, timestamp);
                return 'Invalid date';
            }
        }
        
        // Format Currency
        function formatCurrency(value) {
            if (isNaN(value)) return '$0.00';
            
            return '$' + parseFloat(value).toFixed(2);
        }
        
        // Get Transaction Type Label
        function getTransactionTypeLabel(transaction) {
            const type = transaction.type || '';
            
            if (type.includes('deposit_request')) return 'Deposit Request';
            if (type.includes('deposit_approved')) return 'Deposit';
            if (type.includes('deposit_declined')) return 'Deposit (Declined)';
            if (type.includes('withdrawal_request')) return 'Withdrawal Request';
            if (type.includes('withdrawal_approved')) return 'Withdrawal';
            if (type.includes('withdrawal_declined')) return 'Withdrawal (Declined)';
            if (type === 'auto_profit') return 'Auto Profit';
            
            return 'Transaction';
        }
        
        // Get Transaction Status
        function getTransactionStatus(transaction) {
            const type = transaction.type || '';
            
            if (type.includes('request')) return 'pending';
            if (type.includes('approved') || type === 'auto_profit') return 'completed';
            if (type.includes('declined')) return 'failed';
            
            return 'pending';
        }
        
        // Get Status HTML
        function getStatusHTML(status) {
            switch(status) {
                case 'pending':
                    return '<span class="status pending">Pending</span>';
                case 'completed':
                case 'approved':
                    return '<span class="status completed">Completed</span>';
                case 'failed':
                case 'declined':
                    return '<span class="status failed">Failed</span>';
                default:
                    return '<span class="status pending">Processing</span>';
            }
        }
        
        // Log Admin Action
        async function logAdminAction(action) {
            console.log('Logging admin action:', action);
            
            try {
                const logEntry = {
                    admin: currentAdmin.email,
                    adminUid: currentAdmin.uid,
                    action: action,
                    timestamp: serverTimestamp()
                };
                
                await addDoc(collection(db, 'adminLogs'), logEntry);
                console.log('Admin action logged successfully');
                
                // Refresh logs if on logs panel
                if (document.getElementById('logs').classList.contains('active')) {
                    loadAdminLogs();
                }
            } catch (error) {
                console.error('Error logging admin action:', error);
            }
        }// Initialize Overview Panel
        function initializeOverviewPanel() {
            console.log('Initializing overview panel');
            
            // Load transactions first
            loadRecentTransactions();
            loadPendingRequests();
            
            // Add event listeners after a short delay to ensure DOM is updated
            setTimeout(() => {
                console.log('Setting up overview panel event listeners');
                const recentTransactionsContainer = document.getElementById('recent-transactions');
                const pendingTransactionsContainer = document.getElementById('pending-transactions');
                
                if (recentTransactionsContainer) {
                    console.log('Adding listeners to recent transactions');
                    addTransactionViewEventListeners(recentTransactionsContainer);
                }
                
                if (pendingTransactionsContainer) {
                    console.log('Adding listeners to pending transactions');
                    addTransactionViewEventListeners(pendingTransactionsContainer);
                }
            }, 100);
        }
        
        // Load Recent Transactions
        function loadRecentTransactions() {
            const recentTransactionsContainer = document.getElementById('recent-transactions');
            
            if (!recentTransactionsContainer) {
                console.error('Recent transactions container not found');
                return;
            }
            
            // Collect all transactions from all users
            let allTransactions = [];
            
            allUsers.forEach(user => {
                if (user.history && Array.isArray(user.history)) {
                    const userTransactions = user.history.map(tx => ({
                        ...tx,
                        userUid: user.uid,
                        userEmail: user.email,
                        userName: user.name || user.email.split('@')[0]
                    }));
                    
                    allTransactions = [...allTransactions, ...userTransactions];
                }
            });
            
            // Sort by date (most recent first)
            allTransactions.sort((a, b) => {
                const dateA = a.date && a.date.toMillis ? a.date.toMillis() : (a.date ? new Date(a.date).getTime() : 0);
                const dateB = b.date && b.date.toMillis ? b.date.toMillis() : (b.date ? new Date(b.date).getTime() : 0);
                return dateB - dateA;
            });
            
            // Take only the 5 most recent
            const recentTransactions = allTransactions.slice(0, 5);
            
            if (recentTransactions.length === 0) {
                recentTransactionsContainer.innerHTML = '<div class="no-data">No recent transactions found.</div>';
                return;
            }
            
            // Render transactions
            recentTransactionsContainer.innerHTML = '';
            
            recentTransactions.forEach(transaction => {
                const transactionEl = renderTransactionItem(transaction);
                recentTransactionsContainer.appendChild(transactionEl);
            });
        }
        
        // Load Pending Requests
        function loadPendingRequests() {
            console.log('Loading pending requests');
            
            const pendingTransactionsContainer = document.getElementById('pending-transactions');
            
            if (!pendingTransactionsContainer) {
                console.error('Pending transactions container not found');
                return;
            }
            
            // Collect all pending requests from all users
            let pendingRequests = [];
            
            allUsers.forEach(user => {
                if (user.history && Array.isArray(user.history)) {
                    // Filter for pending requests and add user info
                    const userPendingRequests = user.history
                        .filter(tx => tx.type && tx.type.includes('request'))
                        .map(tx => ({
                            ...tx,
                            userUid: user.uid,
                            userEmail: user.email,
                            userName: user.name || user.email.split('@')[0]
                        }));
                    
                    pendingRequests = [...pendingRequests, ...userPendingRequests];
                }
            });
            
            // Sort by date (most recent first)
            pendingRequests.sort((a, b) => {
                const dateA = a.date && a.date.toMillis ? a.date.toMillis() : (a.date ? new Date(a.date).getTime() : 0);
                const dateB = b.date && b.date.toMillis ? b.date.toMillis() : (b.date ? new Date(b.date).getTime() : 0);
                return dateB - dateA;
            });
            
            if (pendingRequests.length === 0) {
                pendingTransactionsContainer.innerHTML = '<div class="no-data">No pending requests found.</div>';
                return;
            }
            
            // Render pending requests
            pendingTransactionsContainer.innerHTML = '';
            
            pendingRequests.forEach(request => {
                const requestEl = renderTransactionItem(request, true);
                pendingTransactionsContainer.appendChild(requestEl);
            });
        }
        
        // Render Transaction Item
            function renderTransactionItem(transaction, showActions = false) {
            // Remove unnecessary transaction log
            const template = document.createElement('template');
            
            // Store transaction data as a JSON string, properly escaped for HTML
            const transactionData = JSON.stringify(transaction).replace(/"/g, '&quot;');
            
            template.innerHTML = `
                <div class="transaction-item" data-transaction='${transactionData}'>
                    <div class="transaction-info">
                        <div class="transaction-type">${getTransactionTypeLabel(transaction)}</div>
                        <div class="transaction-status">${getStatusHTML(getTransactionStatus(transaction))}</div>
                        <div class="transaction-amount">${formatCurrency(transaction.details?.amount || transaction.amount || 0)}</div>
                        <div class="transaction-date">${formatTimestamp(transaction.date) || 'N/A'}</div>
                        <div class="transaction-user">${transaction.userName || transaction.userEmail || 'Unknown'}</div>
                    </div>
                    <div class="transaction-actions">
                        ${transaction.type && transaction.type.includes('request') 
                            ? `<button class="btn btn-sm approve-transaction" data-transaction='${transactionData}' data-id="${transaction.id || ''}" data-uid="${transaction.userUid || ''}">Approve</button>
                               <button class="btn btn-sm btn-outline decline-transaction" data-transaction='${transactionData}' data-id="${transaction.id || ''}" data-uid="${transaction.userUid || ''}">Decline</button>`
                            : `<button class="btn btn-sm view-transaction" data-transaction='${transactionData}'>View</button>`
                        }
                    </div>
                </div>
            `;
            
            const item = template.content.firstElementChild;
            
            // Add click handler for view button
            const viewButton = item.querySelector('.view-transaction');
            if (viewButton) {
                viewButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    try {
                        const transactionData = JSON.parse(e.currentTarget.getAttribute('data-transaction'));
                        showTransactionDetails(transactionData);
                    } catch (error) {
                        console.error('Error parsing transaction data:', error);
                        alert('Error viewing transaction details');
                            }
                        });
                    }
            
            return item;
        }
        
        // Show Transaction Details
            function showTransactionDetails(transaction) {
            const modal = document.getElementById('transaction-details-modal');
            if (!modal) {
                console.error('Transaction modal not found');
                return;
            }
            
            const content = modal.querySelector('#transaction-details-content');
                if (!content) {
                console.error('Transaction details content element not found');
                    return;
                }
                
                if (!transaction) {
                console.error('No transaction data provided');
                    content.innerHTML = '<p>No transaction data available</p>';
                    return;
                }
                
            try {
                let typeText = getTransactionTypeLabel(transaction);
                let statusText = getStatusHTML(getTransactionStatus(transaction));
                let amount = transaction.details?.amount || transaction.amount || 0;
                let dateStr = formatTimestamp(transaction.date);
                
            content.innerHTML = `
                <div class="transaction-detail-row">
                    <div class="transaction-detail-label">Type</div>
                    <div class="transaction-detail-value">${typeText}</div>
                </div>
                <div class="transaction-detail-row">
                    <div class="transaction-detail-label">Status</div>
                    <div class="transaction-detail-value">${statusText}</div>
                </div>
                <div class="transaction-detail-row">
                    <div class="transaction-detail-label">Amount</div>
                        <div class="transaction-detail-value">${formatCurrency(amount)}</div>
                </div>
                <div class="transaction-detail-row">
                    <div class="transaction-detail-label">Date</div>
                    <div class="transaction-detail-value">${dateStr}</div>
                </div>
                <div class="transaction-detail-row">
                    <div class="transaction-detail-label">User</div>
                    <div class="transaction-detail-value">${transaction.userName || transaction.userEmail || 'Unknown'}</div>
                </div>
            `;
            
            // Add additional details if available
            if (transaction.details) {
                if (transaction.details.method) {
                        content.innerHTML += `
                        <div class="transaction-detail-row">
                            <div class="transaction-detail-label">Payment Method</div>
                            <div class="transaction-detail-value">${transaction.details.method}</div>
                        </div>
                    `;
                }
                if (transaction.details.address) {
                        content.innerHTML += `
                        <div class="transaction-detail-row">
                                <div class="transaction-detail-label">Wallet Address</div>
                            <div class="transaction-detail-value">${transaction.details.address}</div>
                        </div>
                    `;
                }
                if (transaction.details.notes) {
                        content.innerHTML += `
                        <div class="transaction-detail-row">
                            <div class="transaction-detail-label">Notes</div>
                            <div class="transaction-detail-value">${transaction.details.notes}</div>
                        </div>
                    `;
                    }
                }
                
                // Show modal
                modal.style.display = 'flex';
                modal.classList.add('show');
                
                // Ensure close buttons work
                const closeButtons = modal.querySelectorAll('.close-modal, #close-transaction-details');
                closeButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        closeModal(modal);
                    });
                });
                
                // Add click-outside handler
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal);
                    }
                });
                
            } catch (error) {
                console.error('Error displaying transaction details:', error);
                content.innerHTML = '<p>Error displaying transaction details</p>';
            }
        }

        // Update close handlers
        function setupModalCloseHandlers(modal) {
            console.log('Setting up modal close handlers');
            const closeButtons = modal.querySelectorAll('.close-modal, #close-transaction-details');
            closeButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    console.log('Close button clicked');
                    e.preventDefault();
                    e.stopPropagation();
                    closeModal(modal);
                });
            });
        }
        
        // Initialize Clients Panel
        function initializeClientsPanel() {
            console.log('Initializing clients panel');
            
            renderClientList();
            
            // Set up client search
            const searchInput = document.getElementById('client-search');
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    const query = searchInput.value.toLowerCase();
                    filterClients(query);
                });
            }
        }
        
        // Render Client List
        function renderClientList() {
            console.log('Rendering client list');
            
            const clientsContainer = document.getElementById('clients-container');
            
            if (!clientsContainer) {
                console.error('Clients container not found');
                return;
            }
            
            if (allUsers.length === 0) {
                clientsContainer.innerHTML = '<div class="no-data">No clients found.</div>';
                return;
            }
            
            // Sort clients by email
            allUsers.sort((a, b) => {
                return (a.email || '').localeCompare(b.email || '');
            });
            
            // Clear container
            clientsContainer.innerHTML = '';
            
            // Render each client
            allUsers.forEach(user => {
                const clientElement = renderClientItem(user);
                clientsContainer.appendChild(clientElement);
            });
            
            // Attach client event listeners
            attachClientListeners();
        }
        
        // Render Client Item
        function renderClientItem(user) {
            const template = document.getElementById('client-template');
            const clone = document.importNode(template.content, true);
            
            // Replace placeholders in template
            const html = clone.firstElementChild.outerHTML
                .replace(/{uid}/g, user.uid || '')
                .replace(/{name}/g, user.name || 'User')
                .replace(/{email}/g, user.email || '')
                .replace(/{balance}/g, user.balance ? user.balance.toFixed(2) : '0.00')
                .replace(/{level}/g, user.accountLevel || 'Basic')
                .replace(/{accountManager}/g, user.accountManager || '')
                .replace(/{nowPaymentsLink}/g, user.nowPaymentsLink || '')
                .replace(/{btcAddress}/g, user.btcAddress || '');
            
            // Create element from HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const clientElement = tempDiv.firstElementChild;
            
            // Set selected values for dropdowns
            setTimeout(() => {
                // Account level
                const accountLevelSelect = clientElement.querySelector(`#account-level-${user.uid}`);
                if (accountLevelSelect) {
                    accountLevelSelect.value = user.accountLevel || 'Basic';
                }
                
                // Account manager
                const accountManagerInput = clientElement.querySelector(`#account-manager-${user.uid}`);
                if (accountManagerInput) {
                    accountManagerInput.value = user.accountManager || '';
                }
                
                // KYC status
                const kycStatusSelect = clientElement.querySelector(`#kyc-status-${user.uid}`);
                if (kycStatusSelect) {
                    kycStatusSelect.value = user.kycStatus || 'unverified';
                }
                
                // KYC reason
                const kycReasonInput = clientElement.querySelector(`#kyc-reason-${user.uid}`);
                if (kycReasonInput) {
                    kycReasonInput.value = user.kycRejectionReason || '';
                }
                
                // Auto-profit settings
                const autoProfitAmountInput = clientElement.querySelector(`#auto-profit-amount-${user.uid}`);
                if (autoProfitAmountInput) {
                    autoProfitAmountInput.value = user.autoProfitAmount || '';
                }
                
                const autoProfitIntervalInput = clientElement.querySelector(`#auto-profit-interval-${user.uid}`);
                if (autoProfitIntervalInput) {
                    autoProfitIntervalInput.value = user.autoProfitInterval || '';
                }
                
                const autoProfitToggleSelect = clientElement.querySelector(`#auto-profit-toggle-${user.uid}`);
                if (autoProfitToggleSelect) {
                    autoProfitToggleSelect.value = user.autoProfitEnabled ? 'enabled' : 'disabled';
                }
                
                // Display KYC image if available
                if (user.kycPhotoBase64) {
                    const kycPreviewContainer = clientElement.querySelector(`#kyc-preview-container-${user.uid}`);
                    if (kycPreviewContainer) {
                        kycPreviewContainer.innerHTML = `
                            <div class="kyc-preview">
                                <img src="${user.kycPhotoBase64}" alt="KYC Document" style="max-width: 100%;">
                            </div>
                        `;
                    }
                }
                
                // Load client transactions
                loadClientTransactions(user.uid);
                
                // Load client chat messages
                loadClientChat(user.uid);
            }, 0);
            
            return clientElement;
        }
        
        // Filter Clients
        function filterClients(query) {
            const clientItems = document.querySelectorAll('.client-item');
            
            clientItems.forEach(item => {
                const name = item.querySelector('.client-name').textContent.toLowerCase();
                const email = item.querySelector('.client-email').textContent.toLowerCase();
                
                if (name.includes(query) || email.includes(query)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // Attach Client Listeners
        function attachClientListeners() {
            console.log('Attaching client listeners');
            
            // Client header toggle
            const clientHeaders = document.querySelectorAll('.client-header');
            clientHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const clientItem = header.closest('.client-item');
                    const clientDetails = clientItem.querySelector('.client-details');
                    clientDetails.classList.toggle('active');
                });
            });
            
            // Update Account button
            const updateAccountBtns = document.querySelectorAll('.update-account');
            updateAccountBtns.forEach(btn => {
                btn.addEventListener('click', handleUpdateAccount);
            });
            
            // Update KYC button
            const updateKycBtns = document.querySelectorAll('.update-kyc');
            updateKycBtns.forEach(btn => {
                btn.addEventListener('click', handleUpdateKyc);
            });
            
            // Update Auto-Profit button
            const updateAutoProfitBtns = document.querySelectorAll('.update-auto-profit');
            updateAutoProfitBtns.forEach(btn => {
                btn.addEventListener('click', handleUpdateAutoProfit);
            });
            
            // Add Warning button
            const addWarningBtns = document.querySelectorAll('.add-warning');
            addWarningBtns.forEach(btn => {
                btn.addEventListener('click', handleAddWarning);
            });

            // Warning visibility toggle
            const warningToggles = document.querySelectorAll('.show-warnings-toggle');
            warningToggles.forEach(toggle => {
                // Set initial state
                const uid = toggle.getAttribute('data-uid');
                const userIndex = allUsers.findIndex(u => u.uid === uid);
                if (userIndex !== -1) {
                    toggle.checked = allUsers[userIndex].showWarnings !== false;
                }
                // Add change listener
                toggle.addEventListener('change', handleWarningToggle);
            });
            
            // Send Message button
            const sendMessageBtns = document.querySelectorAll('.send-message');
            sendMessageBtns.forEach(btn => {
                btn.addEventListener('click', handleSendMessage);
            });
            
            // Update Payment Methods button
            const updatePaymentMethodsBtns = document.querySelectorAll('.update-payment-methods');
            updatePaymentMethodsBtns.forEach(btn => {
                btn.addEventListener('click', updatePaymentMethodsHandler);
            });

            // Update Withdrawal Code button
            const updateWithdrawalCodeBtns = document.querySelectorAll('.update-withdrawal-code');
            updateWithdrawalCodeBtns.forEach(btn => {
                btn.addEventListener('click', handleUpdateWithdrawalCode);
            });
        }
        
        // Update Payment Methods Handler (new)
        async function updatePaymentMethodsHandler(event) {
            const uid = event.target.getAttribute('data-uid');
            
            if (!uid) {
                console.error('No UID provided for payment methods update');
                return;
            }
            
            console.log(`Updating payment methods for user: ${uid}`);
            
            const nowPaymentsInput = document.getElementById(`nowpayments-link-${uid}`);
            const btcAddressInput = document.getElementById(`btc-address-${uid}`);
            
            if (!nowPaymentsInput || !btcAddressInput) {
                console.error('Payment method inputs not found');
                return;
            }
            
            const nowPaymentsLink = nowPaymentsInput.value.trim();
            const btcAddress = btcAddressInput.value.trim();
            
            try {
                // Update user document
                await updateDoc(doc(db, 'users', uid), {
                    nowPaymentsLink,
                    btcAddress
                });
                
                // Log admin action
                await logAdminAction(`Updated payment methods for ${uid}`);
                
                // Update local data
                const userIndex = allUsers.findIndex(u => u.uid === uid);
                if (userIndex !== -1) {
                    allUsers[userIndex].nowPaymentsLink = nowPaymentsLink;
                    allUsers[userIndex].btcAddress = btcAddress;
                }
                
                alert('Payment methods updated successfully');
            } catch (error) {
                console.error('Error updating payment methods:', error);
                alert(`Error updating payment methods: ${error.message}`);
            }
        }
        
        // Handle Update Account
        async function handleUpdateAccount(event) {
            const uid = event.target.getAttribute('data-uid');
            
            if (!uid) {
                console.error('No UID provided for account update');
                return;
            }
            
            console.log(`Updating account for user: ${uid}`);
            
            const accountLevelSelect = document.getElementById(`account-level-${uid}`);
            const balanceInput = document.getElementById(`balance-${uid}`);
            const accountManagerInput = document.getElementById(`account-manager-${uid}`);
            
            if (!accountLevelSelect || !balanceInput || !accountManagerInput) {
                console.error('Account update inputs not found');
                return;
            }
            
            const accountLevel = accountLevelSelect.value;
            const balance = parseFloat(balanceInput.value);
            const accountManager = accountManagerInput.value.trim();
            
            if (isNaN(balance)) {
                alert('Please enter a valid balance');
                return;
            }
            
            try {
                // Get user to check old balance
                const userDoc = await getDoc(doc(db, 'users', uid));
                const oldBalance = userDoc.data().balance || 0;
                
                // Update user document
                await updateDoc(doc(db, 'users', uid), {
                    accountLevel,
                    balance,
                    accountManager
                });
                
                // Log admin action
                await logAdminAction(`Updated account for ${uid}: Level=${accountLevel}, Balance=${balance}, Manager=${accountManager}`);
                
                // If balance changed, add a transaction record
                if (balance !== oldBalance) {
                    const balanceAdjustment = {
                        type: 'balance_adjustment',
                        date: Timestamp.now(),
                        amount: balance - oldBalance,
                        details: {
                            previousBalance: oldBalance,
                            newBalance: balance,
                            adjustedBy: currentAdmin.email,
                            notes: 'Balance adjusted by admin'
                        }
                    };
                    
                    await updateDoc(doc(db, 'users', uid), {
                        history: arrayUnion(balanceAdjustment)
                    });
                    
                    await logAdminAction(`Adjusted balance for ${uid} from ${oldBalance} to ${balance}`);
                }
                
                // Update local data
                const userIndex = allUsers.findIndex(u => u.uid === uid);
                if (userIndex !== -1) {
                    allUsers[userIndex].accountLevel = accountLevel;
                    allUsers[userIndex].balance = balance;
                    allUsers[userIndex].accountManager = accountManager;
                }
                
                alert('Account updated successfully');
                
                // Update platform stats
                updatePlatformStats();
            } catch (error) {
                console.error('Error updating account:', error);
                alert(`Error updating account: ${error.message}`);
            }
        }// Handle Update KYC
        async function handleUpdateKyc(event) {
            const uid = event.target.getAttribute('data-uid');
            
            if (!uid) {
                console.error('No UID provided for KYC update');
                return;
            }
            
            console.log(`Updating KYC status for user: ${uid}`);
            
            const kycStatusSelect = document.getElementById(`kyc-status-${uid}`);
            const kycReasonInput = document.getElementById(`kyc-reason-${uid}`);
            
            if (!kycStatusSelect || !kycReasonInput) {
                console.error('KYC update inputs not found');
                return;
            }
            
            const kycStatus = kycStatusSelect.value;
            const kycRejectionReason = kycReasonInput.value.trim();
            
            // Validate inputs
            if (kycStatus === 'rejected' && !kycRejectionReason) {
                alert('Please provide a reason for KYC rejection');
                return;
            }
            
            try {
                // Prepare update data
                const updateData = {
                    kycStatus
                };
                
                // Add verification date if verified
                if (kycStatus === 'verified') {
                    updateData.kycVerifiedAt = Timestamp.now();
                }
                
                // Add rejection reason if rejected
                if (kycStatus === 'rejected') {
                    updateData.kycRejectionReason = kycRejectionReason;
                }
                
                // Update user document
                await updateDoc(doc(db, 'users', uid), updateData);
                
                // Log admin action
                await logAdminAction(`Updated KYC status for ${uid} to ${kycStatus}`);
                
                // Update local data
                const userIndex = allUsers.findIndex(u => u.uid === uid);
                if (userIndex !== -1) {
                    allUsers[userIndex].kycStatus = kycStatus;
                    if (kycStatus === 'verified') {
                        allUsers[userIndex].kycVerifiedAt = Timestamp.now();
                    }
                    if (kycStatus === 'rejected') {
                        allUsers[userIndex].kycRejectionReason = kycRejectionReason;
                    }
                }
                
                alert('KYC status updated successfully');
            } catch (error) {
                console.error('Error updating KYC status:', error);
                alert(`Error updating KYC status: ${error.message}`);
            }
        }
        
        // Handle Update Auto-Profit
        async function handleUpdateAutoProfit(event) {
            const uid = event.target.getAttribute('data-uid');
            
            if (!uid) {
                console.error('No UID provided for auto-profit update');
                return;
            }
            
            console.log(`Updating auto-profit settings for user: ${uid}`);
            
            const amountInput = document.getElementById(`auto-profit-amount-${uid}`);
            const intervalInput = document.getElementById(`auto-profit-interval-${uid}`);
            const toggleSelect = document.getElementById(`auto-profit-toggle-${uid}`);
            const blockSelect = document.getElementById(`auto-trade-block-${uid}`);
            
            if (!amountInput || !intervalInput || !toggleSelect || !blockSelect) {
                console.error('Auto-profit update inputs not found');
                return;
            }
            
            const amount = parseFloat(amountInput.value);
            const interval = parseInt(intervalInput.value, 10);
            const isEnabled = toggleSelect.value === 'enabled';
            const isBlocked = blockSelect.value === 'blocked';
            
            // Validate inputs
            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid profit amount');
                return;
            }
            
            if (isNaN(interval) || interval < 10) {
                alert('Interval must be at least 10 minutes');
                return;
            }
            
            try {
                // Update user document
                await updateDoc(doc(db, 'users', uid), {
                    autoProfitEnabled: isEnabled && !isBlocked, // Disable if blocked
                    adminSetAmount: amount,
                    adminSetInterval: interval,
                    autoTradeBlocked: isBlocked,
                    lastAutoTradeDate: (isEnabled && !isBlocked) ? serverTimestamp() : null
                });
                
                // Log admin action
                await logAdminAction(`Updated auto-profit for ${uid}: Enabled=${isEnabled}, Amount=${amount}, Interval=${interval}, Blocked=${isBlocked}`);
                
                // Update local data
                const userIndex = allUsers.findIndex(u => u.uid === uid);
                if (userIndex !== -1) {
                    allUsers[userIndex].autoProfitEnabled = isEnabled && !isBlocked;
                    allUsers[userIndex].adminSetAmount = amount;
                    allUsers[userIndex].adminSetInterval = interval;
                    allUsers[userIndex].autoTradeBlocked = isBlocked;
                }
                
                alert('Auto-profit settings updated successfully');
            } catch (error) {
                console.error('Error updating auto-profit settings:', error);
                alert(`Error updating auto-profit settings: ${error.message}`);
            }
        }
        
        // Handle Show Warning Modal
        function handleShowWarningModal(event) {
            const uid = event.target.getAttribute('data-uid');
            
            if (!uid) {
                console.error('No UID provided for warning');
                return;
            }
            
            console.log(`Showing warning modal for user: ${uid}`);
            
            const warningModal = document.getElementById('warning-modal');
            const warningMessage = document.getElementById('warning-message');
            const warningUserId = document.getElementById('warning-user-id');
            
            if (!warningModal || !warningMessage || !warningUserId) {
                console.error('Warning modal elements not found');
                return;
            }
            
            // Reset form
            warningMessage.value = '';
            warningUserId.value = uid;
            
            // Show modal
            warningModal.style.display = 'flex';
        }
        
        // Handle Add Warning
        async function handleAddWarning(event) {
            const uid = event.target.getAttribute('data-uid');
            if (!uid) {
                console.error('No UID provided for warning');
                return;
            }

            const warningMessage = document.getElementById(`warning-message-${uid}`);
            if (!warningMessage) {
                console.error('Warning message input not found');
                return;
            }
            
            const message = warningMessage.value.trim();
            if (!message) {
                alert('Please enter a warning message');
                return;
            }
            
            try {
                // Create warning object
                const warning = {
                    message,
                    timestamp: Timestamp.now(),
                    read: false,
                    from: currentAdmin.email
                };
                
                // Update user document
                await updateDoc(doc(db, 'users', uid), {
                    warnings: arrayUnion(warning)
                });
                
                // Log admin action
                await logAdminAction(`Added warning for ${uid}: ${message}`);
                
                // Update local data
                const userIndex = allUsers.findIndex(u => u.uid === uid);
                if (userIndex !== -1) {
                    if (!allUsers[userIndex].warnings) {
                        allUsers[userIndex].warnings = [];
                    }
                    allUsers[userIndex].warnings.push(warning);
                }
                
                // Clear input
                warningMessage.value = '';
                
                alert('Warning added successfully');
            } catch (error) {
                console.error('Error adding warning:', error);
                alert(`Error adding warning: ${error.message}`);
            }
        }

        // Handle Warning Toggle
        async function handleWarningToggle(event) {
            const uid = event.target.getAttribute('data-uid');
            const isChecked = event.target.checked;

            if (!uid) {
                console.error('No UID provided for warning toggle');
                return;
            }

            try {
                // Update user document
                await updateDoc(doc(db, 'users', uid), {
                    showWarnings: isChecked
                });

                // Log admin action
                await logAdminAction(`${isChecked ? 'Enabled' : 'Disabled'} warnings for ${uid}`);

                // Update local data
                const userIndex = allUsers.findIndex(u => u.uid === uid);
                if (userIndex !== -1) {
                    allUsers[userIndex].showWarnings = isChecked;
                }

                console.log(`Warnings ${isChecked ? 'enabled' : 'disabled'} for user ${uid}`);
            } catch (error) {
                console.error('Error updating warning visibility:', error);
                alert(`Error updating warning visibility: ${error.message}`);
                // Revert toggle state
                event.target.checked = !isChecked;
            }
        }
        
        // Handle Send Message
        async function handleSendMessage(event) {
            const uid = event.target.getAttribute('data-uid');
            
            if (!uid) {
                console.error('No UID provided for message');
                return;
            }
            
            console.log(`Sending message to user: ${uid}`);
            
            const messageInput = document.getElementById(`chat-message-${uid}`);
            
            if (!messageInput) {
                console.error('Message input not found');
                return;
            }
            
            const message = messageInput.value.trim();
            
            if (!message) {
                alert('Please enter a message');
                return;
            }
            
            try {
                // Create message object
                const chatMessage = {
                    message,
                    sender: 'admin',
                    timestamp: Timestamp.now()
                };
                
                // Update user document
                await updateDoc(doc(db, 'users', uid), {
                    messages: arrayUnion(chatMessage)
                });
                
                // Log admin action
                await logAdminAction(`Sent message to ${uid}`);
                
                // Update local data
                const userIndex = allUsers.findIndex(u => u.uid === uid);
                if (userIndex !== -1) {
                    if (!allUsers[userIndex].messages) {
                        allUsers[userIndex].messages = [];
                    }
                    allUsers[userIndex].messages.push(chatMessage);
                }
                
                // Clear input
                messageInput.value = '';
                
                // Reload chat
                loadClientChat(uid);
                
                alert('Message sent successfully');
            } catch (error) {
                console.error('Error sending message:', error);
                alert(`Error sending message: ${error.message}`);
            }
        }
        
        // Load Client Transactions
        function loadClientTransactions(uid) {
            console.log(`Loading transactions for user: ${uid}`);
            
            const transactionsContainer = document.getElementById(`client-transactions-${uid}`);
            
            if (!transactionsContainer) {
                console.error(`Transactions container for user ${uid} not found`);
                return;
            }
            
            // Find user
            const user = allUsers.find(u => u.uid === uid);
            
            if (!user || !user.history || user.history.length === 0) {
                transactionsContainer.innerHTML = '<div class="no-data">No transactions found</div>';
                return;
            }
            
            // Sort by date (most recent first)
            const transactions = [...user.history].sort((a, b) => {
                const dateA = a.date && a.date.toMillis ? a.date.toMillis() : (a.date ? new Date(a.date).getTime() : 0);
                const dateB = b.date && b.date.toMillis ? b.date.toMillis() : (b.date ? new Date(b.date).getTime() : 0);
                return dateB - dateA;
            });
            
            // Limit to recent 5
            const recentTransactions = transactions.slice(0, 5);
            
            // Render transactions
            transactionsContainer.innerHTML = '';
            
            recentTransactions.forEach((transaction, index) => {
                const transactionEl = renderClientTransaction(transaction, uid);
                transactionsContainer.appendChild(transactionEl);
            });
        }
        
        // Render Client Transaction
        function renderClientTransaction(transaction, uid) {
            const template = document.getElementById('client-transaction-template');
            const clone = document.importNode(template.content, true);
            
            // Get necessary elements
            const transactionItem = clone.querySelector('.client-transaction');
            const typeEl = clone.querySelector('.transaction-type');
            const amountEl = clone.querySelector('.transaction-amount');
            const statusEl = clone.querySelector('.transaction-status');
            const dateEl = clone.querySelector('.transaction-date');
            const actionsEl = clone.querySelector('.transaction-actions');
            
            // Set transaction ID
            transactionItem.setAttribute('data-id', transaction.id || '');
            
            // Set type
            typeEl.textContent = getTransactionTypeLabel(transaction);
            
            // Set amount
            const amount = transaction.details && transaction.details.amount 
                ? transaction.details.amount 
                : transaction.amount || 0;
            
            amountEl.textContent = formatCurrency(amount);
            
            // Set status
            const status = getTransactionStatus(transaction);
            statusEl.innerHTML = getStatusHTML(status);
            
            // Set date
            dateEl.textContent = formatTimestamp(transaction.date);
            
            // Set actions
            let actionsHTML = '';
            
            if (transaction.type === 'deposit_request') {
                actionsHTML = `
                    <button class="btn btn-sm approve-transaction" data-id="${transaction.id || ''}" data-uid="${uid}">Approve</button>
                    <button class="btn btn-sm btn-outline decline-transaction" data-id="${transaction.id || ''}" data-uid="${uid}">Decline</button>
                `;
            } else if (transaction.type === 'withdrawal_request') {
                actionsHTML = `
                    <button class="btn btn-sm approve-transaction" data-id="${transaction.id || ''}" data-uid="${uid}">Approve</button>
                    <button class="btn btn-sm btn-outline decline-transaction" data-id="${transaction.id || ''}" data-uid="${uid}">Decline</button>
                `;
            } else {
                actionsHTML = `
                    <button class="btn btn-sm view-transaction" data-id="${transaction.id || ''}" data-uid="${uid}">View</button>
                `;
            }
            
            actionsEl.innerHTML = actionsHTML;
            
            // Add transaction data for easier access
            transactionItem.dataset.transaction = JSON.stringify({
                ...transaction,
                userUid: uid
            });
            
            // Add event listeners
            setTimeout(() => {
                const approveBtn = transactionItem.querySelector('.approve-transaction');
                const declineBtn = transactionItem.querySelector('.decline-transaction');
                const viewBtn = transactionItem.querySelector('.view-transaction');
                
                if (approveBtn) {
                    approveBtn.addEventListener('click', function() {
                        const data = JSON.parse(transactionItem.dataset.transaction);
                        handleApproveTransaction(data);
                    });
                }
                
                if (declineBtn) {
                    declineBtn.addEventListener('click', function() {
                        const data = JSON.parse(transactionItem.dataset.transaction);
                        handleDeclineTransaction(data);
                    });
                }
                
                if (viewBtn) {
                    viewBtn.addEventListener('click', function() {
                        const data = JSON.parse(transactionItem.dataset.transaction);
                        data.userUid = uid; // Ensure userUid is set
                        showTransactionDetails(data);
                    });
                }
            }, 0);
            
            return clone;
        }
        
        // Load Client Chat
        function loadClientChat(uid) {
            console.log(`Loading chat for user: ${uid}`);
            
            const chatContainer = document.getElementById(`client-chat-${uid}`);
            
            if (!chatContainer) {
                console.error(`Chat container for user ${uid} not found`);
                return;
            }
            
            // Find user
            const user = allUsers.find(u => u.uid === uid);
            
            if (!user || !user.messages || user.messages.length === 0) {
                // Just keep the chat input and button
                return;
            }
            
            // Sort messages by date
            const messages = [...user.messages].sort((a, b) => {
                const dateA = a.timestamp && a.timestamp.toMillis ? a.timestamp.toMillis() : (a.timestamp ? new Date(a.timestamp).getTime() : 0);
                const dateB = b.timestamp && b.timestamp.toMillis ? b.timestamp.toMillis() : (b.timestamp ? new Date(b.timestamp).getTime() : 0);
                return dateA - dateB;
            });
            
            // Create chat history element if it doesn't exist
            let chatHistory = chatContainer.querySelector('.chat-history');
            if (!chatHistory) {
                chatHistory = document.createElement('div');
                chatHistory.className = 'chat-history';
                chatContainer.insertBefore(chatHistory, chatContainer.firstChild);
            }
            
            // Render messages
            chatHistory.innerHTML = messages.map(message => {
                const isAdmin = message.sender === 'admin';
                const isUser = message.sender === 'user';
                
                // Format time
                let timeStr = '';
                if (message.timestamp) {
                    const timestamp = message.timestamp.toDate 
                        ? message.timestamp.toDate() 
                        : new Date(message.timestamp);
                    timeStr = timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }
                
                return `
                    <div class="chat-message ${isAdmin ? 'admin' : 'user'}">
                        <div class="chat-sender">${isAdmin ? 'Admin' : 'User'}</div>
                        <div class="chat-message-content">
                            ${message.message}
                        </div>
                        <div class="chat-message-time">${timeStr}</div>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        // Handle Approve Transaction
        async function handleApproveTransaction(transaction) {
            if (!transaction || !transaction.userUid) {
                console.error('Transaction data incomplete');
                return;
            }
            
            const uid = transaction.userUid;
            const type = transaction.type;
            
            console.log(`Approving transaction for user: ${uid}, type: ${type}`);
            
            if (!type || !type.includes('request')) {
                console.error('Not a request transaction');
                return;
            }
            
            try {
                // Get user to update
                const userDoc = await getDoc(doc(db, 'users', uid));
                const userData = userDoc.data();
                const userHistory = userData.history || [];
                
                // Find transaction in history
                const txIndex = userHistory.findIndex(tx => 
                    tx.type === type && 
                    tx.date && 
                    transaction.date && 
                    (tx.date.seconds === transaction.date.seconds || 
                     tx.date.toMillis && transaction.date.toMillis && 
                     tx.date.toMillis() === transaction.date.toMillis())
                );
                
                if (txIndex === -1) {
                    console.error('Transaction not found in user history');
                    alert('Transaction not found in user history');
                    return;
                }
                
                // Get amount
                const amount = transaction.details && transaction.details.amount 
                    ? parseFloat(transaction.details.amount) 
                    : parseFloat(transaction.amount) || 0;
                
                // Determine new transaction type and update balance
                let newType = '';
                let newBalance = userData.balance || 0;
                
                if (type === 'deposit_request') {
                    newType = 'deposit_approved';
                    newBalance += amount;
                } else if (type === 'withdrawal_request') {
                    newType = 'withdrawal_approved';
                    newBalance -= amount;
                    
                    // Check if balance would go negative
                    if (newBalance < 0) {
                        alert('Cannot approve withdrawal: Insufficient user balance');
                        return;
                    }
                } else {
                    console.error('Unknown request type');
                    alert('Unknown request type');
                    return;
                }
                
                // Create new transaction with approved status
                const approvedTransaction = {
                    ...userHistory[txIndex],
                    type: newType,
                    approvedAt: Timestamp.now(),
                    approvedBy: currentAdmin.email,
                    details: {
                        ...userHistory[txIndex].details,
                        previousBalance: userData.balance,
                        newBalance: newBalance
                    }
                };
                
                // Remove old transaction and add new one
                userHistory.splice(txIndex, 1);
                userHistory.push(approvedTransaction);
                
                // Update user document
                await updateDoc(doc(db, 'users', uid), {
                    history: userHistory,
                    balance: newBalance
                });
                
                // Log admin action
                await logAdminAction(`Approved ${type} for ${uid}, amount: ${amount}`);
                
                // Update local data
                const userIndex = allUsers.findIndex(u => u.uid === uid);
                if (userIndex !== -1) {
                    allUsers[userIndex].history = userHistory;
                    allUsers[userIndex].balance = newBalance;
                }
                
                alert('Transaction approved successfully');
                
                // Refresh UI
                loadRecentTransactions();
                loadPendingRequests();
                loadClientTransactions(uid);
                updatePlatformStats();
                
                // If in transactions panel, refresh that too
                if (document.getElementById('transactions').classList.contains('active')) {
                    loadAllTransactionsData();
                }
            } catch (error) {
                console.error('Error approving transaction:', error);
                alert(`Error approving transaction: ${error.message}`);
            }
        }// Handle Decline Transaction
        async function handleDeclineTransaction(transaction) {
            if (!transaction || !transaction.userUid) {
                console.error('Transaction data incomplete');
                return;
            }
            
            const uid = transaction.userUid;
            const type = transaction.type;
            
            console.log(`Declining transaction for user: ${uid}, type: ${type}`);
            
            if (!type || !type.includes('request')) {
                console.error('Not a request transaction');
                return;
            }
            
            try {
                // Get user to update
                const userDoc = await getDoc(doc(db, 'users', uid));
                const userData = userDoc.data();
                const userHistory = userData.history || [];
                
                // Find transaction in history
                const txIndex = userHistory.findIndex(tx => 
                    tx.type === type && 
                    tx.date && 
                    transaction.date && 
                    (tx.date.seconds === transaction.date.seconds || 
                     tx.date.toMillis && transaction.date.toMillis && 
                     tx.date.toMillis() === transaction.date.toMillis())
                );
                
                if (txIndex === -1) {
                    console.error('Transaction not found in user history');
                    alert('Transaction not found in user history');
                    return;
                }
                
                // Determine new transaction type
                let newType = '';
                
                if (type === 'deposit_request') {
                    newType = 'deposit_declined';
                } else if (type === 'withdrawal_request') {
                    newType = 'withdrawal_declined';
                } else {
                    console.error('Unknown request type');
                    alert('Unknown request type');
                    return;
                }
                
                // Create new transaction with declined status
                const declinedTransaction = {
                    ...userHistory[txIndex],
                    type: newType,
                    declinedAt: Timestamp.now(),
                    declinedBy: currentAdmin.email,
                    details: {
                        ...userHistory[txIndex].details,
                        reason: 'Declined by admin'
                    }
                };
                
                // Remove old transaction and add new one
                userHistory.splice(txIndex, 1);
                userHistory.push(declinedTransaction);
                
                // Update user document
                await updateDoc(doc(db, 'users', uid), {
                    history: userHistory
                });
                
                // Log admin action
                await logAdminAction(`Declined ${type} for ${uid}`);
                
                // Update local data
                const userIndex = allUsers.findIndex(u => u.uid === uid);
                if (userIndex !== -1) {
                    allUsers[userIndex].history = userHistory;
                }
                
                alert('Transaction declined successfully');
                
                // Refresh UI
                loadRecentTransactions();
                loadPendingRequests();
                loadClientTransactions(uid);
                
                // If in transactions panel, refresh that too
                if (document.getElementById('transactions').classList.contains('active')) {
                    loadAllTransactionsData();
                }
            } catch (error) {
                console.error('Error declining transaction:', error);
                alert(`Error declining transaction: ${error.message}`);
            }
        }
        
        // Initialize Transactions Panel
        function initializeTransactionsPanel() {
            console.log('Initializing transactions panel');
            
            // Load transactions first
            loadAllTransactionsData();
            
            // Add event listeners after a short delay to ensure DOM is updated
            setTimeout(() => {
                console.log('Setting up transactions panel event listeners');
                const allTransactionsContainer = document.getElementById('all-transactions');
                
                if (allTransactionsContainer) {
                    console.log('Adding listeners to all transactions');
                    addTransactionViewEventListeners(allTransactionsContainer);
                }
            
            // Set up transaction filters
            const typeFilter = document.getElementById('transaction-type-filter');
            const statusFilter = document.getElementById('transaction-status-filter');
            
            if (typeFilter && statusFilter) {
                    typeFilter.addEventListener('change', () => {
                        filterTransactions();
                        // Re-add event listeners after filtering
                        setTimeout(() => addTransactionViewEventListeners(allTransactionsContainer), 100);
                    });
                    
                    statusFilter.addEventListener('change', () => {
                        filterTransactions();
                        // Re-add event listeners after filtering
                        setTimeout(() => addTransactionViewEventListeners(allTransactionsContainer), 100);
                    });
                }
            }, 100);
        }
        
        // Load All Transactions Data
        function loadAllTransactionsData() {
            console.log('Loading all transactions data');
            
            const transactionsContainer = document.getElementById('all-transactions');
            
            if (!transactionsContainer) {
                console.error('All transactions container not found');
                return;
            }
            
            // Collect all transactions from all users
            let allTransactions = [];
            
            allUsers.forEach(user => {
                if (user.history && Array.isArray(user.history)) {
                    // Add user info to each transaction
                    const userTransactions = user.history.map(tx => ({
                        ...tx,
                        userUid: user.uid,
                        userEmail: user.email,
                        userName: user.name || user.email.split('@')[0]
                    }));
                    
                    allTransactions = [...allTransactions, ...userTransactions];
                }
            });
            
            // Sort by date (most recent first)
            allTransactions.sort((a, b) => {
                const dateA = a.date && a.date.toMillis ? a.date.toMillis() : (a.date ? new Date(a.date).getTime() : 0);
                const dateB = b.date && b.date.toMillis ? b.date.toMillis() : (b.date ? new Date(b.date).getTime() : 0);
                return dateB - dateA;
            });
            
            // Store in window object for filtering
            window.allTransactionsData = allTransactions;
            
            // Apply current filters and re-attach event listeners
            filterTransactions();
            
            // Re-attach event listeners after rendering
            console.log('Re-attaching event listeners to transactions container');
            addTransactionViewEventListeners(transactionsContainer);
        }
        
        // Filter Transactions
        function filterTransactions() {
            console.log('Filtering transactions');
            
            const transactionsContainer = document.getElementById('all-transactions');
            const typeFilter = document.getElementById('transaction-type-filter');
            const statusFilter = document.getElementById('transaction-status-filter');
            
            if (!transactionsContainer || !typeFilter || !statusFilter || !window.allTransactionsData) {
                console.error('Transaction filter elements or data not found');
                return;
            }
            
            const typeValue = typeFilter.value;
            const statusValue = statusFilter.value;
            
            // Apply filters
            let filteredTransactions = window.allTransactionsData;
            
            // Filter by type
            if (typeValue !== 'all') {
                filteredTransactions = filteredTransactions.filter(tx => {
                    if (typeValue === 'deposit') {
                        return tx.type && tx.type.includes('deposit');
                    } else if (typeValue === 'withdrawal') {
                        return tx.type && tx.type.includes('withdrawal');
                    } else if (typeValue === 'auto_profit') {
                        return tx.type === 'auto_profit';
                    }
                    return true;
                });
            }
            
            // Filter by status
            if (statusValue !== 'all') {
                filteredTransactions = filteredTransactions.filter(tx => {
                    if (statusValue === 'pending') {
                        return tx.type && tx.type.includes('request');
                    } else if (statusValue === 'completed') {
                        return (tx.type && tx.type.includes('approved')) || tx.type === 'auto_profit';
                    } else if (statusValue === 'failed') {
                        return tx.type && tx.type.includes('declined');
                    }
                    return true;
                });
            }
            
            // Render filtered transactions
            if (filteredTransactions.length === 0) {
                transactionsContainer.innerHTML = '<div class="no-data">No transactions match the selected filters</div>';
                return;
            }
            
            transactionsContainer.innerHTML = '';
            
            filteredTransactions.forEach(transaction => {
                const transactionEl = renderTransactionItem(transaction, statusValue === 'pending');
                transactionsContainer.appendChild(transactionEl);
            });
            
            // Add event listeners to view buttons after rendering
            addTransactionViewEventListeners(transactionsContainer);
        }
        
        // Initialize Settings Panel
        function initializeSettingsPanel() {
            console.log('Initializing settings panel');
            
            // Set up event listeners for saving settings
            setupSettingsListeners();
        }
        
        // Setup Settings Listeners
        function setupSettingsListeners() {
            // Security settings
            const saveSecurityBtn = document.getElementById('save-security-settings');
            if (saveSecurityBtn) {
                saveSecurityBtn.addEventListener('click', saveSecuritySettings);
            }
            
            // Bitcoin address
            const saveBtcAddressBtn = document.getElementById('save-btc-address');
            if (saveBtcAddressBtn) {
                saveBtcAddressBtn.addEventListener('click', saveBtcAddress);
            }
            
            // NOWPayments link
            const saveNowPaymentsBtn = document.getElementById('save-nowpayments-link');
            if (saveNowPaymentsBtn) {
                saveNowPaymentsBtn.addEventListener('click', saveNowPaymentsLink);
            }
            
            // Simplex link
            const saveSimplexBtn = document.getElementById('save-simplex-link');
            if (saveSimplexBtn) {
                saveSimplexBtn.addEventListener('click', saveSimplexLink);
            }
            
            // Default profit amount
            const saveProfitAmountBtn = document.getElementById('save-profit-amount');
            if (saveProfitAmountBtn) {
                saveProfitAmountBtn.addEventListener('click', saveDefaultProfitAmount);
            }
            
            // Default profit interval
            const saveProfitIntervalBtn = document.getElementById('save-profit-interval');
            if (saveProfitIntervalBtn) {
                saveProfitIntervalBtn.addEventListener('click', saveDefaultProfitInterval);
            }
        }
        
        // Save Security Settings
        async function saveSecuritySettings() {
            console.log('Saving security settings');
            
            const requireKycCheckbox = document.getElementById('require-kyc-withdrawal');
            const notifyLargeCheckbox = document.getElementById('notify-large-transactions');
            const largeThresholdInput = document.getElementById('large-transaction-threshold');
            
            if (!requireKycCheckbox || !notifyLargeCheckbox || !largeThresholdInput) {
                console.error('Security settings elements not found');
                return;
            }
            
            const requireKyc = requireKycCheckbox.checked;
            const notifyLarge = notifyLargeCheckbox.checked;
            const largeThreshold = parseFloat(largeThresholdInput.value);
            
            if (notifyLarge && (isNaN(largeThreshold) || largeThreshold <= 0)) {
                alert('Please enter a valid threshold amount');
                return;
            }
            
            try {
                // Update settings document
                await updateDoc(doc(db, 'settings', 'platform'), {
                    requireKycWithdrawal: requireKyc,
                    notifyLargeTransactions: notifyLarge,
                    largeTransactionThreshold: largeThreshold
                });
                
                // Update local settings
                platformSettings.requireKycWithdrawal = requireKyc;
                platformSettings.notifyLargeTransactions = notifyLarge;
                platformSettings.largeTransactionThreshold = largeThreshold;
                
                // Log admin action
                await logAdminAction('Updated security settings');
                
                alert('Security settings saved successfully');
            } catch (error) {
                console.error('Error saving security settings:', error);
                alert(`Error saving security settings: ${error.message}`);
            }
        }
        
        // Save BTC Address
        async function saveBtcAddress() {
            console.log('Saving BTC address');
            
            const btcAddressInput = document.getElementById('global-btc-address');
            
            if (!btcAddressInput) {
                console.error('BTC address input not found');
                return;
            }
            
            const btcAddress = btcAddressInput.value.trim();
            
            if (!btcAddress) {
                alert('Please enter a valid BTC address');
                return;
            }
            
            try {
                // Get all non-admin users
                const usersQuery = query(
                    collection(db, 'users'),
                    where('role', '!=', 'admin')
                );
                
                const querySnapshot = await getDocs(usersQuery);
                const batch = writeBatch(db);
                
                // Update each user's document
                querySnapshot.forEach((userDoc) => {
                    batch.update(userDoc.ref, {
                        paymentSettings: {
                            btcAddress: btcAddress,
                            nowPaymentsLink: userDoc.data()?.paymentSettings?.nowPaymentsLink || '',
                            simplexLink: userDoc.data()?.paymentSettings?.simplexLink || ''
                        }
                    });
                });
                
                await batch.commit();
                
                // Log admin action
                await logAdminAction('Updated global BTC address');
                
                alert('BTC address saved and updated for all users successfully');
            } catch (error) {
                console.error('Error saving BTC address:', error);
                alert(`Error saving BTC address: ${error.message}`);
            }
        }
        
        // Save NOWPayments Link
        async function saveNowPaymentsLink() {
            console.log('Saving NOWPayments link');
            
            const nowPaymentsInput = document.getElementById('global-nowpayments-link');
            
            if (!nowPaymentsInput) {
                console.error('NOWPayments input not found');
                return;
            }
            
            const nowPaymentsLink = nowPaymentsInput.value.trim();
            
            if (!nowPaymentsLink) {
                alert('Please enter a valid NOWPayments link');
                return;
            }
            
            try {
                // Get all non-admin users
                const usersQuery = query(
                    collection(db, 'users'),
                    where('role', '!=', 'admin')
                );
                
                const querySnapshot = await getDocs(usersQuery);
                const batch = writeBatch(db);
                
                // Update each user's document
                querySnapshot.forEach((userDoc) => {
                    batch.update(userDoc.ref, {
                        paymentSettings: {
                            btcAddress: userDoc.data()?.paymentSettings?.btcAddress || '',
                            nowPaymentsLink: nowPaymentsLink,
                            simplexLink: userDoc.data()?.paymentSettings?.simplexLink || ''
                        }
                    });
                });
                
                await batch.commit();
                
                // Log admin action
                await logAdminAction('Updated global NOWPayments link');
                
                alert('NOWPayments link saved and updated for all users successfully');
            } catch (error) {
                console.error('Error saving NOWPayments link:', error);
                alert(`Error saving NOWPayments link: ${error.message}`);
            }
        }
        
        // Save Simplex Link
        async function saveSimplexLink() {
            console.log('Saving Simplex link');
            
            const simplexInput = document.getElementById('global-simplex-link');
            
            if (!simplexInput) {
                console.error('Simplex input not found');
                return;
            }
            
            const simplexLink = simplexInput.value.trim();
            
            if (!simplexLink) {
                alert('Please enter a valid Simplex link');
                return;
            }
            
            try {
                // Get all non-admin users
                const usersQuery = query(
                    collection(db, 'users'),
                    where('role', '!=', 'admin')
                );
                
                const querySnapshot = await getDocs(usersQuery);
                const batch = writeBatch(db);
                
                // Update each user's document
                querySnapshot.forEach((userDoc) => {
                    batch.update(userDoc.ref, {
                        paymentSettings: {
                            btcAddress: userDoc.data()?.paymentSettings?.btcAddress || '',
                            nowPaymentsLink: userDoc.data()?.paymentSettings?.nowPaymentsLink || '',
                    simplexLink: simplexLink
                        }
                    });
                });
                
                await batch.commit();
                
                // Log admin action
                await logAdminAction('Updated global Simplex link');
                
                alert('Simplex link saved and updated for all users successfully');
            } catch (error) {
                console.error('Error saving Simplex link:', error);
                alert(`Error saving Simplex link: ${error.message}`);
            }
        }
        
        // Save Default Profit Amount
        async function saveDefaultProfitAmount() {
            console.log('Saving default profit amount');
            
            const amountInput = document.getElementById('default-profit-amount');
            
            if (!amountInput) {
                console.error('Profit amount input not found');
                return;
            }
            
            const amount = parseFloat(amountInput.value);
            
            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid profit amount');
                return;
            }
            
            try {
                // Update settings document
                await updateDoc(doc(db, 'settings', 'platform'), {
                    defaultProfitAmount: amount
                });
                
                // Update local settings
                platformSettings.defaultProfitAmount = amount;
                
                // Log admin action
                await logAdminAction('Updated default profit amount');
                
                alert('Default profit amount saved successfully');
            } catch (error) {
                console.error('Error saving default profit amount:', error);
                alert(`Error saving default profit amount: ${error.message}`);
            }
        }
        
        // Save Default Profit Interval
        async function saveDefaultProfitInterval() {
            console.log('Saving default profit interval');
            
            const intervalInput = document.getElementById('default-profit-interval');
            
            if (!intervalInput) {
                console.error('Profit interval input not found');
                return;
            }
            
            const interval = parseInt(intervalInput.value, 10);
            
            if (isNaN(interval) || interval < 10) {
                alert('Please enter a valid profit interval (min 10 minutes)');
                return;
            }
            
            try {
                // Update settings document
                await updateDoc(doc(db, 'settings', 'platform'), {
                    defaultProfitInterval: interval
                });
                
                // Update local settings
                platformSettings.defaultProfitInterval = interval;
                
                // Log admin action
                await logAdminAction('Updated default profit interval');
                
                alert('Default profit interval saved successfully');
            } catch (error) {
                console.error('Error saving default profit interval:', error);
                alert(`Error saving default profit interval: ${error.message}`);
            }
        }// Initialize Logs Panel
        function initializeLogsPanel() {
            console.log('Initializing logs panel');
            
            loadAdminLogs();
            
            // Set up refresh button
            const refreshBtn = document.getElementById('refresh-logs');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', loadAdminLogs);
            }
        }
        
        // Load Admin Logs
        async function loadAdminLogs() {
            console.log('Loading admin logs');
            
            const logsContainer = document.getElementById('admin-logs');
            
            if (!logsContainer) {
                console.error('Admin logs container not found');
                return;
            }
            
            // Set loading state
            logsContainer.innerHTML = '<div class="no-data">Loading logs...</div>';
            
            try {
                // Get logs from Firestore, ordered by timestamp (latest first)
                const logsQuery = query(
                    collection(db, 'adminLogs'),
                    orderBy('timestamp', 'desc'),
                    // Limit to the most recent 100 logs
                    // limit(100)
                );
                
                const querySnapshot = await getDocs(logsQuery);
                
                if (querySnapshot.empty) {
                    logsContainer.innerHTML = '<div class="no-data">No admin logs found</div>';
                    return;
                }
                
                // Clear container
                logsContainer.innerHTML = '';
                
                // Render each log entry
                querySnapshot.forEach(doc => {
                    const log = doc.data();
                    const logElement = renderLogEntry(log);
                    logsContainer.appendChild(logElement);
                });
            } catch (error) {
                console.error('Error loading admin logs:', error);
                logsContainer.innerHTML = `<div class="no-data">Error loading logs: ${error.message}</div>`;
            }
        }
        
        // Render Log Entry
        function renderLogEntry(log) {
            const template = document.getElementById('log-entry-template');
            const clone = document.importNode(template.content, true);
            
            // Get timestamp
            let timestamp = 'Unknown time';
            if (log.timestamp) {
                timestamp = formatTimestamp(log.timestamp);
            }
            
            // Replace placeholders in the template
            const timestampEl = clone.querySelector('.log-timestamp');
            const adminEl = clone.querySelector('.log-admin');
            const messageEl = clone.querySelector('.log-message');
            
            if (timestampEl) {
                timestampEl.textContent = timestamp;
            }
            
            if (adminEl) {
                adminEl.textContent = log.admin || 'Unknown';
            }
            
            if (messageEl && adminEl) {
                // Remove the admin part from the message as it's already in the admin element
                messageEl.innerHTML = messageEl.innerHTML.replace('{admin}', '');
                
                // Format the action message to replace UIDs with user names
                let actionText = log.action || 'performed an action';
                
                // Replace UIDs with user names in the action text
                allUsers.forEach(user => {
                    if (user.uid) {
                        const regex = new RegExp(user.uid, 'g');
                        actionText = actionText.replace(regex, user.name || user.email || 'Unknown User');
                    }
                });
                
                // Add the formatted action part
                const actionPart = document.createTextNode(actionText);
                messageEl.appendChild(actionPart);
            }
            
            return clone;
        }
        
        // Document click handler to close modals when clicking outside
        document.addEventListener('click', function(event) {
            const modals = document.querySelectorAll('.modal');
            
            modals.forEach(modal => {
                if (modal.style.display === 'flex') {
                    const modalContent = modal.querySelector('.modal-content');
                    
                    // Check if click is outside the modal content
                    if (modalContent && !modalContent.contains(event.target) && event.target !== modalContent) {
                        // Check that the click target isn't a button that opens a modal
                        const isModalOpener = event.target.closest('[class*="-btn"]');
                        if (!isModalOpener) {
                            modal.style.display = 'none';
                        }
                    }
                }
            });
        });
        
        // Handle browser resize for responsive layout
        window.addEventListener('resize', function() {
            const width = window.innerWidth;
            
            if (width <= 1024) {
                sidebar.classList.add('hidden');
                main.classList.add('full');
            } else {
                sidebar.classList.remove('hidden');
                main.classList.remove('full');
            }
        });
        
        // Initialize responsive layout on page load
        window.addEventListener('load', function() {
            const width = window.innerWidth;
            
            if (width <= 1024) {
                sidebar.classList.add('hidden');
                main.classList.add('full');
            }
        });
        
        // Global error handler
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            
            // Log error to Firestore for debugging
            try {
                if (currentAdmin) {
                    logAdminAction(`Encountered error: ${event.message}`);
                }
            } catch (error) {
                console.error('Error logging error:', error);
            }
        });
        
        // Add CSS class for specific browsers (for compatibility)
        function detectBrowser() {
            const isFirefox = navigator.userAgent.indexOf('Firefox') !== -1;
            const isChrome = navigator.userAgent.indexOf('Chrome') !== -1 && navigator.userAgent.indexOf('Edge') === -1;
            const isSafari = navigator.userAgent.indexOf('Safari') !== -1 && navigator.userAgent.indexOf('Chrome') === -1;
            const isEdge = navigator.userAgent.indexOf('Edg') !== -1;
            
            if (isFirefox) document.body.classList.add('firefox');
            if (isChrome) document.body.classList.add('chrome');
            if (isSafari) document.body.classList.add('safari');
            if (isEdge) document.body.classList.add('edge');
        }
        
        // Run browser detection on load
        window.addEventListener('DOMContentLoaded', detectBrowser);
        
        // Utility function to validate email format
        function isValidEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(String(email).toLowerCase());
        }
        
        // Utility function to safely extract nested values
        function safeGet(obj, path, defaultValue = '') {
            if (!obj) return defaultValue;
            
            const keys = path.split('.');
            let current = obj;
            
            for (let key of keys) {
                if (current[key] === undefined || current[key] === null) {
                    return defaultValue;
                }
                current = current[key];
            }
            
            return current;
        }
        
        // Utility function to convert UTC date to local time
        function utcToLocal(date) {
            if (!date) return '';
            
            try {
                const d = new Date(date);
                return d.toLocaleString();
            } catch (error) {
                console.error('Error converting UTC date:', error);
                return '';
            }
        }
        
        // Utility function to generate a random ID
        function generateRandomId(length = 10) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let id = '';
            
            for (let i = 0; i < length; i++) {
                id += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            return id;
        }
        
        // Utility function to format timestamps specifically for logs
        function formatLogTimestamp(timestamp) {
            if (!timestamp) return 'Unknown';
            
            try {
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                
                // Format as: Jan 01, 2023 15:30:45
                const options = {
                    year: 'numeric',
                    month: 'short',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                };
                
                return date.toLocaleDateString('en-US', options);
            } catch (error) {
                console.error('Error formatting log timestamp:', error);
                return 'Invalid date';
            }
        }
        
        // Utility function to debounce function calls
        function debounce(func, wait, immediate) {
            let timeout;
            
            return function executedFunction() {
                const context = this;
                const args = arguments;
                
                const later = function() {
                    timeout = null;
                    if (!immediate) func.apply(context, args);
                };
                
                const callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                
                if (callNow) func.apply(context, args);
            };
        }
        
        // Debounced search for clients
        const debouncedClientSearch = debounce(function(e) {
            const query = e.target.value.toLowerCase();
            filterClients(query);
        }, 300);
        
        // Add debounced search to client search input
        const clientSearchInput = document.getElementById('client-search');
        if (clientSearchInput) {
            clientSearchInput.addEventListener('input', debouncedClientSearch);
        }// Add class to newly created elements
        function addClassToNew(elements, className) {
            elements.forEach(element => {
                element.classList.add('new-element');
                
                // Remove class after animation
                setTimeout(() => {
                    element.classList.remove('new-element');
                }, 2000);
            });
        }
        
        // Format number as percentage
        function formatPercentage(value) {
            if (isNaN(value)) return '0%';
            
            return `${(value * 100).toFixed(2)}%`;
        }
        
        // Calculate time difference in human-readable format
        function timeAgo(date) {
            if (!date) return '';
            
            try {
                const now = new Date();
                const past = date.toDate ? date.toDate() : new Date(date);
                const seconds = Math.floor((now - past) / 1000);
                
                if (seconds < 60) {
                    return 'just now';
                }
                
                const minutes = Math.floor(seconds / 60);
                if (minutes < 60) {
                    return `${minutes} minute${minutes === 1 ? '' : 's'} ago`;
                }
                
                const hours = Math.floor(minutes / 60);
                if (hours < 24) {
                    return `${hours} hour${hours === 1 ? '' : 's'} ago`;
                }
                
                const days = Math.floor(hours / 24);
                if (days < 30) {
                    return `${days} day${days === 1 ? '' : 's'} ago`;
                }
                
                const months = Math.floor(days / 30);
                if (months < 12) {
                    return `${months} month${months === 1 ? '' : 's'} ago`;
                }
                
                const years = Math.floor(months / 12);
                return `${years} year${years === 1 ? '' : 's'} ago`;
            } catch (error) {
                console.error('Error calculating time ago:', error);
                return '';
            }
        }
        
        // Get transaction action buttons based on type and status
        function getTransactionActionButtons(transaction) {
            const type = transaction.type || '';
            const isPending = type.includes('request');
            
            // Store transaction data directly on button
            const transactionData = JSON.stringify(transaction).replace(/"/g, '&quot;');
            
            if (isPending) {
                return `
                    <button class="btn btn-sm approve-transaction" data-id="${transaction.id || ''}" data-uid="${transaction.userUid || ''}">Approve</button>
                    <button class="btn btn-sm btn-outline decline-transaction" data-id="${transaction.id || ''}" data-uid="${transaction.userUid || ''}">Decline</button>
                `;
            } else {
                return `
                    <button class="btn btn-sm view-transaction" data-transaction='${transactionData}' data-id="${transaction.id || ''}" data-uid="${transaction.userUid || ''}">View</button>
                `;
            }
        }
        
        // Check if user is verified for withdrawal
        function isUserVerifiedForWithdrawal(user) {
            // If platform requires KYC for withdrawal, check if user is verified
            if (platformSettings.requireKycWithdrawal) {
                return user.kycStatus === 'verified';
            }
            
            // Otherwise, allow withdrawal
            return true;
        }
        
        // Generate transaction reference ID
        function generateTransactionReference() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            const prefix = 'TX';
            let result = prefix;
            
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            return result;
        }
        
        // Check if transaction amount exceeds large transaction threshold
        function isLargeTransaction(amount) {
            if (!platformSettings.notifyLargeTransactions) {
                return false;
            }
            
            const threshold = platformSettings.largeTransactionThreshold || 1000;
            return amount >= threshold;
        }
        
        // Send admin notification for large transactions
        async function notifyLargeTransaction(transaction, user) {
            if (!isLargeTransaction(transaction.amount)) {
                return;
            }
            
            try {
                await addDoc(collection(db, 'adminNotifications'), {
                    type: 'large_transaction',
                    transaction: transaction,
                    user: user.uid,
                    timestamp: Timestamp.now(),
                    read: false
                });
                
                console.log('Large transaction notification sent');
            } catch (error) {
                console.error('Error sending large transaction notification:', error);
            }
        }
        
        // Convert base64 to blob for file download
        function base64ToBlob(base64, mimeType) {
            const byteString = atob(base64.split(',')[1]);
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            
            return new Blob([ab], { type: mimeType });
        }
        
        // Download KYC image
        function downloadKycImage(base64, userName) {
            if (!base64) {
                alert('No KYC image available');
                return;
            }
            
            const blob = base64ToBlob(base64, 'image/jpeg');
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            a.href = url;
            a.download = `kyc_${userName.replace(/\s+/g, '_')}_${Date.now()}.jpg`;
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }
        
        // Create a notification badge
        function createNotificationBadge(count) {
            const badge = document.createElement('span');
            badge.className = 'notification-badge';
            badge.textContent = count > 99 ? '99+' : count;
            return badge;
        }
        
        // Update notification badges
        function updateNotificationBadges() {
            const pendingCount = allUsers.reduce((count, user) => {
                if (user.history && Array.isArray(user.history)) {
                    return count + user.history.filter(tx => tx.type && tx.type.includes('request')).length;
                }
                return count;
            }, 0);
            
            const transactionsNav = document.querySelector('.nav-item[data-panel="transactions"]');
            if (transactionsNav && pendingCount > 0) {
                // Remove existing badge
                const existingBadge = transactionsNav.querySelector('.notification-badge');
                if (existingBadge) {
                    existingBadge.remove();
                }
                
                // Add new badge
                transactionsNav.appendChild(createNotificationBadge(pendingCount));
            }
        }
        
        // Format file size in a human-readable way
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Check if the device is a mobile device
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // Apply mobile-specific adjustments
        function applyMobileAdjustments() {
            if (isMobileDevice()) {
                document.body.classList.add('mobile-device');
                
                // Close sidebar on mobile by default
                sidebar.classList.add('hidden');
                main.classList.add('full');
                
                // Add touch-specific styles
                const style = document.createElement('style');
                style.textContent = `
                    .client-header, .transaction-item, .nav-item {
                        padding: 1rem 0.75rem;
                    }
                    input, select, textarea, button {
                        font-size: 16px; /* Prevent zoom on input focus in iOS */
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        // Call mobile adjustments on load
        window.addEventListener('DOMContentLoaded', applyMobileAdjustments);
        
        // Add clipboard copy functionality
        function copyToClipboard(text) {
            // Create temporary element
            const el = document.createElement('textarea');
            el.value = text;
            el.setAttribute('readonly', '');
            el.style.position = 'absolute';
            el.style.left = '-9999px';
            document.body.appendChild(el);
            
            // Select and copy text
            el.select();
            document.execCommand('copy');
            
            // Clean up
            document.body.removeChild(el);
            
            return true;
        }
        
        // Initialize tooltips
        function initializeTooltips() {
            const tooltipElements = document.querySelectorAll('[data-tooltip]');
            
            tooltipElements.forEach(element => {
                const tooltipText = element.getAttribute('data-tooltip');
                
                element.addEventListener('mouseenter', () => {
                    const tooltip = document.createElement('div');
                    tooltip.className = 'tooltip';
                    tooltip.textContent = tooltipText;
                    
                    // Position tooltip
                    const rect = element.getBoundingClientRect();
                    tooltip.style.top = `${rect.bottom + 5}px`;
                    tooltip.style.left = `${rect.left + (rect.width / 2)}px`;
                    
                    // Add to DOM
                    document.body.appendChild(tooltip);
                    
                    // Store reference
                    element._tooltip = tooltip;
                });
                
                element.addEventListener('mouseleave', () => {
                    if (element._tooltip) {
                        element._tooltip.remove();
                        element._tooltip = null;
                    }
                });
            });
        }
        
        // Add notification sound
        function playNotificationSound() {
            const audio = new Audio('https://cdn.freesound.org/sounds/392/392618-4ae3582e-e1c3-45f8-91ae-3aa8c5940565.mp3');
            audio.volume = 0.5;
            audio.play().catch(error => console.error('Error playing notification sound:', error));
        }
        
        // Handle unread admin notifications
        function checkForUnreadNotifications() {
            try {
                // Get unread notifications from Firestore
                const unreadNotificationsQuery = query(
                    collection(db, 'adminNotifications'),
                    where('read', '==', false)
                );
                
                onSnapshot(unreadNotificationsQuery, snapshot => {
                    if (!snapshot.empty) {
                        playNotificationSound();
                        updateNotificationBadges();
                    }
                });
            } catch (error) {
                console.error('Error checking for unread notifications:', error);
            }
        }
        
        // Wait for everything to load, then log initialization complete
        window.addEventListener('load', () => {
            console.log('Admin dashboard load complete');
            
            // Run full initialization
            setTimeout(() => {
                checkForUnreadNotifications();
                initializeTooltips();
                updateNotificationBadges();
            }, 2000);
        });
        
        console.log('Admin dashboard script initialization complete');
        
        // Add event listeners to view buttons
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Admin Dashboard DOM loaded');
            const viewButtons = document.querySelectorAll('.view-transaction');
            console.log('Found view buttons:', viewButtons.length);
            
            viewButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    console.log('View button clicked');
                    console.log('Button data:', {
                        id: button.dataset.id,
                        uid: button.dataset.uid
                    });
                    // ... existing code ...
                });
            });
        });

        // ... existing code ...
        function renderTransactionRow(transaction, uid) {
            // Create a JSON string of the transaction data for the view button
            const transactionData = JSON.stringify({
                ...transaction,
                userUid: uid
            });
            
            return `
                <tr>
                    <td>${formatDate(transaction.date)}</td>
                    <td>${getTransactionTypeLabel(transaction)}</td>
                    <td>${formatCurrency(transaction.details?.amount || transaction.amount || 0)}</td>
                    <td>${getStatusHTML(getTransactionStatus(transaction))}</td>
                    <td><button class="btn btn-sm view-transaction" data-transaction='${transactionData}'>View</button></td>
                </tr>
            `;
        }

        // Add Transaction View Event Listeners
        function addTransactionViewEventListeners(container) {
            if (!container) {
                console.error('No container provided for event listeners');
                return;
            }
            
            // View buttons
            const viewButtons = container.querySelectorAll('.view-transaction');
            viewButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    try {
                    const transactionData = JSON.parse(e.currentTarget.getAttribute('data-transaction'));
                    showTransactionDetails(transactionData);
                    } catch (error) {
                        console.error('Error handling view button click:', error);
                        alert('Error viewing transaction details');
                    }
                });
            });

            // Approve buttons
            const approveButtons = container.querySelectorAll('.approve-transaction');
            approveButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const uid = button.getAttribute('data-uid');
                    const transactionData = JSON.parse(button.closest('.transaction-item').dataset.transaction);
                    handleApproveTransaction(transactionData);
                });
            });

            // Decline buttons
            const declineButtons = container.querySelectorAll('.decline-transaction');
            declineButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const uid = button.getAttribute('data-uid');
                    const transactionData = JSON.parse(button.closest('.transaction-item').dataset.transaction);
                    handleDeclineTransaction(transactionData);
                });
            });
        }
        // ... existing code ...

        // Add the closeModal function
        function closeModal(modal) {
            if (!modal) {
                console.error('No modal provided to close');
                return;
            }
            modal.style.display = 'none';
            modal.classList.remove('show');
        }

        // Handle Update Withdrawal Code
        async function handleUpdateWithdrawalCode(event) {
            const uid = event.target.getAttribute('data-uid');
            
            if (!uid) {
                console.error('No UID provided for withdrawal code update');
                return;
            }
            
            console.log(`Updating withdrawal code for user: ${uid}`);
            
            const codeInput = document.getElementById(`withdrawal-code-${uid}`);
            
            if (!codeInput) {
                console.error('Withdrawal code input not found');
                return;
            }
            
            const code = codeInput.value.trim();
            
            // Validate code format (6 digits)
            if (!/^\d{6}$/.test(code)) {
                alert('Please enter a valid 6-digit code');
                return;
            }
            
            try {
                // Update user document
                await updateDoc(doc(db, 'users', uid), {
                    withdrawalCode: code
                });
                
                // Log admin action
                await logAdminAction(`Updated withdrawal code for ${uid}`);
                
                // Update local data
                const userIndex = allUsers.findIndex(u => u.uid === uid);
                if (userIndex !== -1) {
                    allUsers[userIndex].withdrawalCode = code;
                }
                
                alert('Withdrawal code updated successfully');
                
                // Clear input
                codeInput.value = '';
            } catch (error) {
                console.error('Error updating withdrawal code:', error);
                alert(`Error updating withdrawal code: ${error.message}`);
            }
        }

        // Theme management
        const themeToggle = document.getElementById('theme-toggle');
        const root = document.documentElement;
        const sunIcon = themeToggle.querySelector('.sun-icon');
        const moonIcon = themeToggle.querySelector('.moon-icon');

        // Function to set theme
        function setTheme(theme) {
            root.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            // Update icons
            if (theme === 'light') {
                sunIcon.style.display = 'none';
                moonIcon.style.display = 'block';
            } else {
                sunIcon.style.display = 'block';
                moonIcon.style.display = 'none';
            }
        }

        // Function to get system theme preference
        function getSystemTheme() {
            const hours = new Date().getHours();
            return hours >= 6 && hours < 18 ? 'light' : 'dark';
        }

        // Initialize theme
        function initializeTheme() {
            // Check localStorage first
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                setTheme(savedTheme);
            } else {
                // If no saved theme, use system time
                setTheme(getSystemTheme());
            }
        }

        // Toggle theme
        themeToggle.addEventListener('click', () => {
            const currentTheme = root.getAttribute('data-theme');
            setTheme(currentTheme === 'light' ? 'dark' : 'light');
        });

        // Check time every minute to auto-switch theme
        setInterval(() => {
            // Only auto-switch if no theme is saved in localStorage
            if (!localStorage.getItem('theme')) {
                setTheme(getSystemTheme());
            }
        }, 60000);

        // Initialize theme on load
        initializeTheme();

        // Handle window resize
        window.addEventListener('resize', () => {
            const sidebar = document.getElementById('sidebar');
            const main = document.getElementById('main');
            
            if (window.innerWidth > 1024) {
                // Reset mobile-specific classes
                sidebar.classList.remove('visible');
                if (!sidebar.classList.contains('hidden')) {
                    main.classList.remove('full');
                }
            }
        });
    </script>
</body>
</html>