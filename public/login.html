<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Citron Trades</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            /* Dark theme variables */
            --bg-dark: #161625;
            --bg-card: #1A1A2E;
            --color-primary: #40B467;
            --color-primary-hover: #35a058;
            --color-text: #ffffff;
            --color-text-secondary: #a0a0b8;
            --color-border: #2a2a3d;
            --color-positive: #40B467;
            --color-negative: #e74c3c;
            --color-warning: #f39c12;
            --color-info: #3498db;
        }

        /* Light theme variables */
        :root[data-theme="light"] {
            --bg-dark: #f8f9fa;
            --bg-card: #ffffff;
            --color-text: #2d3436;
            --color-text-secondary: #636e72;
            --color-border: #dfe6e9;
            --color-primary: #40B467;
            --color-primary-hover: #35a058;
            --color-positive: #40B467;
            --color-negative: #e74c3c;
            --color-warning: #f39c12;
            --color-info: #3498db;
        }

        /* Theme toggle button styles */
        .theme-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: none;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: rgba(64, 180, 103, 0.1);
        }

        .theme-toggle svg {
            width: 18px;
            height: 18px;
        }

        .home-button {
            position: fixed;
            top: 1rem;
            left: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: none;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .home-button:hover {
            background: rgba(64, 180, 103, 0.1);
        }

        .home-button svg {
            width: 18px;
            height: 18px;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-dark);
            color: var(--color-text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            background: #fff;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .header h1 {
            font-size: 2rem;
            font-weight: 800;
            color: #1e2a44;
            margin: 0;
        }
        .header p {
            color: #6474ff;
            font-weight: 600;
        }
        .form-box h2 {
            font-size: 1.5rem;
            color: #1e2a44;
            margin-bottom: 1rem;
            text-align: center;
        }
        .form-box input {
            width: 100%;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        .form-box button {
            width: 100%;
            padding: 0.75rem;
            background: #6474ff;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 1rem;
        }
        .form-box button:hover {
            background: #4b5bff;
        }
        .form-box p {
            text-align: center;
            margin-top: 1rem;
            color: #6474ff;
        }
        .form-box a {
            color: #6474ff;
            text-decoration: none;
            font-weight: 600;
        }
        .form-box a:hover {
            text-decoration: underline;
        }
        #signup-form {
            display: none;
        }
    </style>
</head>
<body>
    <a href="/" class="home-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        Home
    </a>
    <div class="container">
        <div class="header">
            <h1>Citron Trades</h1>
            <p>Your Trading Journey Starts Here</p>
        </div>

        <!-- Login Form -->
        <div class="form-box" id="login-form">
            <h2>Login</h2>
            <input type="email" id="login-email" placeholder="Email">
            <input type="password" id="login-password" placeholder="Password">
            <button id="login-btn">Login</button>
            <p><a href="#" id="reset-password">Forgot Password?</a></p>
            <p>Don't have an account? <a href="#" id="show-signup">Sign Up</a></p>
        </div>

        <!-- Signup Form -->
        <div class="form-box" id="signup-form">
            <h2>Sign Up</h2>
            <input type="text" id="signup-name" placeholder="Your Name" required>
            <input type="email" id="signup-email" placeholder="Email" required>
            <input type="password" id="signup-password" placeholder="Password" required>
            <button id="signup-btn">Sign Up</button>
            <p>Already have an account? <a href="#" id="show-login">Login</a></p>
        </div>
    </div>

    <!-- Add theme toggle button -->
    <button class="theme-toggle" id="theme-toggle" title="Toggle theme">
        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
    </button>

    <!-- Firebase SDK v11.4.0 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, sendEmailVerification, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEPH6zPhhmyrAL8YPKzJWZZVOT8LScpIg",
            authDomain: "invest-mgnt.firebaseapp.com",
            projectId: "invest-mgnt",
            storageBucket: "invest-mgnt.firebasestorage.app",
            messagingSenderId: "658245081425",
            appId: "1:658245081425:web:73eeaa2614e426030c1b70",
            measurementId: "G-F03JXGD2ZT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        console.log('Firebase initialized');

        // Login Functionality
        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const userRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userRef);

                if (userDoc.exists() && userDoc.data().status === 'banned') {
                    alert('Your account is banned.');
                    await signOut(auth);
                    return;
                }

                if (!userDoc.exists() || !user.emailVerified) {
                    if (!user.emailVerified) {
                        alert('Please verify your email before logging in.');
                        await signOut(auth);
                        return;
                    }
                }

                await updateDoc(userRef, { lastLogin: Timestamp.now() });

                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    window.location.href = 'admin.html';
                } else {
                    window.location.href = 'dashboard.html';
                }
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        });

        // Signup Functionality
        document.getElementById('signup-btn').addEventListener('click', async () => {
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            console.log('Signup clicked - Name:', name, 'Email:', email);

            if (!name || !email || !password) {
                alert('Please enter your name, email, and password');
                return;
            }
            if (password.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }

            try {
                console.log('Creating user in Authentication');
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                console.log('User created - UID:', user.uid);

                const userRef = doc(db, 'users', user.uid);
                console.log('Checking if user document exists');
                const userDoc = await getDoc(userRef);
                if (!userDoc.exists()) {
                    console.log('Creating Firestore document');
                    await setDoc(userRef, {
                        name: name,
                        email: user.email,
                        role: 'user',
                        balance: 0,
                        kycStatus: 'pending',
                        warnings: [],
                        status: 'active',
                        accountLevel: 'basic',
                        messages: [],
                        createdAt: Timestamp.now(),
                        autoTrade: false,
                        autoProfitEnabled: false,
                        depositRequests: [],
                        depositHistory: [],
                        withdrawalRequests: [],
                        withdrawalHistory: [],
                        tradeHistory: [],
                        history: [],
                        paymentSettings: {
                            btcAddress: '',
                            nowPaymentsLink: '',
                            simplexLink: ''
                        }
                    });
                    console.log('Firestore document created');
                } else {
                    console.log('User document already exists');
                }

                console.log('Sending verification email');
                await sendEmailVerification(user);
                console.log('Verification email sent');
                alert('A verification email has been sent. Please check your inbox, verify your email, and then log in.');
                
                await signOut(auth);
                console.log('User signed out after signup');
                toggleForms(false);
            } catch (error) {
                console.error('Signup error:', error.code, error.message);
                alert('Signup failed: ' + error.message);
            }
        });

        // Forgot Password Functionality
        document.getElementById('reset-password').addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            if (!email) {
                alert('Please enter your email first.');
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                alert('Password reset email sent! Check your inbox to reset your password.');
            } catch (error) {
                alert('Error sending reset email: ' + error.message);
            }
        });

        // Toggle Forms
        document.getElementById('show-signup').addEventListener('click', () => toggleForms(true));
        document.getElementById('show-login').addEventListener('click', () => toggleForms(false));
        function toggleForms(showSignup) {
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            loginForm.style.display = showSignup ? 'none' : 'block';
            signupForm.style.display = showSignup ? 'block' : 'none';
        }

        // Check auth state but don't redirect immediately
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('User is already logged in:', user.email);
            } else {
                console.log('No user logged in');
            }
        });
    </script>

    <!-- Add theme management script -->
    <script>
        // Theme management
        const themeToggle = document.getElementById('theme-toggle');
        const root = document.documentElement;
        const sunIcon = themeToggle.querySelector('.sun-icon');
        const moonIcon = themeToggle.querySelector('.moon-icon');

        // Function to set theme
        function setTheme(theme) {
            root.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            // Update icons
            if (theme === 'light') {
                sunIcon.style.display = 'none';
                moonIcon.style.display = 'block';
            } else {
                sunIcon.style.display = 'block';
                moonIcon.style.display = 'none';
            }
        }

        // Function to get system theme preference
        function getSystemTheme() {
            const hours = new Date().getHours();
            return hours >= 6 && hours < 18 ? 'light' : 'dark';
        }

        // Initialize theme
        function initializeTheme() {
            // Check localStorage first
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                setTheme(savedTheme);
            } else {
                // If no saved theme, use system time
                setTheme(getSystemTheme());
            }
        }

        // Toggle theme
        themeToggle.addEventListener('click', () => {
            const currentTheme = root.getAttribute('data-theme');
            setTheme(currentTheme === 'light' ? 'dark' : 'light');
        });

        // Check time every minute to auto-switch theme
        setInterval(() => {
            // Only auto-switch if no theme is saved in localStorage
            if (!localStorage.getItem('theme')) {
                setTheme(getSystemTheme());
            }
        }, 60000);

        // Initialize theme on load
        initializeTheme();
    </script>
</body>
</html>