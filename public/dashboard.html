<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citron Trades - User Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="assets/icons/6629ad2a661a5bfd1a82b5c3_logo.svg" type="image/svg+xml">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            /* Dark theme variables */
            --bg-dark: #161625;
            --bg-card: #1A1A2E;
            --color-primary: #6474ff;
            --color-primary-hover: #5461e6;
            --color-text: #ffffff;
            --color-text-secondary: #a0a0b8;
            --color-border: #2a2a3d;
            --color-positive: #40B467;  /* Keep green for profits */
            --color-negative: #e74c3c;  /* Keep red for losses */
            --color-warning: #f39c12;
            --color-info: #3498db;
            --chat-user-bg: #3B82F6;
            --chat-user-text: #ffffff;
            --chat-admin-bg: #323245;
            --chat-admin-text: #ffffff;
        }

        /* Light theme variables */
        :root[data-theme="light"] {
            --bg-dark: #f8f9fa;
            --bg-card: #ffffff;
            --color-text: #2d3436;
            --color-text-secondary: #636e72;
            --color-border: #dfe6e9;
            --color-primary: #6474ff;
            --color-primary-hover: #5461e6;
            --color-positive: #40B467;  /* Keep green for profits */
            --color-negative: #e74c3c;  /* Keep red for losses */
            --color-warning: #f39c12;
            --color-info: #3498db;
            --chat-user-bg: #3B82F6;
            --chat-user-text: #ffffff;
            --chat-admin-bg: #e9ecef;
            --chat-admin-text: #2d3436;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--color-text);
            min-height: 100vh;
            overflow-x: hidden;
        }
        .dashboard {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 260px;
            background: var(--bg-dark);
            padding: 1.5rem 1rem;
            border-right: 1px solid var(--color-border);
            transition: transform 0.3s ease;
            position: fixed;
            height: 100%;
            z-index: 1000;
            overflow-y: auto;
        }
        .sidebar.hidden { transform: translateX(-260px); }
        .logo-container {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            padding-left: 0.5rem;
        }
        .logo {
            height: 32px;
            margin-right: 0.75rem;
            content: url("assets/images/logo-light.svg"); /* Local white text logo for dark mode */
        }
        
        /* Switch logo for light theme */
        :root[data-theme="light"] .logo {
            content: url("assets/images/logo-dark.svg"); /* Local black text logo for light mode */
        }
        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .nav-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin: 1.5rem 0 0.5rem 0.5rem;
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin: 0.25rem 0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            color: var(--color-text-secondary);
        }
        .nav-item svg {
            margin-right: 0.75rem;
        }
        .nav-item:hover {
            background: rgba(64, 180, 103, 0.1);
            color: var(--color-text);
        }
        .nav-item.active {
            background: rgba(64, 180, 103, 0.15);
            color: var(--color-primary);
        }
        .main {
            flex: 1;
            padding: 1.5rem;
            margin-left: 260px;
            transition: margin-left 0.3s ease;
        }
        .main.full { margin-left: 0; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--color-border);
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            color: var(--color-text-secondary);
            font-size: 0.95rem;
        }
        #user-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--color-text);
        }
        .account-manager {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .toggle-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--color-text);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
        }
        .header-stats {
            display: flex;
            gap: 1.5rem;
            font-size: 0.95rem;
            color: var(--color-text-secondary);
        }
        .header-stats span:last-child {
            color: var(--color-primary);
            font-weight: 600;
        }
        .panel {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .panel.active {
            display: block;
            opacity: 1;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style><style>
        /* Common Dashboard Elements */
        .section {
            margin-bottom: 2rem;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-text);
        }
        .refresh-btn {
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--color-text-secondary);
            transition: all 0.2s ease;
        }
        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--color-text);
        }
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--color-border);
            overflow: hidden;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--color-border);
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .card-content {
            padding: 1.25rem;
        }

        /* Dashboard components styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.25rem;
            margin-bottom: 1rem;
        }
        .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            border-color: rgba(64, 180, 103, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }
        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .stat-card-header h3 {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--color-text-secondary);
        }
        .stat-card-header svg {
            opacity: 0.7;
        }
        .stat-card-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        .stat-card-value.profit-value {
            color: var(--color-positive);
        }
        .stat-card-value.profit-value.negative {
            color: var(--color-negative);
        }
        .stat-card-chart {
            margin-top: auto;
            height: 50px;
        }
        .stat-card-info {
            margin-top: auto;
        }
        .level-progress {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        .level-progress-bar {
            height: 100%;
            background: var(--color-primary);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .level-progress-text {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
        }
        .stat-card-actions {
            margin-top: auto;
        }

        /* Form control elements */
        .btn, button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.65rem 1.25rem;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn:hover, button:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
        }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--color-primary);
            color: var(--color-primary);
        }
        .btn-outline:hover {
            background: rgba(64, 180, 103, 0.1);
        }
        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }
        .btn-icon-only {
            padding: 0.5rem;
        }
        .btn svg {
            margin-right: 0.5rem;
        }
        input, select, textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            font-size: 0.95rem;
            transition: border-color 0.2s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--color-primary);
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .form-group {
            margin-bottom: 1.25rem;
        }
    </style><style>
        /* Time filter buttons */
        .time-filter {
            display: flex;
            gap: 0.5rem;
        }
        .time-filter-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .time-filter-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--color-text);
        }
        .time-filter-btn.active {
            background: rgba(64, 180, 103, 0.15);
            border-color: rgba(64, 180, 103, 0.3);
            color: var(--color-primary);
        }
        
        /* Transactions table */
        .transactions-table-container {
            overflow-x: auto;
        }
        .transactions-table {
            width: 100%;
            border-collapse: collapse;
        }
        .transactions-table th {
            text-align: left;
            padding: 1rem;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            border-bottom: 1px solid var(--color-border);
            font-weight: 500;
        }
        .transactions-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--color-border);
            font-size: 0.9rem;
        }
        .transactions-table tr:last-child td {
            border-bottom: none;
        }
        .transactions-table tr:hover td {
            background: rgba(255, 255, 255, 0.03);
        }
        .status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .status.pending {
            background: rgba(243, 156, 18, 0.15);
            color: #f39c12;
        }
        .status.completed {
            background: rgba(64, 180, 103, 0.15);
            color: var(--color-positive);
        }
        .status.failed {
            background: rgba(231, 76, 60, 0.15);
            color: var(--color-negative);
        }
        .no-data {
            color: var(--color-text-secondary);
            text-align: center;
            padding: 2rem !important;
        }
        .view-all {
            color: var(--color-primary);
            font-size: 0.9rem;
            text-decoration: none;
            transition: color 0.2s ease;
        }
        .view-all:hover {
            color: var(--color-primary-hover);
            text-decoration: underline;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--color-border);
            max-width: 500px;
            width: 90%;
            padding: 1.5rem;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .modal-desc {
            color: var(--color-text-secondary);
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }
        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--color-text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }
        .close-modal:hover {
            color: var(--color-text);
        }

        /* Responsive styles */
        @media (max-width: 1024px) {
            .main {
                margin-left: 0;
                padding: 1rem;
            }
            .sidebar {
                transform: translateX(-100%);
                z-index: 1000;
                background: var(--bg-dark);
                box-shadow: 2px 0 8px rgba(0, 0, 0, 0.2);
                transition: transform 0.3s ease;
            }
            .sidebar.visible {
                transform: translateX(0);
            }
            .logo-container {
                padding: 1rem;
                margin-bottom: 1.5rem;
                border-bottom: 1px solid var(--color-border);
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            .logo-container .mobile-close {
                display: block;
                padding: 0.5rem;
                cursor: pointer;
                color: var(--color-text-secondary);
            }
            .mobile-header {
                display: flex;
                align-items: center;
                gap: 1rem;
                margin-bottom: 1rem;
            }
            .mobile-logo {
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: var(--color-primary);
                border-radius: 8px;
                color: white;
                font-weight: bold;
                font-size: 1.2rem;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
                padding: 1rem 0;
                position: relative;
            }
            .header-left {
                width: 100%;
                flex-direction: column;
                align-items: flex-start;
            }
            .mobile-brand {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                position: relative;
                padding: 0 3.5rem;
            }
            .logo {
                height: 30px;
                width: auto;
            }
            .logo-text {
                display: none; /* Hide the text */
            }
            .toggle-btn {
                position: absolute;
                top: 1rem;
                left: 1rem;
                z-index: 10;
            }
            .theme-toggle {
                position: absolute;
                top: 1rem;
                right: 1rem;
                z-index: 10;
                margin-right: 0;
            }
            .user-info {
                width: 100%;
                flex-direction: column;
                align-items: center;
                text-align: center;
                gap: 0.25rem;
                margin-top: 2rem;
            }
            #user-name {
                font-size: 1.1rem;
                font-weight: 500;
            }
            .account-manager {
                font-size: 0.9rem;
                color: var(--color-text-secondary);
            }
            .header-actions {
                width: 100%;
                display: flex;
                justify-content: center;
                margin-top: 0.5rem;
            }
            .mobile-header {
                display: none;
            }
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            .stat-card {
                padding: 1rem;
            }
            .time-filter {
                overflow-x: auto;
                padding-bottom: 0.5rem;
                margin: -0.25rem;
            }
            .time-filter-btn {
                white-space: nowrap;
                padding: 0.5rem 1rem;
            }
            .transactions-table-container {
                margin: 0 -1rem;
                width: calc(100% + 2rem);
            }
            .transactions-table {
                font-size: 0.85rem;
            }
            .transactions-table th,
            .transactions-table td {
                padding: 0.75rem;
            }
            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
            .modal-content {
                width: 95%;
                padding: 1rem;
            }
            .payment-options {
                flex-direction: column;
                gap: 0.5rem;
            }
            .form-row {
                flex-direction: column;
                gap: 1rem;
            }
            .profile-picture {
                width: 100px;
                height: 100px;
            }
            .chat-container {
                height: calc(100vh - 200px);
            }
            .referral-stats {
                flex-direction: column;
                gap: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .header-title {
                font-size: 1.25rem;
            }
            .stat-card-value {
                font-size: 1.5rem;
            }
            .nav-item {
                padding: 0.6rem 0.75rem;
                font-size: 0.9rem;
            }
            .modal-title {
                font-size: 1.25rem;
            }
            .section-title {
                font-size: 1.1rem;
            }
            .transactions-table th:nth-child(4),
            .transactions-table td:nth-child(4) {
                display: none;
            }
            .btn-sm {
                padding: 0.35rem 0.7rem;
                font-size: 0.8rem;
            }
        }

        /* Hide mobile elements on desktop */
        .mobile-close,
        .mobile-header,
        .mobile-brand {
            display: none;
        }

        /* Show mobile brand only on mobile */
        @media (max-width: 768px) {
            .mobile-brand {
                display: flex;
            }
        }
        
        /* Portfolio panel specific styles */
        .portfolio-summary {
            display: flex;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: 1px solid var(--color-border);
        }
        .portfolio-summary > div:first-child {
            flex: 1;
        }
        .portfolio-summary > div:last-child {
            display: flex;
            gap: 0.5rem;
            flex-wrap: nowrap;
        }
        .portfolio-summary .btn {
            white-space: nowrap;
            padding: 0.65rem 1.25rem;
        }
        @media (max-width: 480px) {
            .portfolio-summary {
                padding: 1rem;
            }
            .portfolio-summary .stat-card-value {
                font-size: 1.5rem;
            }
            .portfolio-summary .btn {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
        }
        @media (max-width: 375px) {
            .portfolio-summary {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
                gap: 1rem;
            }
            .portfolio-summary > div:last-child {
                display: flex;
                justify-content: center;
                gap: 0.5rem;
            }
            .portfolio-summary .btn {
                min-width: 110px;
                flex: 0 1 auto;
            }
        }
        
        /* Profile panel specific styles */
        .profile-section {
            display: flex;
            padding: 1.5rem;
            border-bottom: 1px solid var(--color-border);
        }
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--color-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            margin-right: 1.5rem;
        }
        
        /* Chat styling */
        .chat-container {
            height: calc(100vh - 250px);
            display: flex;
            flex-direction: column;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--color-border);
        }

        /* Warning styles */
        .warning-item {
            background: rgba(243, 156, 18, 0.1);
            border-left: 4px solid var(--color-warning);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
        }
        
        .warning-item:last-child {
            margin-bottom: 0;
        }
        
        .warning-message {
            color: var(--color-text);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .warning-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }
        
        .warning-from {
            font-weight: 500;
        }
        
        .warning-time {
            opacity: 0.8;
        }
        
        #warnings-section {
            animation: fadeIn 0.3s ease;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .chat-input-container {
            display: flex;
            padding: 1rem;
            border-top: 1px solid var(--color-border);
            background: var(--bg-card);
        }
        .chat-input {
            flex: 1;
            margin-right: 0.75rem;
        }
        .chat-message {
            margin-bottom: 1rem;
            max-width: 75%;
        }
        .chat-message.user {
            margin-left: auto;
        }
        .chat-message.admin {
            margin-right: auto;
        }
        .chat-message-content {
            padding: 0.75rem 1rem;
            border-radius: 8px;
        }
        .chat-message.user .chat-message-content {
            background: var(--chat-user-bg);
            color: var(--chat-user-text);
        }
        .chat-message.admin .chat-message-content {
            background: var(--chat-admin-bg);
            color: var(--chat-admin-text);
        }
        .chat-message-time {
            font-size: 0.7rem;
            color: var(--color-text-secondary);
            margin-top: 0.25rem;
        }
        .chat-message.user .chat-message-time {
            text-align: right;
        }
        .chat-message.admin .chat-message-time {
            text-align: left;
        }
        .chat-sender {
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
            color: var(--color-text-secondary);
        }
        
        /* Auto-profit styles */
        .auto-profit-toggle-wrapper {
            display: flex;
            align-items: center;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-right: 10px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 34px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--color-primary);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* Transaction detail styles */
        .transaction-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--color-border);
        }
        .transaction-detail-row:last-child {
            border-bottom: none;
        }
        .transaction-detail-label {
            font-weight: 500;
            color: var(--color-text-secondary);
        }
        .transaction-detail-value {
            font-weight: 500;
        }
        
        /* Auto-profit countdown */
        .countdown-container {
            background: rgba(64, 180, 103, 0.1);
            border: 1px solid rgba(64, 180, 103, 0.3);
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 0.75rem;
        }
        .countdown-title {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            margin-bottom: 0.5rem;
        }
        .countdown-timer {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-primary);
        }
        
        /* Referral styles */
        .referral-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 2rem;
        }
        .referral-stat-card {
            text-align: center;
        }
        .referral-stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 0.5rem;
        }
        .referral-stat-label {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
        }
        .input-with-copy {
            display: flex;
            gap: 0.5rem;
        }
        /* KYC verification styles */
        .kyc-status-container {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--color-border);
        }
        
        .kyc-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.1);
            color: var(--color-text-secondary);
        }
        
        .status-badge.pending {
            background: rgba(243, 156, 18, 0.15);
            color: #f39c12;
        }
        
        .status-badge.verified {
            background: rgba(64, 180, 103, 0.15);
            color: var(--color-positive);
        }
        
        .status-badge.rejected {
            background: rgba(231, 76, 60, 0.15);
            color: var(--color-negative);
        }
        
        .kyc-message {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
        }
        
        .upload-btn-wrapper {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }
        
        #selected-file-name {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }
        
        .preview-container {
            margin: 1rem 0;
            padding: 1rem;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.02);
        }
        
        #submit-kyc {
            margin-top: 1rem;
        }
        /* Profile styles */
        .profile-picture-section {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }
        
        .profile-picture-container {
            text-align: center;
        }
        
        .profile-picture {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--color-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 600;
            margin: 0 auto 1rem;
            overflow: hidden;
            position: relative;
        }
        
        .profile-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-picture-upload {
            margin-top: 0.5rem;
        }
        
        .profile-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Form layout styles */
        .form-row {
            display: flex;
            gap: 1.25rem;
            margin-bottom: 1.25rem;
        }

        .form-col {
            flex: 1;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .section-subtitle {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .radio-group {
            display: flex;
            gap: 1.5rem;
            margin-top: 0.5rem;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .radio-label input[type="radio"] {
            width: auto;
            margin: 0;
        }

        /* Form states */
        input:disabled, select:disabled, textarea:disabled {
            background: rgba(255, 255, 255, 0.03);
            cursor: not-allowed;
            opacity: 0.7;
        }

        input:not(:disabled), select:not(:disabled), textarea:not(:disabled) {
            background: rgba(255, 255, 255, 0.05);
            cursor: text;
        }

        /* Preview container */
        .preview-container {
            margin-top: 1rem;
            padding: 1rem;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.02);
        }

        /* Upload button wrapper */
        .upload-btn-wrapper {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        #ssn-file-name {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }
    </style>
    <style>
        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }

        .notification.success {
            background-color: var(--color-positive);
        }

        .notification.error {
            background-color: var(--color-negative);
        }

        .notification.info {
            background-color: var(--color-info);
        }

        .notification.warning {
            background-color: var(--color-warning);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive styles */
    </style>
    <style>
        .payment-options {
            display: flex;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .payment-options .btn {
            flex: 1;
            padding: 1rem;
            font-size: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--color-border);
            color: var(--color-text);
            transition: all 0.2s ease;
        }

        .payment-options .btn:hover {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }

        .payment-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--color-border);
            animation: fadeIn 0.3s ease;
        }

        .payment-instruction {
            margin-bottom: 1rem;
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .btc-address-container {
            margin-top: 1rem;
        }

        .btc-address-container .input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .btc-address-container input {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--color-border);
            padding: 0.75rem;
            border-radius: 8px;
            color: var(--color-text);
            font-family: monospace;
            cursor: text;
        }

        #proceed-to-pay-crypto,
        #proceed-to-pay-card {
            width: 100%;
            margin-top: 1rem;
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 1rem;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #proceed-to-pay-crypto:hover,
        #proceed-to-pay-card:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
        }

        #copy-btc-address {
            background: var(--bg-card);
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #copy-btc-address:hover {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }
    </style>
    <style>
        .amount-input-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .balance-display {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }
        
        .withdrawal-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--color-border);
        }
        
        .code-input-group {
            position: relative;
        }
        
        #withdrawal-code {
            letter-spacing: 0.25em;
            font-family: monospace;
            text-align: center;
        }
        
        .withdrawal-code-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--color-border);
        }
        
        .input-hint {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            margin-top: 0.25rem;
        }
    </style>
    <style>
        /* Theme toggle button styles */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: none;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            cursor: pointer;
            margin-right: 1rem;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: rgba(64, 180, 103, 0.1);
        }

        .theme-toggle svg {
            width: 18px;
            height: 18px;
        }
    </style>
    <style>
        /* Mobile styles for transactions table */
        @media (max-width: 480px) {
            .transactions-table-container {
                margin: 0;
                width: 100%;
                overflow-x: hidden;
            }

            .transactions-table {
                width: 100%;
                font-size: 0.8rem;
                table-layout: fixed;
            }

            .transactions-table th,
            .transactions-table td {
                padding: 0.75rem 0.35rem;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            /* Column widths */
            .transactions-table th:nth-child(1),
            .transactions-table td:nth-child(1) {
                width: 32%;
                min-width: auto;
            }

            .transactions-table th:nth-child(2),
            .transactions-table td:nth-child(2) {
                width: 25%;
                min-width: auto;
            }

            .transactions-table th:nth-child(3),
            .transactions-table td:nth-child(3) {
                width: 23%;
                min-width: auto;
            }

            .transactions-table th:nth-child(4),
            .transactions-table td:nth-child(4) {
                display: none; /* Hide date column */
            }

            .transactions-table th:nth-child(5),
            .transactions-table td:nth-child(5) {
                width: 20%;
                min-width: auto;
                text-align: right;
            }

            /* Status badges */
            .status {
                padding: 0.15rem 0.35rem;
                font-size: 0.7rem;
                display: inline-block;
                text-align: center;
                min-width: 45px;
            }

            /* View button */
            .btn-sm {
                padding: 0.25rem 0.35rem;
                font-size: 0.75rem;
                min-width: 40px;
            }

            /* Card adjustments */
            .card {
                margin: 0 -1rem;
                border-radius: 0;
            }
        }
    </style>
    <!-- Portfolio panel styles -->
    <style>
        .portfolio-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--color-border);
        }

        .portfolio-summary > div:first-child {
            flex: 1;
        }

        .portfolio-summary > div:last-child {
            display: flex;
            gap: 0.5rem;
            flex-wrap: nowrap;
        }

        .portfolio-summary .btn {
            white-space: nowrap;
            padding: 0.65rem 1.25rem;
        }

        @media (max-width: 480px) {
            .portfolio-summary {
                padding: 1rem;
            }

            .portfolio-summary .stat-card-value {
                font-size: 1.5rem;
            }

            .portfolio-summary .btn {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 375px) {
            .portfolio-summary {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
                gap: 1rem;
            }

            .portfolio-summary > div:last-child {
                display: flex;
                justify-content: center;
                gap: 0.5rem;
            }

            .portfolio-summary .btn {
                min-width: 110px;
                flex: 0 1 auto;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="logo-container">
                <img src="assets/images/logo-light.svg" alt="Citron Trades" class="logo" onerror="this.onerror=null; this.src='assets/images/logo-light.png';">
            </div>
            
            <div class="nav-label">Dashboard</div>
            <div class="nav-item active" data-panel="overview">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></svg>
                Overview
            </div>
            <div class="nav-item" data-panel="portfolio">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                Portfolio
            </div>
            <div class="nav-item" data-panel="transactions">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                Transactions
            </div>
            <div class="nav-item" data-panel="auto-trade">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
                Auto Trade
            </div>
            
            <div class="nav-label">Account</div>
            <div class="nav-item" data-panel="profile">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                Profile
            </div>
            <div class="nav-item" data-panel="referrals">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                Referrals
            </div>
            <div class="nav-item" data-panel="chat">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                Support
            </div>
        </div>

        <!-- Main Content -->
        <div class="main" id="main">
            <!-- Add mobile header -->
            <div class="mobile-header">
                <div class="mobile-logo">C</div>
                <h1 class="header-title">Citron Trades</h1>
            </div>
            <div class="header">
                <div class="header-left">
                    <button class="toggle-btn" id="toggle-sidebar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </button>
                    <!-- Add mobile brand section -->
                    <div class="mobile-brand">
                        <img src="assets/images/logo-light.svg" alt="Citron Trades" class="logo" onerror="this.onerror=null; this.src='assets/images/logo-light.png';">
                    </div>
                    <div class="user-info">
                        <span id="user-name"></span>
                        <div class="account-manager">
                            Account Manager: <span id="account-manager">No Manager Assigned</span>
                        </div>
                    </div>
                    <button class="theme-toggle" id="theme-toggle" title="Toggle theme">
                        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </button>
                </div>
                <div class="header-actions">
                    <button id="logout-btn" class="btn btn-outline">Logout</button>
                </div>
            </div><!-- Overview Panel -->
            <div class="panel active" id="overview">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Account Overview</h2>
                        <button class="refresh-btn" id="refresh-overview">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 2v6h6M21.5 22v-6h-6"></path><path d="M22 11.5A10 10 0 0 0 3.2 7.2M2 12.5a10 10 0 0 0 18.8 4.2"></path></svg>
                        </button>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <h3>Total Balance</h3>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                            </div>
                            <div class="stat-card-value" id="overview-balance">$0.00</div>
                            <div class="stat-card-chart">
                                <canvas id="balance-chart" height="50"></canvas>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-card-header">
                                <h3>Last 24h Profit</h3>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-positive"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline><polyline points="16 7 22 7 22 13"></polyline></svg>
                            </div>
                            <div class="stat-card-value profit-value" id="profit-24h">+$0.00</div>
                            <div class="stat-card-chart">
                                <canvas id="profit-24h-chart" height="50"></canvas>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-card-header">
                                <h3>Account Level</h3>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-warning"><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"></path></svg>
                            </div>
                            <div class="stat-card-value" id="account-level">Basic</div>
                            <div class="stat-card-info">
                                <div class="level-progress">
                                    <div class="level-progress-bar" id="account-level-progress" style="width: 25%"></div>
                                </div>
                                <div class="level-progress-text">25% to Intermediate</div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-card-header">
                                <h3>Auto-Trade Status</h3>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-info"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                            </div>
                            <div class="stat-card-value" id="auto-profit-status">Disabled</div>
                            <div id="auto-profit-countdown" class="countdown-container" style="display: none;">
                                <div class="countdown-title">Next Trade in:</div>
                                <div class="countdown-timer" id="auto-profit-timer">00:00:00</div>
                            </div>
                            <div class="stat-card-actions">
                                <button class="btn btn-sm" id="enable-auto-profit">Enable Auto-Trade</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Warnings Section -->
                <div class="section" id="warnings-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">Important Notices</h2>
                    </div>
                    <div class="card">
                        <div class="card-content">
                            <div id="warnings-container">
                                <!-- Warnings will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Trade Performance</h2>
                        <div class="time-filter">
                            <button class="time-filter-btn active" data-period="24h">24h</button>
                            <button class="time-filter-btn" data-period="7d">7d</button>
                            <button class="time-filter-btn" data-period="30d">30d</button>
                            <button class="time-filter-btn" data-period="1y">1y</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-content">
                            <div class="profit-chart-container">
                                <canvas id="profit-chart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Recent Transactions</h2>
                        <a href="#" class="view-all" id="view-all-transactions">View All</a>
                    </div>

                    <div class="card">
                        <div class="transactions-table-container">
                            <table class="transactions-table">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-transactions">
                                    <!-- Transaction rows will be populated by JavaScript -->
                                    <tr>
                                        <td colspan="5" class="no-data">Loading transactions...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div><!-- Portfolio Panel -->
            <div class="panel" id="portfolio">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Your Portfolio</h2>
                        <button class="refresh-btn" id="refresh-portfolio">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 2v6h6M21.5 22v-6h-6"></path><path d="M22 11.5A10 10 0 0 0 3.2 7.2M2 12.5a10 10 0 0 0 18.8 4.2"></path></svg>
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="portfolio-summary">
                            <div>
                                <h3 class="card-title">Balance Overview</h3>
                                <div class="stat-card-value" id="portfolio-balance">$0.00</div>
                            </div>
                            <div>
                                <button class="btn" id="deposit-btn">Deposit</button>
                                <button class="btn btn-outline" id="withdraw-btn">Withdraw</button>
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="portfolio-chart-container">
                                <canvas id="portfolio-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Transaction History</h2>
                    </div>
                    
                    <div class="card">
                        <div class="transactions-table-container">
                            <table class="transactions-table">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody id="portfolio-transactions">
                                    <tr>
                                        <td colspan="5" class="no-data">Loading transactions...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transactions Panel -->
            <div class="panel" id="transactions">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Transaction History</h2>
                        <div class="transaction-filters">
                            <select id="transaction-type-filter">
                                <option value="all">All Types</option>
                                <option value="deposit">Deposits</option>
                                <option value="withdrawal">Withdrawals</option>
                                <option value="auto_profit">Auto Trade</option>
                            </select>
                            <select id="transaction-status-filter">
                                <option value="all">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="completed">Completed</option>
                                <option value="failed">Failed</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="transactions-table-container">
                            <table class="transactions-table">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody id="all-transactions">
                                    <tr>
                                        <td colspan="5" class="no-data">Loading transactions...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Auto Trade Panel -->
            <div class="panel" id="auto-trade">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Auto-Trade Settings</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Auto-Trade Status</h3>
                            <div class="auto-profit-toggle-wrapper">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="auto-profit-toggle">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span id="auto-profit-toggle-status">Disabled</span>
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="auto-profit-settings">
                                <div id="auto-profit-info" class="countdown-container" style="display: none;">
                                    <div class="countdown-title">Next Trade in:</div>
                                    <div class="countdown-timer" id="auto-trade-timer">00:00:00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Auto-Trade History</h2>
                    </div>
                    
                    <div class="card">
                        <div class="transactions-table-container">
                            <table class="transactions-table">
                                <thead>
                                    <tr>
                                        <th>Amount</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody id="auto-profit-history">
                                    <tr>
                                        <td colspan="2" class="no-data">Loading auto-trade history...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Panel -->
            <div class="panel" id="profile">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Profile Information</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-content">
                            <div class="profile-picture-section">
                                <div class="profile-picture-container">
                                    <div class="profile-picture" id="profile-picture">
                                        <!-- Profile picture or initial will be displayed here -->
                                    </div>
                                    <div class="profile-picture-upload">
                                        <input type="file" id="profile-photo" accept="image/*" style="display: none;">
                                        <button class="btn btn-sm" id="upload-profile-photo">Change Photo</button>
                                    </div>
                                </div>
                            </div>

                            <form id="profile-form">
                                <div class="form-row">
                                    <div class="form-col">
                                        <div class="form-group">
                                            <label for="profile-name">Full Name</label>
                                            <input type="text" id="profile-name" disabled>
                                        </div>
                                    </div>
                                    <div class="form-col">
                                        <div class="form-group">
                                            <label for="profile-dob">Date of Birth</label>
                                            <input type="date" id="profile-dob" disabled>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-col">
                                        <div class="form-group">
                                            <label for="profile-email">Email</label>
                                            <input type="email" id="profile-email" disabled>
                                        </div>
                                    </div>
                                    <div class="form-col">
                                        <div class="form-group">
                                            <label for="profile-phone">Phone Number</label>
                                            <input type="tel" id="profile-phone" disabled>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-col">
                                        <div class="form-group">
                                            <label for="profile-nationality">Nationality</label>
                                            <input type="text" id="profile-nationality" disabled>
                                        </div>
                                    </div>
                                    <div class="form-col">
                                        <div class="form-group">
                                            <label for="profile-account-level">Account Level</label>
                                            <input type="text" id="profile-account-level" disabled>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="profile-address">Residential Address</label>
                                    <textarea id="profile-address" rows="3" disabled></textarea>
                                </div>

                                <div class="profile-actions">
                                    <button type="button" class="btn" id="edit-profile-btn">Edit Profile</button>
                                    <button type="submit" class="btn" id="save-profile" style="display: none;">Save Changes</button>
                                    <button type="button" class="btn btn-outline" id="cancel-edit" style="display: none;">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Financial Information</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-content">
                            <form id="financial-form">
                                <div class="form-row">
                                    <div class="form-col">
                                        <div class="form-group">
                                            <label for="employment-status">Employment Status</label>
                                            <select id="employment-status" disabled>
                                                <option value="">Select status</option>
                                                <option value="employed">Employed</option>
                                                <option value="self-employed">Self-Employed</option>
                                                <option value="business-owner">Business Owner</option>
                                                <option value="retired">Retired</option>
                                                <option value="student">Student</option>
                                                <option value="unemployed">Unemployed</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-col">
                                        <div class="form-group">
                                            <label for="income-source">Source of Income</label>
                                            <select id="income-source" disabled>
                                                <option value="">Select source</option>
                                                <option value="salary">Salary</option>
                                                <option value="business">Business Income</option>
                                                <option value="investments">Investment Returns</option>
                                                <option value="inheritance">Inheritance</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-col">
                                        <div class="form-group">
                                            <label for="annual-income">Annual Income Range</label>
                                            <select id="annual-income" disabled>
                                                <option value="">Select range</option>
                                                <option value="0-50k">$0 - $50,000</option>
                                                <option value="50k-100k">$50,000 - $100,000</option>
                                                <option value="100k-250k">$100,000 - $250,000</option>
                                                <option value="250k-500k">$250,000 - $500,000</option>
                                                <option value="500k+">$500,000+</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-col">
                                        <div class="form-group">
                                            <label for="trading-experience">Trading Experience</label>
                                            <select id="trading-experience" disabled>
                                                <option value="">Select experience</option>
                                                <option value="beginner">Beginner (0-1 year)</option>
                                                <option value="intermediate">Intermediate (1-3 years)</option>
                                                <option value="advanced">Advanced (3-5 years)</option>
                                                <option value="expert">Expert (5+ years)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="trading-goals">Trading Goals</label>
                                    <select id="trading-goals" disabled>
                                        <option value="">Select goal</option>
                                        <option value="income">Regular Income</option>
                                        <option value="growth">Long-term Growth</option>
                                        <option value="speculation">Short-term Speculation</option>
                                        <option value="hedging">Portfolio Hedging</option>
                                    </select>
                                </div>

                                <div class="profile-actions">
                                    <button type="button" class="btn" id="edit-financial-btn">Edit Information</button>
                                    <button type="submit" class="btn" id="save-financial" style="display: none;">Save Changes</button>
                                    <button type="button" class="btn btn-outline" id="cancel-financial-edit" style="display: none;">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Security Settings</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-content">
                            <div class="form-group">
                                <label>Account Security</label>
                                <p class="input-hint">Manage your account security settings</p>
                                <div class="profile-actions">
                                    <button class="btn" id="change-password-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                                        Change Password
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">KYC Verification</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-content">
                            <div class="kyc-status-container">
                                <div class="kyc-status">
                                    <h3>Verification Status</h3>
                                    <div class="status-badge" id="kyc-status-badge">Not Verified</div>
                                </div>
                                <div class="kyc-message" id="kyc-message"></div>
                            </div>

                            <div class="kyc-upload-container" id="kyc-upload-container">
                                <div class="form-group">
                                    <label for="kyc-photo">Upload Verification Document</label>
                                    <input type="file" id="kyc-photo" accept="image/*" style="display: none;">
                                    <div class="upload-btn-wrapper">
                                        <button class="btn" id="kyc-upload-btn">Choose File</button>
                                        <span id="selected-file-name">No file chosen</span>
                                    </div>
                                    <div class="input-hint">Upload a clear photo of your government-issued ID (max size: 1MB)</div>
                                </div>
                                <div class="preview-container" id="kyc-preview-container" style="display: none;">
                                    <img id="kyc-preview" alt="KYC Document Preview" style="max-width: 100%; border-radius: 8px;">
                                </div>
                                <button class="btn" id="submit-kyc" style="display: none;">Submit for Verification</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Regulatory Compliance</h2>
                        <div class="section-subtitle">Required for accounts with balance over $150,000</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-content">
                            <form id="regulatory-form">
                                <div class="form-group">
                                    <label>Identification Type</label>
                                    <div class="radio-group">
                                        <label class="radio-label">
                                            <input type="radio" name="id-type" value="tax" checked>
                                            Tax Identification Number
                                        </label>
                                        <label class="radio-label">
                                            <input type="radio" name="id-type" value="ssn">
                                            Social Security Number
                                        </label>
                                    </div>
                                </div>

                                <div id="tax-id-section">
                                    <div class="form-group">
                                        <label for="tax-id">Tax Identification Number</label>
                                        <input type="text" id="tax-id" placeholder="Enter your Tax ID">
                                    </div>
                                </div>

                                <div id="ssn-section" style="display: none;">
                                    <div class="form-group">
                                        <label for="ssn">Social Security Number</label>
                                        <input type="text" id="ssn" placeholder="Enter your SSN">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="ssn-card">Upload Social Security Card</label>
                                        <input type="file" id="ssn-card" accept="image/*" style="display: none;">
                                        <div class="upload-btn-wrapper">
                                            <button type="button" class="btn" id="ssn-upload-btn">Choose File</button>
                                            <span id="ssn-file-name">No file chosen</span>
                                        </div>
                                        <div class="preview-container" id="ssn-preview-container" style="display: none;">
                                            <img id="ssn-preview" alt="SSN Card Preview" style="max-width: 100%; border-radius: 8px;">
                                        </div>
                                    </div>
                                </div>

                                <div class="profile-actions">
                                    <button type="submit" class="btn" id="save-regulatory">Save Information</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Referrals Panel -->
            <div class="panel" id="referrals">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Your Referral Link</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-content">
                            <p>Share your referral link with friends and earn 10% of their profits!</p>
                            <div class="form-group">
                                <label for="referral-link">Your Referral Link</label>
                                <div class="input-with-copy">
                                    <input type="text" id="referral-link" value="" readonly>
                                    <button class="btn" id="copy-referral-link">Copy</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Your Referrals</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-content">
                            <div class="referral-stats">
                                <div class="referral-stat-card">
                                    <div class="referral-stat-value" id="total-referrals">0</div>
                                    <div class="referral-stat-label">Total Referrals</div>
                                </div>
                                <div class="referral-stat-card">
                                    <div class="referral-stat-value" id="total-earnings">$0.00</div>
                                    <div class="referral-stat-label">Total Earnings</div>
                                </div>
                            </div>
                            
                            <div class="referrals-list" id="referrals-list">
                                <div class="no-data">You haven't referred anyone yet.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Support Panel -->
            <div class="panel" id="chat">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Support Chat</h2>
                    </div>
                    
                    <div class="chat-container">
                        <div class="chat-messages" id="chat-messages">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <div class="chat-input-container">
                            <input type="text" class="chat-input" id="chat-input" placeholder="Type your message here...">
                            <button class="btn" id="send-message">Send</button>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Contact Information</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-content">
                            <p>If you need immediate assistance, please contact us:</p>
                            <div class="contact-info">
                                <p>Email: <a href="mailto:support@citrontrades.com">support@citrontrades.com</a></p>
                                <p>Working Hours: Monday to Friday, 9 AM - 5 PM EST</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div><!-- Deposit Modal -->
    <div class="modal" id="deposit-modal">
        <div class="modal-content">
            <button class="close-modal" id="close-deposit-modal"></button>
            <h2 class="modal-title">Make a Deposit</h2>
            
            <div class="form-group">
                <label for="deposit-amount">Amount ($)</label>
                <input type="number" id="deposit-amount" min="1" step="0.01" placeholder="Enter amount">
            </div>

            <div class="payment-options">
                <button id="pay-with-crypto" class="btn">Pay With Crypto</button>
                <button id="pay-with-card" class="btn">Pay With Card</button>
            </div>

            <div id="crypto-payment-section" class="payment-section" style="display: none;">
                <p class="payment-instruction">Click below to proceed with crypto payment</p>
                <button id="proceed-to-pay-crypto" class="btn">Proceed to Pay</button>
            </div>

            <div id="card-payment-section" class="payment-section" style="display: none;">
                <div class="btc-address-container">
                    <p class="payment-instruction">Click the copy button below to copy the Bitcoin address and paste it in your crypto payment in the next platform after clicking "Proceed to Pay"</p>
                    <div class="input-group">
                        <input type="text" id="btc-address" readonly>
                        <button id="copy-btc-address" class="btn">Copy</button>
                    </div>
                    <button id="proceed-to-pay-card" class="btn">Proceed to Pay</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Withdraw Modal -->
    <div class="modal" id="withdraw-modal">
        <div class="modal-content">
            <button class="close-modal" id="close-withdraw-modal"></button>
            <h2 class="modal-title">Withdraw Funds</h2>
            
            <div class="form-group">
                <label for="withdraw-amount">Amount</label>
                <div class="amount-input-group">
                    <input type="number" id="withdraw-amount" placeholder="0.00" min="10" step="0.01">
                    <div class="balance-display">Available: <span id="available-balance">$0.00</span></div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="withdraw-method">Withdrawal Method</label>
                <select id="withdraw-method">
                    <option value="">Select withdrawal method</option>
                    <option value="crypto">Crypto Withdrawal</option>
                    <option value="bank">Bank Transfer</option>
                </select>
            </div>
            
            <!-- Crypto Withdrawal Section -->
            <div id="crypto-withdrawal-section" class="withdrawal-section" style="display: none;">
                <div class="form-group">
                    <label for="crypto-currency">Select Cryptocurrency</label>
                    <select id="crypto-currency">
                        <option value="BTC">Bitcoin (BTC)</option>
                        <option value="USDT">Tether (USDT)</option>
                        <option value="ETH">Ethereum (ETH)</option>
                        <option value="LTC">Litecoin (LTC)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="crypto-address">Wallet Address</label>
                    <input type="text" id="crypto-address" placeholder="Enter your wallet address">
                </div>
            </div>
            
            <!-- Bank Transfer Section -->
            <div id="bank-withdrawal-section" class="withdrawal-section" style="display: none;">
                <div class="form-group">
                    <label for="bank-name">Bank Name</label>
                    <input type="text" id="bank-name" placeholder="Enter your bank name">
                </div>
                
                <div class="form-group">
                    <label for="account-name">Account Name</label>
                    <input type="text" id="account-name" placeholder="Enter account name">
                    <div class="input-hint">Name must match your broker account name</div>
                </div>
                
                <div class="form-group">
                    <label for="account-number">Account Number</label>
                    <input type="text" id="account-number" placeholder="Enter account number">
                </div>
                
                <div class="form-group">
                    <label for="routing-number">Routing Number</label>
                    <input type="text" id="routing-number" placeholder="Enter routing number (if required)">
                    <div class="input-hint">Not required if your bank doesn't use routing numbers</div>
                </div>
            </div>
            
            <!-- Withdrawal Code Section -->
            <div class="form-group withdrawal-code-section">
                <label for="withdrawal-code">Withdrawal Code</label>
                <div class="code-input-group">
                    <input type="text" id="withdrawal-code" placeholder="Enter 6-digit withdrawal code" maxlength="6">
                    <div class="input-hint">Contact support if you don't have a withdrawal code</div>
                </div>
            </div>
            
            <div class="form-actions">
                <button class="btn btn-outline" id="cancel-withdraw">Cancel</button>
                <button class="btn" id="submit-withdraw">Submit Withdrawal</button>
            </div>
        </div>
    </div>
    
    
    <!-- Transaction Details Modal -->
    <div class="modal" id="transaction-details-modal">
        <div class="modal-content">
            <button class="close-modal" id="close-transaction-modal"></button>
            <h2 class="modal-title">Transaction Details</h2>
            
            <div id="transaction-details-content">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <div class="form-actions">
                <button class="btn" id="close-transaction-details">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Core Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script><script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updatePassword, reauthenticateWithCredential, EmailAuthProvider, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, arrayUnion, Timestamp, onSnapshot, collection, query, where, orderBy, getDocs, addDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAEPH6zPhhmyrAL8YPKzJWZZVOT8LScpIg",
            authDomain: "invest-mgnt.firebaseapp.com",
            projectId: "invest-mgnt",
            storageBucket: "invest-mgnt.firebasestorage.app",
            messagingSenderId: "658245081425",
            appId: "1:658245081425:web:73eeaa2614e426030c1b70",
            measurementId: "G-F03JXGD2ZT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Global variables
        let currentUser = null;
        let userData = null;
        let userDocRef = null;
        let userUnsubscribe = null; // To detach Firestore listeners when needed
        let autoProfitTimer = null;  // To track auto-profit interval
        let transactionData = {}; // Store processed transaction data for charts
        let chartInstances = {}; // Store chart instances for updates
        
        // Console logging for debugging
        console.log('Firebase initialized');
        
        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const main = document.getElementById('main');
        const navItems = document.querySelectorAll('.nav-item');
        const logoutBtn = document.getElementById('logout-btn');
        const toggleSidebarBtn = document.getElementById('toggle-sidebar');
        
        // Wait for DOM to be loaded before setting up event listeners
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, setting up event listeners');
            setupNavigation();
            setupLogout();
            setupModals();
        });
        
        // Setup Navigation
        function setupNavigation() {
            // Toggle sidebar
            const toggleSidebarBtn = document.getElementById('toggle-sidebar');
            const closeSidebarBtn = document.getElementById('close-sidebar');
            const sidebar = document.getElementById('sidebar');
            const main = document.getElementById('main');
            
            toggleSidebarBtn.addEventListener('click', () => {
                console.log('Toggle sidebar clicked');
                if (window.innerWidth <= 1024) {
                    sidebar.classList.toggle('visible');
                } else {
                sidebar.classList.toggle('hidden');
                main.classList.toggle('full');
                }
            });

            // Close sidebar on mobile
            if (closeSidebarBtn) {
                closeSidebarBtn.addEventListener('click', () => {
                    sidebar.classList.remove('visible');
                });
            }

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 1024 && 
                    !sidebar.contains(e.target) && 
                    !toggleSidebarBtn.contains(e.target) &&
                    sidebar.classList.contains('visible')) {
                    sidebar.classList.remove('visible');
                }
            });

            // Close sidebar when clicking nav items on mobile
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    if (window.innerWidth <= 1024) {
                        sidebar.classList.remove('visible');
                    }
                });
            });
            
            // Panel switching
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const panelId = item.getAttribute('data-panel');
                    console.log(`Nav item clicked: ${panelId}`);
                    
                    // Remove active class from all nav items
                    navItems.forEach(nav => nav.classList.remove('active'));
                    
                    // Add active class to clicked nav item
                    item.classList.add('active');
                    
                    // Hide all panels
                    const panels = document.querySelectorAll('.panel');
                    panels.forEach(panel => panel.classList.remove('active'));
                    
                    // Show selected panel
                    const panel = document.getElementById(panelId);
                    if (panel) {
                        panel.classList.add('active');
                        document.getElementById('panel-title').textContent = panelId.charAt(0).toUpperCase() + panelId.slice(1);
                        console.log(`Panel ${panelId} activated`);
                    } else {
                        console.error(`Panel with ID ${panelId} not found`);
                    }
                });
            });
            
            // View all transactions link
            const viewAllTransactionsLink = document.getElementById('view-all-transactions');
            if (viewAllTransactionsLink) {
                viewAllTransactionsLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelector('.nav-item[data-panel="transactions"]').click();
                });
            }
        }
        
        // Setup Logout Button
        function setupLogout() {
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Logout button clicked');
                    
                    // Clear auto-profit timer if running
                    if (autoProfitTimer) {
                        clearInterval(autoProfitTimer);
                    }
                    
                    // Detach Firestore listeners
                    if (userUnsubscribe) {
                        userUnsubscribe();
                    }
                    
                    signOut(auth)
                        .then(() => {
                            console.log('User signed out successfully');
                            window.location.href = 'login.html';
                        })
                        .catch((error) => {
                            console.error('Error signing out:', error);
                            alert('Error signing out: ' + error.message);
                        });
                });
            } else {
                console.error('Logout button not found in DOM');
            }
        }
        
        // Setup Modals
        function setupModals() {
            // Change Password Button Click Handler
            document.getElementById('change-password-btn').addEventListener('click', handlePasswordReset);

            // Deposit Modal
            const depositBtn = document.getElementById('deposit-btn');
            const depositModal = document.getElementById('deposit-modal');
            const closeDepositModal = document.getElementById('close-deposit-modal');
            const cancelDeposit = document.getElementById('cancel-deposit');
            const submitDeposit = document.getElementById('submit-deposit');
            
            if (depositBtn && depositModal) {
                depositBtn.addEventListener('click', () => {
                    depositModal.style.display = 'flex';
                });
                
                closeDepositModal.addEventListener('click', () => {
                    depositModal.style.display = 'none';
                });
                
                if (cancelDeposit) {
                    cancelDeposit.addEventListener('click', () => {
                        depositModal.style.display = 'none';
                    });
                }
                
                if (submitDeposit) {
                    submitDeposit.addEventListener('click', handleDepositSubmit);
                }
            }
            
            // Withdraw Modal
            const withdrawBtn = document.getElementById('withdraw-btn');
            const withdrawModal = document.getElementById('withdraw-modal');
            const closeWithdrawModal = document.getElementById('close-withdraw-modal');
            const cancelWithdraw = document.getElementById('cancel-withdraw');
            const submitWithdraw = document.getElementById('submit-withdraw');
            
            if (withdrawBtn && withdrawModal) {
                withdrawBtn.addEventListener('click', () => {
                    // Update available balance
                    document.getElementById('available-balance').textContent = `$${userData.balance.toFixed(2)}`;
                    withdrawModal.style.display = 'flex';
                });
                
                if (closeWithdrawModal) {
                    closeWithdrawModal.addEventListener('click', () => {
                        withdrawModal.style.display = 'none';
                    });
                }
                
                if (cancelWithdraw) {
                    cancelWithdraw.addEventListener('click', () => {
                        withdrawModal.style.display = 'none';
                    });
                }
                
                if (submitWithdraw) {
                    submitWithdraw.addEventListener('click', handleWithdrawSubmit);
                }
            }
            
            // Change Password Modal
            const changePasswordBtn = document.getElementById('change-password-btn');
            const passwordModal = document.getElementById('change-password-modal');
            const closePasswordModal = document.getElementById('close-password-modal');
            const cancelPasswordChange = document.getElementById('cancel-password-change');
            const savePassword = document.getElementById('save-password');
            
            if (changePasswordBtn && passwordModal) {
                changePasswordBtn.addEventListener('click', () => {
                    passwordModal.style.display = 'flex';
                });
                
                closePasswordModal.addEventListener('click', () => {
                    passwordModal.style.display = 'none';
                });
                
                cancelPasswordChange.addEventListener('click', () => {
                    passwordModal.style.display = 'none';
                });
                
                savePassword.addEventListener('click', handlePasswordChange);
            }
            
            // Transaction Details Modal
            const transactionModal = document.getElementById('transaction-details-modal');
            const closeTransactionModal = document.getElementById('close-transaction-modal');
            const closeTransactionDetails = document.getElementById('close-transaction-details');
            
            if (transactionModal) {
                closeTransactionModal.addEventListener('click', () => {
                    transactionModal.style.display = 'none';
                });
                
                closeTransactionDetails.addEventListener('click', () => {
                    transactionModal.style.display = 'none';
                });
            }
        }
        
        // Authentication Check
        onAuthStateChanged(auth, async (user) => {
            console.log('Auth state changed', user ? 'User logged in' : 'No user');
            
            if (user) {
                currentUser = user;
                userDocRef = doc(db, 'users', user.uid);
                
                try {
                    const userDoc = await getDoc(userDocRef);
                    
                    if (!userDoc.exists()) {
                        console.error('User document does not exist');
                        alert('User data not found. Please contact support.');
                        return;
                    }
                    
                    // Check if user is admin
                    if (userDoc.data().role === 'admin') {
                        console.log('User is admin, redirecting to admin page');
                        window.location.href = 'admin.html';
                        return;
                    }
                    
                    // Store user data
                    userData = userDoc.data();
                    console.log('User data loaded:', userData);
                    
                    // Generate any missed auto trades
                    await generateMissedAutoTrades();
                    
                    // Initialize the dashboard
                    initializeDashboard();
                    
                    // Setup real-time listeners
                    setupRealTimeListeners();
                    
                } catch (error) {
                    console.error('Error loading user data:', error);
                    alert('Error loading user data: ' + error.message);
                }
            } else {
                console.log('No user logged in, redirecting to login page');
                window.location.href = 'login.html';
            }
        });
        
        // Setup Real-time Data Listeners
        function setupRealTimeListeners() {
            console.log('Setting up real-time listeners');
            
            // Unsubscribe from previous listener if exists
            if (userUnsubscribe) {
                userUnsubscribe();
            }
            
            // Listen for changes to the user document
            userUnsubscribe = onSnapshot(userDocRef, (doc) => {
                if (doc.exists()) {
                    console.log('User data updated in real-time');
                    
                    // Store previous values to check for changes
                    const oldData = userData;
                    userData = doc.data();
                    
                    // Update UI
                    updateUserInfo();
                    
                    // Update specific panels if needed
                    updateDashboardData(oldData);
                    
                    // Check for auto-profit status changes
                    if (oldData && oldData.autoProfitEnabled !== userData.autoProfitEnabled) {
                        handleAutoProfitStatusChange();
                    }
                    
                    // Check for new transactions in history
                    if (oldData && oldData.history && userData.history &&
                        oldData.history.length !== userData.history.length) {
                        // History has changed, update transaction-related UI
                        processTransactionData();
                        updateTransactionTables();
                        updateCharts();
                    }
                    
                    // Check for new messages
                    if (oldData && oldData.messages && userData.messages &&
                        oldData.messages.length !== userData.messages.length) {
                        // Messages have changed, update chat UI
                        loadChatMessages();
                    }
                }
            }, (error) => {
                console.error('Error in real-time listener:', error);
            });
        }
        
        // Initialize Dashboard
        function initializeDashboard() {
            console.log('Initializing dashboard');
            
            // Update user info in the header
            updateUserInfo();
            
            // Process transaction data for charts and displays
            processTransactionData();
            
            // Initialize all panels
            initializeOverviewPanel();
            initializePortfolioPanel();
            initializeTransactionsPanel();
            initializeAutoTradePanel();
            initializeProfilePanel();
            initializeReferralsPanel();
            initializeChatPanel();
            
            // Initialize charts
            setTimeout(() => {
                try {
                    initializeCharts();
                } catch (error) {
                    console.error('Error initializing charts:', error);
                }
            }, 500);
            
            // Setup auto-profit timer if enabled
            if (userData.autoProfitEnabled) {
                startAutoProfitTimer();
            }
        }
        
        // Update User Info in Header
        function updateUserInfo() {
            console.log('Updating user info');
            
            if (!userData) {
                console.error('No user data available');
                return;
            }
            
            // Update user name
            const userNameElement = document.getElementById('user-name');
            if (userNameElement) {
                userNameElement.textContent = userData.name || currentUser.email.split('@')[0];
            }
            
            // Update account manager
            const accountManagerElement = document.getElementById('account-manager');
            if (accountManagerElement) {
                accountManagerElement.textContent = userData.accountManager || 'No Manager Assigned';
            }
            
            // Update balance
            const balanceElements = document.querySelectorAll('#user-balance, #overview-balance, #portfolio-balance, #available-balance');
            balanceElements.forEach(element => {
                if (element) element.textContent = `$${userData.balance.toFixed(2)}`;
            });

            // Update warnings
            const warningsSection = document.getElementById('warnings-section');
            const warningsContainer = document.getElementById('warnings-container');
            
            if (warningsSection && warningsContainer) {
                // Only show warnings if user's showWarnings flag is not false
                if (userData.warnings && userData.warnings.length > 0 && userData.showWarnings !== false) {
                    // Sort warnings by timestamp (newest first) and get the most recent one
                    const warnings = [...userData.warnings].sort((a, b) => {
                        const timeA = a.timestamp && a.timestamp.toMillis ? a.timestamp.toMillis() : (a.timestamp ? new Date(a.timestamp).getTime() : 0);
                        const timeB = b.timestamp && b.timestamp.toMillis ? b.timestamp.toMillis() : (b.timestamp ? new Date(b.timestamp).getTime() : 0);
                        return timeB - timeA;
                    });
                    
                    const mostRecentWarning = warnings[0];
                    
                    // Show warnings section
                    warningsSection.style.display = 'block';
                    
                    // Render only the most recent warning message without metadata
                    warningsContainer.innerHTML = `
                        <div class="warning-item">
                            <div class="warning-message">${mostRecentWarning.message}</div>
                        </div>
                    `;
                    
                    // Mark warning as read
                    if (!mostRecentWarning.read) {
                        updateDoc(userDocRef, {
                            warnings: warnings.map((w, index) => 
                                index === 0 ? { ...w, read: true } : w
                            )
                        }).catch(error => {
                            console.error('Error marking warning as read:', error);
                        });
                    }
                } else {
                    // Hide warnings section if no warnings or showWarnings is false
                    warningsSection.style.display = 'none';
                }
            }
            
            console.log('User info updated successfully');
        }
        
        // Process Transaction Data
        function processTransactionData() {
            console.log('Processing transaction data');
            
            if (!userData || !userData.history) {
                console.log('No transaction history available');
                transactionData = {
                    balance: [],
                    profit24h: 0,
                    profitData: {
                        '24h': [],
                        '7d': [],
                        '30d': [],
                        '1y': []
                    }
                };
                return;
            }
            
            // Filter out admin-only transactions
            const filteredHistory = userData.history.filter(tx => {
                // Filter out balance adjustments and admin-only transactions
                return !tx.type.includes('balance_adjustment') && !tx.adminOnly;
            });
            
            // Sort history by date
            const sortedHistory = [...filteredHistory].sort((a, b) => {
                const dateA = a.date && a.date.toMillis ? a.date.toMillis() : (a.date ? new Date(a.date).getTime() : 0);
                const dateB = b.date && b.date.toMillis ? b.date.toMillis() : (b.date ? new Date(b.date).getTime() : 0);
                return dateA - dateB;
            });
            
            // Calculate cumulative balance over time
            let balance = [];
            let runningBalance = 0;
            
            sortedHistory.forEach(transaction => {
                const amount = getTransactionAmount(transaction);
                const type = getTransactionType(transaction);
                const isDeposit = type === 'deposit' && transaction.type.includes('approved');
                const isWithdrawal = type === 'withdrawal' && transaction.type.includes('approved');
                const isAutoProfitCredit = type === 'auto_profit';
                
                if (isDeposit || isAutoProfitCredit) {
                    runningBalance += amount;
                } else if (isWithdrawal) {
                    runningBalance -= amount;
                }
                
                const date = transaction.date && transaction.date.toMillis 
                    ? new Date(transaction.date.toMillis()) 
                    : new Date(transaction.date);
                
                balance.push({
                    date,
                    balance: runningBalance
                });
            });
            
            // Calculate 24h profit
            const now = new Date();
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            
            // Filter transactions from last 24 hours
            const last24hTransactions = sortedHistory.filter(transaction => {
                const transactionDate = transaction.date && transaction.date.toMillis 
                    ? new Date(transaction.date.toMillis()) 
                    : new Date(transaction.date);
                return transactionDate >= yesterday && transactionDate <= now;
            });
            
            // Calculate profit from these transactions
            let profit24h = 0;
            
            last24hTransactions.forEach(transaction => {
                const amount = getTransactionAmount(transaction);
                const type = getTransactionType(transaction);
                
                if (type === 'deposit' && transaction.type.includes('approved')) {
                    profit24h += amount;
                } else if (type === 'withdrawal' && transaction.type.includes('approved')) {
                    profit24h -= amount;
                } else if (type === 'auto_profit') {
                    profit24h += amount;
                }
            });
            
            // Generate time-filtered data for profit chart
            const profitData = {
                '24h': generate24hProfitData(sortedHistory),
                '7d': generate7dProfitData(sortedHistory),
                '30d': generate30dProfitData(sortedHistory),
                '1y': generate1yProfitData(sortedHistory)
            };
            
            // Store processed data
            transactionData = {
                balance,
                profit24h,
                profitData
            };
            
            console.log('Transaction data processed:', transactionData);
        }
        
        // Helper function to get transaction amount
        function getTransactionAmount(transaction) {
            // First try to get amount from details object
            if (transaction.details && transaction.details.amount) {
                return parseFloat(transaction.details.amount);
            }
            
            // Then try direct amount field
            if (transaction.amount) {
                return parseFloat(transaction.amount);
            }
            
            // Default to 0 if no amount found
            return 0;
        }
        
        // Helper function to get transaction type
        function getTransactionType(transaction) {
            const type = transaction.type || '';
            
            if (type.includes('deposit')) {
                return 'deposit';
            } else if (type.includes('withdrawal')) {
                return 'withdrawal';
            } else if (type === 'auto_profit') {
                return 'auto_profit';
            }
            
            return 'unknown';
        }// Generate profit data for different time periods
        function generate24hProfitData(transactions) {
            const now = new Date();
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            
            // Create 24 hour slots
            const hourSlots = [];
            for (let i = 0; i < 24; i++) {
                const slot = new Date(yesterday);
                slot.setHours(yesterday.getHours() + i);
                hourSlots.push({
                    label: slot.getHours() + ':00',
                    date: slot,
                    profit: 0
                });
            }
            
            // Filter transactions from last 24 hours and fill slots
            transactions.forEach(transaction => {
                const transactionDate = transaction.date && transaction.date.toMillis 
                    ? new Date(transaction.date.toMillis()) 
                    : new Date(transaction.date);
                
                if (transactionDate >= yesterday && transactionDate <= now) {
                    const amount = getTransactionAmount(transaction);
                    const type = getTransactionType(transaction);
                    const hour = transactionDate.getHours();
                    const slotIndex = Math.floor((transactionDate - yesterday) / (60 * 60 * 1000));
                    
                    if (slotIndex >= 0 && slotIndex < hourSlots.length) {
                        if (type === 'deposit' && transaction.type.includes('approved')) {
                            hourSlots[slotIndex].profit += amount;
                        } else if (type === 'withdrawal' && transaction.type.includes('approved')) {
                            hourSlots[slotIndex].profit -= amount;
                        } else if (type === 'auto_profit') {
                            hourSlots[slotIndex].profit += amount;
                        }
                    }
                }
            });
            
            // Calculate cumulative profit
            let cumulativeProfit = 0;
            const profitData = hourSlots.map(slot => {
                cumulativeProfit += slot.profit;
                return {
                    label: slot.label,
                    profit: cumulativeProfit
                };
            });
            
            return profitData;
        }
        
        function generate7dProfitData(transactions) {
            const now = new Date();
            const sevenDaysAgo = new Date(now);
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            // Create 7 day slots
            const daySlots = [];
            for (let i = 0; i < 7; i++) {
                const slot = new Date(sevenDaysAgo);
                slot.setDate(sevenDaysAgo.getDate() + i);
                daySlots.push({
                    label: days[slot.getDay()],
                    date: slot,
                    profit: 0
                });
            }
            
            // Filter transactions from last 7 days
            transactions.forEach(transaction => {
                const transactionDate = transaction.date && transaction.date.toMillis 
                    ? new Date(transaction.date.toMillis()) 
                    : new Date(transaction.date);
                
                if (transactionDate >= sevenDaysAgo && transactionDate <= now) {
                    const amount = getTransactionAmount(transaction);
                    const type = getTransactionType(transaction);
                    const day = transactionDate.getDay();
                    const slotIndex = Math.floor((transactionDate - sevenDaysAgo) / (24 * 60 * 60 * 1000));
                    
                    if (slotIndex >= 0 && slotIndex < daySlots.length) {
                        if (type === 'deposit' && transaction.type.includes('approved')) {
                            daySlots[slotIndex].profit += amount;
                        } else if (type === 'withdrawal' && transaction.type.includes('approved')) {
                            daySlots[slotIndex].profit -= amount;
                        } else if (type === 'auto_profit') {
                            daySlots[slotIndex].profit += amount;
                        }
                    }
                }
            });
            
            // Calculate cumulative profit
            let cumulativeProfit = 0;
            const profitData = daySlots.map(slot => {
                cumulativeProfit += slot.profit;
                return {
                    label: slot.label,
                    profit: cumulativeProfit
                };
            });
            
            return profitData;
        }
        
        function generate30dProfitData(transactions) {
            const now = new Date();
            const thirtyDaysAgo = new Date(now);
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            // Create 30 day slots
            const daySlots = [];
            for (let i = 0; i < 30; i++) {
                const slot = new Date(thirtyDaysAgo);
                slot.setDate(thirtyDaysAgo.getDate() + i);
                daySlots.push({
                    label: (i + 1).toString(),
                    date: slot,
                    profit: 0
                });
            }
            
            // Filter transactions from last 30 days
            transactions.forEach(transaction => {
                const transactionDate = transaction.date && transaction.date.toMillis 
                    ? new Date(transaction.date.toMillis()) 
                    : new Date(transaction.date);
                
                if (transactionDate >= thirtyDaysAgo && transactionDate <= now) {
                    const amount = getTransactionAmount(transaction);
                    const type = getTransactionType(transaction);
                    const slotIndex = Math.floor((transactionDate - thirtyDaysAgo) / (24 * 60 * 60 * 1000));
                    
                    if (slotIndex >= 0 && slotIndex < daySlots.length) {
                        if (type === 'deposit' && transaction.type.includes('approved')) {
                            daySlots[slotIndex].profit += amount;
                        } else if (type === 'withdrawal' && transaction.type.includes('approved')) {
                            daySlots[slotIndex].profit -= amount;
                        } else if (type === 'auto_profit') {
                            daySlots[slotIndex].profit += amount;
                        }
                    }
                }
            });
            
            // Calculate cumulative profit
            let cumulativeProfit = 0;
            const profitData = daySlots.map(slot => {
                cumulativeProfit += slot.profit;
                return {
                    label: slot.label,
                    profit: cumulativeProfit
                };
            });
            
            return profitData;
        }
        
        function generate1yProfitData(transactions) {
            const now = new Date();
            const oneYearAgo = new Date(now);
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            // Create 12 month slots
            const monthSlots = [];
            for (let i = 0; i < 12; i++) {
                const slot = new Date(oneYearAgo);
                slot.setMonth(oneYearAgo.getMonth() + i);
                monthSlots.push({
                    label: months[slot.getMonth()],
                    date: slot,
                    profit: 0
                });
            }
            
            // Filter transactions from last year
            transactions.forEach(transaction => {
                const transactionDate = transaction.date && transaction.date.toMillis 
                    ? new Date(transaction.date.toMillis()) 
                    : new Date(transaction.date);
                
                if (transactionDate >= oneYearAgo && transactionDate <= now) {
                    const amount = getTransactionAmount(transaction);
                    const type = getTransactionType(transaction);
                    const month = transactionDate.getMonth();
                    const year = transactionDate.getFullYear();
                    const slotIndex = (year - oneYearAgo.getFullYear()) * 12 + month - oneYearAgo.getMonth();
                    
                    if (slotIndex >= 0 && slotIndex < monthSlots.length) {
                        if (type === 'deposit' && transaction.type.includes('approved')) {
                            monthSlots[slotIndex].profit += amount;
                        } else if (type === 'withdrawal' && transaction.type.includes('approved')) {
                            monthSlots[slotIndex].profit -= amount;
                        } else if (type === 'auto_profit') {
                            monthSlots[slotIndex].profit += amount;
                        }
                    }
                }
            });
            
            // Calculate cumulative profit
            let cumulativeProfit = 0;
            const profitData = monthSlots.map(slot => {
                cumulativeProfit += slot.profit;
                return {
                    label: slot.label,
                    profit: cumulativeProfit
                };
            });
            
            return profitData;
        }
        
        // Update Dashboard Data
        function updateDashboardData(oldData) {
            console.log('Updating dashboard with new data');
            
            // Update account level
            const accountLevelElements = document.querySelectorAll('#account-level, #profile-account-level');
            accountLevelElements.forEach(element => {
                if (element) element.textContent = userData.accountLevel || 'Basic';
            });
            
            // Set up account level progress
            setupAccountLevelProgress();
            
            // Update auto-profit status
            updateAutoProfitStatus();
            
            // If balance changed, update transaction history
            if (!oldData || oldData.balance !== userData.balance) {
                // Re-process transaction data
                processTransactionData();
                
                // Update transaction tables
                updateTransactionTables();
                
                // Update charts if already initialized
                updateCharts();
            }
        }
        
        // Initialize Overview Panel
        function initializeOverviewPanel() {
            console.log('Initializing Overview panel');
            
            // Update account level progress bar
            setupAccountLevelProgress();
            
            // Setup auto-profit button
            const enableAutoProfitBtn = document.getElementById('enable-auto-profit');
            if (enableAutoProfitBtn) {
                enableAutoProfitBtn.addEventListener('click', toggleAutoProfit);
            }
            
            // Update profit 24h value
            updateProfit24hValue();
            
            // Load recent transactions
            loadRecentTransactions();
        }
        
        // Setup Account Level Progress
        function setupAccountLevelProgress() {
            console.log('Setting up account level progress');
            
            const progressElement = document.getElementById('account-level-progress');
            const progressTextElement = document.querySelector('.level-progress-text');
            
            if (!progressElement || !progressTextElement) {
                console.error('Progress elements not found');
                return;
            }
            
            const level = userData.accountLevel ? userData.accountLevel.toLowerCase() : 'basic';
            let progressPercentage = 0;
            let nextLevel = '';
            
            switch(level) {
                case 'basic':
                    progressPercentage = 25;
                    nextLevel = 'Intermediate';
                    break;
                case 'intermediate':
                    progressPercentage = 50;
                    nextLevel = 'Advanced';
                    break;
                case 'advanced':
                    progressPercentage = 75;
                    nextLevel = 'Premium';
                    break;
                case 'premium':
                    progressPercentage = 100;
                    nextLevel = 'Maximum level reached';
                    break;
                default:
                    progressPercentage = 0;
                    nextLevel = 'Basic';
            }
            
            progressElement.style.width = `${progressPercentage}%`;
            progressTextElement.textContent = progressPercentage < 100 
                ? `${progressPercentage}% to ${nextLevel}` 
                : nextLevel;
        }
        
        // Update Profit 24h Value
        function updateProfit24hValue() {
            console.log('Updating 24h profit value');
            
            const profit24hElement = document.getElementById('profit-24h');
            
            if (!profit24hElement) {
                console.error('Profit 24h element not found');
                return;
            }
            
            // Calculate 24h profit from history
            const now = new Date();
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            
            let profit24h = 0;
            
            if (userData.history) {
                userData.history.forEach(transaction => {
                    const transactionDate = transaction.date && transaction.date.toMillis 
                        ? new Date(transaction.date.toMillis()) 
                        : new Date(transaction.date);
                    
                    if (transactionDate >= yesterday && transactionDate <= now) {
                        if (transaction.type === 'auto_profit') {
                            profit24h += transaction.amount;
                        } else if (transaction.type === 'auto_profit_loss') {
                            profit24h -= transaction.amount;
                        }
                    }
                });
            }
            
            // Format as currency with sign
            const formattedProfit = profit24h === 0 
                ? '$0.00' 
                : `${profit24h > 0 ? '+' : ''}$${Math.abs(profit24h).toFixed(2)}`;
            
            profit24hElement.textContent = formattedProfit;
            
            // Set appropriate CSS class
            profit24hElement.classList.remove('positive', 'negative');
            if (profit24h > 0) {
                profit24hElement.classList.add('positive');
            } else if (profit24h < 0) {
                profit24hElement.classList.add('negative');
            }
        }
        
        // Update Auto-Profit Status
        function updateAutoProfitStatus() {
            console.log('Updating auto-trade status');
            
            const autoProfitStatus = document.getElementById('auto-profit-status');
            const enableAutoProfitBtn = document.getElementById('enable-auto-profit');
            const autoProfitCountdown = document.getElementById('auto-profit-countdown');
            
            if (!autoProfitStatus || !enableAutoProfitBtn) {
                console.error('Auto-trade elements not found');
                return;
            }

            // Check if auto-trade is blocked by admin
            if (userData.autoTradeBlocked) {
                autoProfitStatus.textContent = 'Blocked';
                autoProfitStatus.classList.remove('active-status');
                enableAutoProfitBtn.textContent = 'Auto-Trade Blocked';
                enableAutoProfitBtn.disabled = true;
                if (autoProfitCountdown) {
                    autoProfitCountdown.style.display = 'none';
                }
                return;
            }
            
            if (userData.autoProfitEnabled) {
                autoProfitStatus.textContent = 'Enabled';
                autoProfitStatus.classList.add('active-status');
                enableAutoProfitBtn.textContent = 'Disable Auto-Trade';
                enableAutoProfitBtn.disabled = false;
                
                if (autoProfitCountdown) {
                    autoProfitCountdown.style.display = 'block';
                }
            } else {
                autoProfitStatus.textContent = 'Disabled';
                autoProfitStatus.classList.remove('active-status');
                enableAutoProfitBtn.textContent = 'Enable Auto-Trade';
                enableAutoProfitBtn.disabled = false;
                
                if (autoProfitCountdown) {
                    autoProfitCountdown.style.display = 'none';
                }
            }
            
            // Also update the toggle in the auto-trade panel
            const autoTradeToggle = document.getElementById('auto-profit-toggle');
            const autoTradeStatus = document.getElementById('auto-profit-toggle-status');
            const autoTradeTimer = document.getElementById('auto-trade-timer');
            const autoProfitInfo = document.getElementById('auto-profit-info');
            
            if (autoTradeToggle && autoTradeStatus) {
                // Disable toggle if blocked by admin
                autoTradeToggle.disabled = userData.autoTradeBlocked;
                autoTradeToggle.checked = userData.autoProfitEnabled || false;
                autoTradeStatus.textContent = userData.autoTradeBlocked ? 'Blocked' : (userData.autoProfitEnabled ? 'Enabled' : 'Disabled');
                
                // Show/hide auto-trade countdown in auto-trade panel
                if (autoProfitInfo) {
                    autoProfitInfo.style.display = userData.autoProfitEnabled && !userData.autoTradeBlocked ? 'block' : 'none';
                }
            }
        }
        
        // Toggle Auto-Profit
        function toggleAutoProfit() {
            console.log('Toggling auto-profit');
            
            // Check if auto-trade is blocked
            if (userData.autoTradeBlocked) {
                alert('Auto-trade has been blocked by admin. Please contact support for assistance.');
                return;
            }

            const newStatus = !userData.autoProfitEnabled;
            
            // If enabling, show the auto-profit panel for configuration
            if (newStatus) {
                document.querySelector('.nav-item[data-panel="auto-trade"]').click();
                return;
            }
            
            // If disabling, update the database
            updateDoc(userDocRef, {
                autoProfitEnabled: false
            })
            .then(() => {
                console.log('Auto-profit disabled successfully');
            })
            .catch(error => {
                console.error('Error disabling auto-profit:', error);
                alert('Error disabling auto-profit: ' + error.message);
            });
        }
        
        // Start Auto-Profit Timer (Updated for server-side implementation)
        function startAutoProfitTimer() {
            console.log('Starting auto-profit timer display');
            
            // Clear any existing timer
            if (autoProfitTimer) {
                clearInterval(autoProfitTimer);
            }
            
            // Update countdown display immediately
            updateCountdownDisplay();
            
            // Update countdown display every second
            autoProfitTimer = setInterval(() => {
                updateCountdownDisplay();
            }, 1000);
        }
        
        // Update Countdown Display (Updated for server-side implementation)
        function updateCountdownDisplay() {
            const autoProfitTimer = document.getElementById('auto-profit-timer');
            const autoTradeTimer = document.getElementById('auto-trade-timer');
            
            if (!autoProfitTimer && !autoTradeTimer) {
                return;
            }
            
            if (!userData.autoProfitEnabled || !userData.lastAutoTradeDate) {
                if (autoProfitTimer) autoProfitTimer.textContent = '00:00:00';
                if (autoTradeTimer) autoTradeTimer.textContent = '00:00:00';
                return;
            }
            
            const now = new Date();
            const lastAutoTradeDate = userData.lastAutoTradeDate.toDate();
            const interval = userData.adminSetInterval || 30;
            
            // Calculate next trade time
            let nextTradeDate = new Date(lastAutoTradeDate);
            nextTradeDate.setMinutes(nextTradeDate.getMinutes() + interval);
            
            // If next trade time is in the past, calculate the next future trade time
            while (nextTradeDate <= now) {
                nextTradeDate.setMinutes(nextTradeDate.getMinutes() + interval);
            }
            
            const timeLeft = nextTradeDate - now;
            
            // Format time left as HH:MM:SS
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (autoProfitTimer) autoProfitTimer.textContent = formattedTime;
            if (autoTradeTimer) autoTradeTimer.textContent = formattedTime;

            // If countdown reaches 0, generate trade and refresh page
            if (hours === 0 && minutes === 0 && seconds === 0) {
                console.log('Countdown completed, generating trade');
                generateAutoTrade(userData.adminSetAmount)
                    .then(result => {
                        if (result.success) {
                            showNotification(result.message, 'success');
                        } else {
                            showNotification(result.message, 'error');
                        }
                        // Wait 2 seconds before refreshing to ensure the trade has been generated
                        // and to allow the user to see the notification
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    })
                    .catch(error => {
                        console.error('Error generating trade:', error);
                        showNotification('Error generating trade', 'error');
                    });
            }
        }
        
        // Refresh Dashboard Data
        async function refreshDashboardData() {
            console.log('Refreshing dashboard data');
            
            try {
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    userData = userDoc.data(); // Update local user data
                    updateUserInfo(); // Update user info in the header
                    processTransactionData(); // Process transaction data for charts
                    updateTransactionTables(); // Update transaction tables
                    updateCharts(); // Update charts
                    showNotification('Auto-trade completed successfully', 'success');
                }
            } catch (error) {
                console.error('Error refreshing dashboard data:', error);
                showNotification('Error refreshing dashboard: ' + error.message, 'error');
            }
        }
        
        // Handle Auto-Profit Status Change (Updated for server-side implementation)
        function handleAutoProfitStatusChange() {
            console.log('Auto-profit status changed');
            
            if (userData.autoProfitEnabled && !userData.autoTradeBlocked) {
                // Start countdown display timer
                startAutoProfitTimer();
            } else {
                // Stop countdown display timer
                if (autoProfitTimer) {
                    clearInterval(autoProfitTimer);
                    autoProfitTimer = null;
                }
            }
        }
        
        // Load Recent Transactions
        function loadRecentTransactions() {
            console.log('Loading recent transactions');
            
            const transactionsContainer = document.getElementById('recent-transactions');
            
            if (!transactionsContainer) {
                console.error('Recent transactions container not found');
                return;
            }
            
            if (!userData.history || userData.history.length === 0) {
                transactionsContainer.innerHTML = `
                    <tr>
                        <td colspan="5" class="no-data">No recent transactions found</td>
                    </tr>`;
                return;
            }
            
            // Filter out admin transactions and sort by date
            const recentTransactions = userData.history
                .filter(tx => !tx.type.includes('balance_adjustment') && !tx.adminOnly)
                .sort((a, b) => {
                    const dateA = a.date && a.date.toMillis ? a.date.toMillis() : (a.date ? new Date(a.date).getTime() : 0);
                    const dateB = b.date && b.date.toMillis ? b.date.toMillis() : (b.date ? new Date(b.date).getTime() : 0);
                    return dateB - dateA;
                })
                .slice(0, 5);
            
            // Render transactions
            transactionsContainer.innerHTML = renderTransactionRows(recentTransactions);
            
            // Add event listeners to view buttons
            addTransactionViewEventListeners(transactionsContainer);
        }
        
        // Initialize Portfolio Panel
        function initializePortfolioPanel() {
            console.log('Initializing Portfolio panel');
            
            // Load transaction history for portfolio
            loadPortfolioTransactions();
            
            // Setup deposit/withdraw buttons are already handled in setupModals()
        }
        
        // Load Portfolio Transactions
        function loadPortfolioTransactions() {
            console.log('Loading portfolio transactions');
            
            const transactionsContainer = document.getElementById('portfolio-transactions');
            
            if (!transactionsContainer) {
                console.error('Portfolio transactions container not found');
                return;
            }
            
            if (!userData.history || userData.history.length === 0) {
                transactionsContainer.innerHTML = `
                    <tr>
                        <td colspan="5" class="no-data">No transactions found</td>
                    </tr>`;
                return;
            }
            
            // Sort transactions by date (most recent first)
            const transactions = [...userData.history]
                .sort((a, b) => {
                    // Handle Timestamp objects and regular dates
                    const dateA = a.date && a.date.toMillis ? a.date.toMillis() : (a.date ? new Date(a.date).getTime() : 0);
                    const dateB = b.date && b.date.toMillis ? b.date.toMillis() : (b.date ? new Date(b.date).getTime() : 0);
                    return dateB - dateA;
                });
            
            // Render transactions
            transactionsContainer.innerHTML = renderTransactionRows(transactions);
            
            // Add event listeners to view buttons
            addTransactionViewEventListeners(transactionsContainer);
        }// Initialize Transactions Panel
        function initializeTransactionsPanel() {
            console.log('Initializing Transactions panel');
            
            // Load full transaction history
            loadAllTransactions();
            
            // Setup transaction filters
            setupTransactionFilters();
        }
        
        // Load All Transactions
        function loadAllTransactions() {
            console.log('Loading all transactions');
            
            const transactionsContainer = document.getElementById('all-transactions');
            
            if (!transactionsContainer) {
                console.error('All transactions container not found');
                return;
            }
            
            if (!userData.history || userData.history.length === 0) {
                transactionsContainer.innerHTML = `
                    <tr>
                        <td colspan="5" class="no-data">No transactions found</td>
                    </tr>`;
                return;
            }
            
            // Filter out admin transactions and sort by date
            const transactions = userData.history
                .filter(tx => !tx.type.includes('balance_adjustment') && !tx.adminOnly)
                .sort((a, b) => {
                    const dateA = a.date && a.date.toMillis ? a.date.toMillis() : (a.date ? new Date(a.date).getTime() : 0);
                    const dateB = b.date && b.date.toMillis ? b.date.toMillis() : (b.date ? new Date(b.date).getTime() : 0);
                    return dateB - dateA;
                });
            
            // Render transactions
            transactionsContainer.innerHTML = renderTransactionRows(transactions);
            
            // Add event listeners to view buttons
            addTransactionViewEventListeners(transactionsContainer);
        }
        
        // Render Transaction Rows
        function renderTransactionRows(transactions) {
            if (!transactions || transactions.length === 0) {
                return `
                    <tr>
                        <td colspan="5" class="no-data">No transactions found</td>
                    </tr>`;
            }
            
            return transactions.map((transaction, index) => {
                let typeText = '';
                let amountText = '';
                let statusText = '';
                let transactionId = transaction.id || `tx-${index}`;
                
                // Extract amount from details object or directly from amount field
                const amount = getTransactionAmount(transaction);
                
                switch(transaction.type) {
                    case 'deposit_request':
                        typeText = 'Deposit';
                        amountText = `$${amount.toFixed(2)}`;
                        statusText = '<span class="status pending">Pending</span>';
                        break;
                    case 'deposit_approved':
                        typeText = 'Deposit';
                        amountText = `$${amount.toFixed(2)}`;
                        statusText = '<span class="status completed">Approved</span>';
                        break;
                    case 'deposit_declined':
                        typeText = 'Deposit';
                        amountText = `$${amount.toFixed(2)}`;
                        statusText = '<span class="status failed">Declined</span>';
                        break;
                    case 'withdrawal_request':
                        typeText = 'Withdrawal';
                        amountText = `$${amount.toFixed(2)}`;
                        statusText = '<span class="status pending">Pending</span>';
                        break;
                    case 'withdrawal_approved':
                        typeText = 'Withdrawal';
                        amountText = `$${amount.toFixed(2)}`;
                        statusText = '<span class="status completed">Approved</span>';
                        break;
                    case 'withdrawal_declined':
                        typeText = 'Withdrawal';
                        amountText = `$${amount.toFixed(2)}`;
                        statusText = '<span class="status failed">Declined</span>';
                        break;
                    case 'auto_profit':
                        typeText = 'Auto Trade';
                        amountText = `+$${amount.toFixed(2)}`;
                        statusText = '<span class="status completed">Profit</span>';
                        break;
                    case 'auto_profit_loss':
                        typeText = 'Auto Trade';
                        amountText = `-$${amount.toFixed(2)}`;
                        statusText = '<span class="status failed">Loss</span>';
                        break;
                    default:
                        typeText = transaction.type || 'Transaction';
                        amountText = `$${amount.toFixed(2)}`;
                        statusText = '<span class="status pending">Processing</span>';
                }
                
                // Format date
                let dateStr = 'Unknown date';
                if (transaction.date) {
                    const date = transaction.date.toDate 
                        ? transaction.date.toDate() 
                        : new Date(transaction.date);
                    dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }
                
                // Create a JSON string of the transaction data for the view button
                const transactionData = JSON.stringify(transaction).replace(/"/g, '&quot;');
                
                return `
                    <tr>
                        <td>${typeText}</td>
                        <td>${amountText}</td>
                        <td>${statusText}</td>
                        <td>${dateStr}</td>
                        <td><button class="btn btn-sm view-transaction" data-transaction='${transactionData}'>View</button></td>
                    </tr>
                `;
            }).join('');
        }
        
        // Add Transaction View Event Listeners
        function addTransactionViewEventListeners(container) {
            const viewButtons = container.querySelectorAll('.view-transaction');
            
            viewButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    // Get transaction data from button attribute
                    const transactionData = JSON.parse(e.currentTarget.getAttribute('data-transaction'));
                    showTransactionDetails(transactionData);
                });
            });
        }
        
        // Show Transaction Details
        function showTransactionDetails(transaction) {
            console.log('Showing transaction details:', transaction);
            
            const modal = document.getElementById('transaction-details-modal');
            const content = document.getElementById('transaction-details-content');
            
            if (!modal || !content) {
                console.error('Transaction modal elements not found');
                return;
            }
            
            // Format transaction details for display
            let typeText = '';
            let statusText = '';
            let detailsHtml = '';
            
            // Determine transaction type and status
            switch(transaction.type) {
                case 'deposit_request':
                    typeText = 'Deposit Request';
                    statusText = '<span class="status pending">Pending</span>';
                    break;
                case 'deposit_approved':
                    typeText = 'Deposit';
                    statusText = '<span class="status completed">Approved</span>';
                    break;
                case 'deposit_declined':
                    typeText = 'Deposit';
                    statusText = '<span class="status failed">Declined</span>';
                    break;
                case 'withdrawal_request':
                    typeText = 'Withdrawal Request';
                    statusText = '<span class="status pending">Pending</span>';
                    break;
                case 'withdrawal_approved':
                    typeText = 'Withdrawal';
                    statusText = '<span class="status completed">Approved</span>';
                    break;
                case 'withdrawal_declined':
                    typeText = 'Withdrawal';
                    statusText = '<span class="status failed">Declined</span>';
                    break;
                case 'auto_profit':
                    typeText = 'Auto Trade';
                    statusText = '<span class="status completed">Profit</span>';
                    break;
                case 'auto_profit_loss':
                    typeText = 'Auto Trade';
                    statusText = '<span class="status failed">Loss</span>';
                    break;
                default:
                    typeText = transaction.type || 'Transaction';
                    statusText = '<span class="status pending">Processing</span>';
            }
            
            // Get amount
            const amount = getTransactionAmount(transaction);
            const isLoss = transaction.type === 'auto_profit_loss';
            
            // Format date
            let dateStr = 'Unknown date';
            if (transaction.date) {
                try {
                    let date;
                    if (transaction.date.toDate && typeof transaction.date.toDate === 'function') {
                        // Handle Firestore Timestamp
                        date = transaction.date.toDate();
                    } else if (transaction.date.seconds) {
                        // Handle Firestore Timestamp object format
                        date = new Date(transaction.date.seconds * 1000);
                    } else {
                        // Handle regular Date or timestamp
                        date = new Date(transaction.date);
                    }

                    if (!isNaN(date.getTime())) {
                        dateStr = date.toLocaleString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: true
                        });
                    } else {
                        throw new Error('Invalid date');
                    }
                } catch (error) {
                    console.error('Error formatting date:', error, transaction.date);
                    dateStr = 'Invalid date';
                }
            }
            
            // Start building details HTML
            detailsHtml = `
                <div class="transaction-detail-row">
                    <div class="transaction-detail-label">Type</div>
                    <div class="transaction-detail-value">${typeText}</div>
                </div>
                <div class="transaction-detail-row">
                    <div class="transaction-detail-label">Status</div>
                    <div class="transaction-detail-value">${statusText}</div>
                </div>
                <div class="transaction-detail-row">
                    <div class="transaction-detail-label">Amount</div>
                    <div class="transaction-detail-value">${isLoss ? '-' : ''}$${Math.abs(amount).toFixed(2)}</div>
                </div>
                <div class="transaction-detail-row">
                    <div class="transaction-detail-label">Date</div>
                    <div class="transaction-detail-value">${dateStr}</div>
                </div>
            `;
            
            // Add additional details if available
            if (transaction.details) {
                // For auto-trade transactions, show profit/loss percentage
                if (transaction.type === 'auto_profit' || transaction.type === 'auto_profit_loss') {
                    const percentageText = transaction.details.profitPercent 
                        ? `+${transaction.details.profitPercent}%` 
                        : `-${transaction.details.lossPercent}%`;
                    
                    detailsHtml += `
                        <div class="transaction-detail-row">
                            <div class="transaction-detail-label">Base Amount</div>
                            <div class="transaction-detail-value">$${transaction.details.baseAmount.toFixed(2)}</div>
                        </div>
                        <div class="transaction-detail-row">
                            <div class="transaction-detail-label">Percentage</div>
                            <div class="transaction-detail-value">${percentageText}</div>
                        </div>
                    `;
                }
                
                // Previous and new balance
                if (transaction.details.previousBalance !== undefined && transaction.details.newBalance !== undefined) {
                    detailsHtml += `
                        <div class="transaction-detail-row">
                            <div class="transaction-detail-label">Previous Balance</div>
                            <div class="transaction-detail-value">$${transaction.details.previousBalance.toFixed(2)}</div>
                        </div>
                        <div class="transaction-detail-row">
                            <div class="transaction-detail-label">New Balance</div>
                            <div class="transaction-detail-value">$${transaction.details.newBalance.toFixed(2)}</div>
                        </div>
                    `;
                }
                
                // Payment method
                if (transaction.details.method) {
                    detailsHtml += `
                        <div class="transaction-detail-row">
                            <div class="transaction-detail-label">Payment Method</div>
                            <div class="transaction-detail-value">${transaction.details.method}</div>
                        </div>
                    `;
                }
                
                // Wallet address / bank details
                if (transaction.details.address) {
                    detailsHtml += `
                        <div class="transaction-detail-row">
                            <div class="transaction-detail-label">Wallet Address / Bank Details</div>
                            <div class="transaction-detail-value">${transaction.details.address}</div>
                        </div>
                    `;
                }
                
                // Admin comments or notes
                if (transaction.details.notes) {
                    detailsHtml += `
                        <div class="transaction-detail-row">
                            <div class="transaction-detail-label">Notes</div>
                            <div class="transaction-detail-value">${transaction.details.notes}</div>
                        </div>
                    `;
                }
            }
            
            // Set content and show modal
            content.innerHTML = detailsHtml;
            modal.style.display = 'flex';
        }
        
        // Setup Transaction Filters
        function setupTransactionFilters() {
            console.log('Setting up transaction filters');
            
            const typeFilter = document.getElementById('transaction-type-filter');
            const statusFilter = document.getElementById('transaction-status-filter');
            
            if (!typeFilter || !statusFilter) {
                console.error('Transaction filters not found');
                return;
            }
            
            // Apply filters when changed
            typeFilter.addEventListener('change', applyTransactionFilters);
            statusFilter.addEventListener('change', applyTransactionFilters);
        }
        
        // Apply Transaction Filters
        function applyTransactionFilters() {
            console.log('Applying transaction filters');
            
            const typeFilter = document.getElementById('transaction-type-filter');
            const statusFilter = document.getElementById('transaction-status-filter');
            
            if (!typeFilter || !statusFilter || !userData.history) {
                return;
            }
            
            const selectedType = typeFilter.value;
            const selectedStatus = statusFilter.value;
            
            // Apply filters
            let filteredTransactions = [...userData.history];
            
            // Filter by type
            if (selectedType !== 'all') {
                filteredTransactions = filteredTransactions.filter(transaction => {
                    if (selectedType === 'deposit') {
                        return transaction.type.includes('deposit');
                    } else if (selectedType === 'withdrawal') {
                        return transaction.type.includes('withdrawal');
                    } else if (selectedType === 'auto_profit') {
                        return transaction.type === 'auto_profit';
                    }
                    return true;
                });
            }
            
            // Filter by status
            if (selectedStatus !== 'all') {
                filteredTransactions = filteredTransactions.filter(transaction => {
                    if (selectedStatus === 'pending') {
                        return transaction.type.includes('request');
                    } else if (selectedStatus === 'completed') {
                        return transaction.type.includes('approved') || transaction.type === 'auto_profit';
                    } else if (selectedStatus === 'failed') {
                        return transaction.type.includes('declined');
                    }
                    return true;
                });
            }
            
            // Sort by date
            filteredTransactions.sort((a, b) => {
                const dateA = a.date && a.date.toMillis ? a.date.toMillis() : (a.date ? new Date(a.date).getTime() : 0);
                const dateB = b.date && b.date.toMillis ? b.date.toMillis() : (b.date ? new Date(b.date).getTime() : 0);
                return dateB - dateA;
            });
            
            // Update transaction table
            const transactionsContainer = document.getElementById('all-transactions');
            if (transactionsContainer) {
                // Render filtered transactions
                transactionsContainer.innerHTML = renderTransactionRows(filteredTransactions);
                
                // Re-add event listeners
                addTransactionViewEventListeners(transactionsContainer);
            }
        }
        
        // Update Transaction Tables
        function updateTransactionTables() {
            console.log('Updating transaction tables');
            
            // Update recent transactions
            loadRecentTransactions();
            
            // Update portfolio transactions
            loadPortfolioTransactions();
            
            // Update all transactions
            loadAllTransactions();
            
            // Update auto-profit history
            loadAutoProfitHistory();
        }
        
        // Initialize Auto-Trade Panel
        function initializeAutoTradePanel() {
            console.log('Initializing Auto-Trade panel');
            
            // Setup toggle switch
            const toggle = document.getElementById('auto-profit-toggle');
            const toggleStatus = document.getElementById('auto-profit-toggle-status');
            const autoProfitInfo = document.getElementById('auto-profit-info');
            
            if (toggle && toggleStatus) {
                // Set initial state
                toggle.checked = userData.autoProfitEnabled || false;
                toggleStatus.textContent = userData.autoProfitEnabled ? 'Enabled' : 'Disabled';
                
                // Add change listener
                toggle.addEventListener('change', function() {
                        toggleStatus.textContent = this.checked ? 'Enabled' : 'Disabled';
                    saveAutoProfitSettings();
                });
                
                // Show/hide countdown based on current state
                if (autoProfitInfo) {
                    autoProfitInfo.style.display = userData.autoProfitEnabled ? 'block' : 'none';
                }
            }
            
            // Load auto-trade history
            loadAutoProfitHistory();
        }
        
        // Save Auto-Profit Settings (Updated for server-side implementation)
        function saveAutoProfitSettings() {
            console.log('Saving auto-trade settings');
            
            // Check if auto-trade is blocked
            if (userData.autoTradeBlocked) {
                alert('Auto-trade has been blocked by admin. Please contact support for assistance.');
                return;
            }

            const toggle = document.getElementById('auto-profit-toggle');
            
            if (!toggle) {
                console.error('Auto-trade settings elements not found');
                return;
            }
            
            const isEnabled = toggle.checked;
            
            // Ensure admin-set values exist
            if (isEnabled && (!userData.adminSetAmount || !userData.adminSetInterval)) {
                alert('Auto-trade settings have not been configured by admin. Please contact support.');
                toggle.checked = false;
                return;
            }
            
            // Update Firestore
            updateDoc(userDocRef, {
                autoProfitEnabled: isEnabled,
                lastAutoTradeDate: isEnabled ? serverTimestamp() : null
            })
            .then(() => {
                console.log('Auto-trade settings saved successfully');
                
                // If auto-trade was just enabled, start the countdown display
                if (isEnabled && !userData.autoProfitEnabled) {
                    startAutoProfitTimer();
                } else if (!isEnabled && userData.autoProfitEnabled) {
                    // If auto-trade was just disabled, stop the countdown display
                    if (autoProfitTimer) {
                        clearInterval(autoProfitTimer);
                        autoProfitTimer = null;
                    }
                }
            })
            .catch(error => {
                console.error('Error saving auto-trade settings:', error);
                alert('Error saving settings: ' + error.message);
                // Revert toggle state on error
                toggle.checked = !isEnabled;
            });
        }
        
        // Load Auto-Profit History
        function loadAutoProfitHistory() {
            console.log('Loading auto-profit history');
            
            const historyContainer = document.getElementById('auto-profit-history');
            
            if (!historyContainer) {
                console.error('Auto-profit history container not found');
                return;
            }
            
            if (!userData.history) {
                historyContainer.innerHTML = `
                    <tr>
                        <td colspan="2" class="no-data">No auto-profit history found</td>
                    </tr>`;
                return;
            }
            
            // Filter auto-profit transactions
            const autoProfitHistory = userData.history
                .filter(transaction => transaction.type === 'auto_profit')
                .sort((a, b) => {
                    const dateA = a.date && a.date.toMillis ? a.date.toMillis() : (a.date ? new Date(a.date).getTime() : 0);
                    const dateB = b.date && b.date.toMillis ? b.date.toMillis() : (b.date ? new Date(b.date).getTime() : 0);
                    return dateB - dateA;
                });
            
            if (autoProfitHistory.length === 0) {
                historyContainer.innerHTML = `
                    <tr>
                        <td colspan="2" class="no-data">No auto-profit history found</td>
                    </tr>`;
                return;
            }
            
            historyContainer.innerHTML = autoProfitHistory.map(transaction => {
                // Extract amount from details object or directly from amount field
                const amount = getTransactionAmount(transaction);
                
                // Format date
                let dateStr = 'Unknown date';
                if (transaction.date) {
                    const date = transaction.date.toDate 
                        ? transaction.date.toDate() 
                        : new Date(transaction.date);
                    dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }
                
                return `
                    <tr>
                        <td>$${amount.toFixed(2)}</td>
                        <td>${dateStr}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // Handle Deposit Submit
        function handleDepositSubmit() {
            console.log('Handling deposit submission');
            
            const depositAmount = document.getElementById('deposit-amount');
            const depositMethod = document.getElementById('deposit-method');
            
            if (!depositAmount || !depositMethod) {
                console.error('Deposit form elements not found');
                return;
            }
            
            const amount = parseFloat(depositAmount.value);
            const method = depositMethod.value;
            
            // Validate inputs
            if (isNaN(amount) || amount < 10) {
                alert('Please enter a valid amount (minimum $10)');
                return;
            }
            
            // Create deposit request
            const depositRequest = {
                type: 'deposit_request',
                date: Timestamp.now(),
                details: {
                    amount: amount,
                    method: method,
                    userId: currentUser.uid,
                    userEmail: currentUser.email
                }
            };
            
            // Add to history array
            updateDoc(userDocRef, {
                history: arrayUnion(depositRequest)
            })
            .then(() => {
                console.log('Deposit request submitted successfully');
                alert('Deposit request submitted successfully. An admin will review your request.');
                document.getElementById('deposit-modal').style.display = 'none';
                depositAmount.value = '';
            })
            .catch(error => {
                console.error('Error submitting deposit request:', error);
                alert('Error submitting deposit request: ' + error.message);
            });
        }
        
        // Handle Withdraw Submit
        async function handleWithdrawSubmit() {
            console.log('Handling withdrawal submit');
            
            // Check if KYC is required and verified
            if (!userData.kycStatus || userData.kycStatus !== 'verified') {
                alert('Please complete KYC verification before making a withdrawal');
                return;
            }

            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const method = document.getElementById('withdraw-method').value;
            const withdrawalCode = document.getElementById('withdrawal-code').value;

            // Validate amount
            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            // Check balance
            if (amount > userData.balance) {
                alert('Insufficient balance');
                return;
            }

            // Validate withdrawal code
            if (!withdrawalCode || withdrawalCode.length !== 6) {
                alert('Please enter a valid 6-digit withdrawal code');
                return;
            }

            // Check if withdrawal code matches
            if (withdrawalCode !== userData.withdrawalCode) {
                alert('Invalid withdrawal code. Please contact support if you need assistance.');
                return;
            }

            // Get withdrawal details based on method
            let withdrawalDetails = {
                amount: amount,
                method: method
            };

            if (method === 'crypto') {
                const currency = document.getElementById('crypto-currency').value;
                const address = document.getElementById('crypto-address').value;

                if (!currency || !address) {
                    alert('Please fill in all cryptocurrency withdrawal details');
                    return;
                }

                withdrawalDetails.currency = currency;
                withdrawalDetails.address = address;
            } else if (method === 'bank') {
                const bankName = document.getElementById('bank-name').value;
                const accountName = document.getElementById('account-name').value;
                const accountNumber = document.getElementById('account-number').value;
                const routingNumber = document.getElementById('routing-number').value;

                if (!bankName || !accountName || !accountNumber) {
                    alert('Please fill in all required bank details');
                    return;
                }

                // Verify account name matches user's name
                if (accountName.toLowerCase() !== userData.name.toLowerCase()) {
                    alert('Account name must match your broker account name');
                    return;
                }

                withdrawalDetails.bankName = bankName;
                withdrawalDetails.accountName = accountName;
                withdrawalDetails.accountNumber = accountNumber;
                withdrawalDetails.routingNumber = routingNumber;
            } else {
                alert('Please select a withdrawal method');
                return;
            }

            try {
                // Create withdrawal request with current timestamp
                const withdrawalRequest = {
                    type: 'withdrawal_request',
                    amount: amount,
                    date: new Date(),
                    status: 'pending',
                    details: withdrawalDetails
                };

                // Add to user's history
                await updateDoc(userDocRef, {
                    history: arrayUnion(withdrawalRequest)
                });

                // Close modal and show success message
                document.getElementById('withdraw-modal').style.display = 'none';
                alert('Withdrawal request submitted successfully');

                // Reset form
                document.getElementById('withdraw-amount').value = '';
                document.getElementById('withdrawal-code').value = '';
                document.getElementById('withdraw-method').value = '';
                document.getElementById('crypto-withdrawal-section').style.display = 'none';
                document.getElementById('bank-withdrawal-section').style.display = 'none';

            } catch (error) {
                console.error('Error submitting withdrawal:', error);
                alert('Error submitting withdrawal: ' + error.message);
            }
        }

        // Handle Withdrawal Method Change
        document.getElementById('withdraw-method').addEventListener('change', function(e) {
            const cryptoSection = document.getElementById('crypto-withdrawal-section');
            const bankSection = document.getElementById('bank-withdrawal-section');
            
            if (e.target.value === 'crypto') {
                cryptoSection.style.display = 'block';
                bankSection.style.display = 'none';
            } else if (e.target.value === 'bank') {
                cryptoSection.style.display = 'none';
                bankSection.style.display = 'block';
            } else {
                cryptoSection.style.display = 'none';
                bankSection.style.display = 'none';
            }
        });

        // Initialize Profile Panel
        function initializeProfilePanel() {
            console.log('Initializing Profile panel');
            
            // Set profile information
            updateProfileInfo();
            
            // Setup profile picture upload
            setupProfilePictureUpload();
            
            // Setup edit profile button
            const editProfileBtn = document.getElementById('edit-profile-btn');
            if (editProfileBtn) {
                editProfileBtn.addEventListener('click', toggleProfileEditMode);
            }
            
            // Setup cancel edit button
            const cancelEditBtn = document.getElementById('cancel-edit');
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', cancelProfileEdit);
            }
            
            // Setup profile form submission
            const profileForm = document.getElementById('profile-form');
            if (profileForm) {
                profileForm.addEventListener('submit', handleProfileSubmit);
            }

            // Setup financial form
            const editFinancialBtn = document.getElementById('edit-financial-btn');
            const cancelFinancialBtn = document.getElementById('cancel-financial-edit');
            const financialForm = document.getElementById('financial-form');

            if (editFinancialBtn) {
                editFinancialBtn.addEventListener('click', toggleFinancialEditMode);
            }

            if (cancelFinancialBtn) {
                cancelFinancialBtn.addEventListener('click', cancelFinancialEdit);
            }

            if (financialForm) {
                financialForm.addEventListener('submit', handleFinancialSubmit);
            }

            // Setup KYC functionality
            setupKYCUpload();
            updateKYCStatus();

            // Setup regulatory section
            setupRegulatorySection();
        }

        // Setup KYC Upload
        function setupKYCUpload() {
            const kycUploadBtn = document.getElementById('kyc-upload-btn');
            const kycFileInput = document.getElementById('kyc-photo');
            const submitKycBtn = document.getElementById('submit-kyc');
            const selectedFileName = document.getElementById('selected-file-name');
            const previewContainer = document.getElementById('kyc-preview-container');
            const previewImage = document.getElementById('kyc-preview');
            const uploadContainer = document.getElementById('kyc-upload-container');

            // Show/hide upload container based on KYC status
            if (userData.kycStatus === 'verified') {
                if (uploadContainer) uploadContainer.style.display = 'none';
            }

            if (kycUploadBtn && kycFileInput) {
                kycUploadBtn.addEventListener('click', () => {
                    kycFileInput.click();
                });

                kycFileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        // Update selected file name
                        if (selectedFileName) {
                            selectedFileName.textContent = file.name;
                        }

                        // Compress and preview image
                        const compressedBase64 = await compressImage(file);
                        if (previewImage && previewContainer) {
                            previewImage.src = compressedBase64;
                            previewContainer.style.display = 'block';
                        }

                        // Show submit button
                        if (submitKycBtn) {
                            submitKycBtn.style.display = 'block';
                        }

                    } catch (error) {
                        console.error('Error processing KYC document:', error);
                        alert('Error uploading document. Please try again.');
                    }
                });
            }

            // Handle KYC submission
            if (submitKycBtn) {
                submitKycBtn.addEventListener('click', async () => {
                    const previewImage = document.getElementById('kyc-preview');
                    if (!previewImage || !previewImage.src) {
                        alert('Please select a document to upload');
                        return;
                    }

                    try {
                        // Update user document with KYC photo
                        await updateDoc(userDocRef, {
                            kycPhotoBase64: previewImage.src,
                            kycStatus: 'pending',
                            kycSubmittedAt: Timestamp.now()
                        });

                        alert('KYC document submitted successfully. Please wait for verification.');

                        // Reset form
                        if (selectedFileName) selectedFileName.textContent = 'No file chosen';
                        if (previewContainer) previewContainer.style.display = 'none';
                        submitKycBtn.style.display = 'none';

                    } catch (error) {
                        console.error('Error submitting KYC:', error);
                        alert('Error submitting KYC document: ' + error.message);
                    }
                });
            }
        }

        // Update KYC Status
        function updateKYCStatus() {
            const statusBadge = document.getElementById('kyc-status-badge');
            const kycMessage = document.getElementById('kyc-message');
            const uploadContainer = document.getElementById('kyc-upload-container');

            if (!statusBadge || !kycMessage) return;

            let badgeClass = '';
            let message = '';

            switch(userData.kycStatus) {
                case 'verified':
                    badgeClass = 'verified';
                    message = 'Your identity has been verified.';
                    if (uploadContainer) uploadContainer.style.display = 'none';
                    break;
                case 'pending':
                    badgeClass = 'pending';
                    message = 'Your verification is being processed. This usually takes 24-48 hours.';
                    if (uploadContainer) uploadContainer.style.display = 'none';
                    break;
                case 'rejected':
                    badgeClass = 'rejected';
                    message = userData.kycRejectionReason || 'Your verification was rejected. Please upload a new document.';
                    if (uploadContainer) uploadContainer.style.display = 'block';
                    break;
                default:
                    badgeClass = '';
                    message = 'Please upload a government-issued ID for verification.';
                    if (uploadContainer) uploadContainer.style.display = 'block';
            }

            // Update status badge
            statusBadge.textContent = userData.kycStatus ? userData.kycStatus.charAt(0).toUpperCase() + userData.kycStatus.slice(1) : 'Not Verified';
            statusBadge.className = 'status-badge ' + badgeClass;

            // Update message
            kycMessage.textContent = message;
        }

        // Update Profile Info
        function updateProfileInfo() {
            // Update profile picture
            updateProfilePicture(userData.profilePhotoBase64);
            
            // Update profile fields
            const nameInput = document.getElementById('profile-name');
            const emailInput = document.getElementById('profile-email');
            const dobInput = document.getElementById('profile-dob');
            const phoneInput = document.getElementById('profile-phone');
            const nationalityInput = document.getElementById('profile-nationality');
            const addressInput = document.getElementById('profile-address');
            const accountLevelInput = document.getElementById('profile-account-level');
            
            if (nameInput) nameInput.value = userData.name || '';
            if (emailInput) emailInput.value = userData.email || '';
            if (dobInput) dobInput.value = userData.dateOfBirth || '';
            if (phoneInput) phoneInput.value = userData.phone || '';
            if (nationalityInput) nationalityInput.value = userData.nationality || '';
            if (addressInput) addressInput.value = userData.address || '';
            if (accountLevelInput) accountLevelInput.value = userData.accountLevel || 'Basic';

            // Update financial information
            const employmentStatus = document.getElementById('employment-status');
            const incomeSource = document.getElementById('income-source');
            const annualIncome = document.getElementById('annual-income');
            const tradingExperience = document.getElementById('trading-experience');
            const tradingGoals = document.getElementById('trading-goals');

            if (employmentStatus) employmentStatus.value = userData.employmentStatus || '';
            if (incomeSource) incomeSource.value = userData.incomeSource || '';
            if (annualIncome) annualIncome.value = userData.annualIncome || '';
            if (tradingExperience) tradingExperience.value = userData.tradingExperience || '';
            if (tradingGoals) tradingGoals.value = userData.tradingGoals || '';

            // Show regulatory section if balance > 150k
            const regulatorySection = document.getElementById('regulatory-section');
            if (regulatorySection) {
                regulatorySection.style.display = userData.balance >= 150000 ? 'block' : 'none';
            }
        }

        // Toggle Profile Edit Mode
        function toggleProfileEditMode() {
            console.log('Toggling profile edit mode');
            
            const inputs = document.querySelectorAll('#profile-form input:not(#profile-email):not(#profile-account-level), #profile-form textarea');
            const editBtn = document.getElementById('edit-profile-btn');
            const saveBtn = document.getElementById('save-profile');
            const cancelBtn = document.getElementById('cancel-edit');
            
            inputs.forEach(input => {
                input.disabled = !input.disabled;
            });
            
            editBtn.style.display = 'none';
            saveBtn.style.display = 'block';
            cancelBtn.style.display = 'block';
        }

        // Toggle Financial Edit Mode
        function toggleFinancialEditMode() {
            console.log('Toggling financial edit mode');
            
            const inputs = document.querySelectorAll('#financial-form select');
            const editBtn = document.getElementById('edit-financial-btn');
            const saveBtn = document.getElementById('save-financial');
            const cancelBtn = document.getElementById('cancel-financial-edit');
            
            inputs.forEach(input => {
                input.disabled = !input.disabled;
            });
            
            editBtn.style.display = 'none';
            saveBtn.style.display = 'block';
            cancelBtn.style.display = 'block';
        }

        // Cancel Profile Edit
        function cancelProfileEdit() {
            console.log('Canceling profile edit');
            
            const inputs = document.querySelectorAll('#profile-form input:not(#profile-email):not(#profile-account-level), #profile-form textarea');
            const editBtn = document.getElementById('edit-profile-btn');
            const saveBtn = document.getElementById('save-profile');
            const cancelBtn = document.getElementById('cancel-edit');
            
            inputs.forEach(input => {
                input.disabled = true;
                input.value = userData[input.id.replace('profile-', '')] || '';
            });
            
            editBtn.style.display = 'block';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
        }

        // Cancel Financial Edit
        function cancelFinancialEdit() {
            console.log('Canceling financial edit');
            
            const inputs = document.querySelectorAll('#financial-form select');
            const editBtn = document.getElementById('edit-financial-btn');
            const saveBtn = document.getElementById('save-financial');
            const cancelBtn = document.getElementById('cancel-financial-edit');
            
            inputs.forEach(input => {
                input.disabled = true;
                input.value = userData[input.id] || '';
            });
            
            editBtn.style.display = 'block';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
        }

        // Handle Profile Submit
        function handleProfileSubmit(e) {
            e.preventDefault();
            console.log('Handling profile submit');

            const formData = {
                name: document.getElementById('profile-name').value,
                dateOfBirth: document.getElementById('profile-dob').value,
                phone: document.getElementById('profile-phone').value,
                nationality: document.getElementById('profile-nationality').value,
                address: document.getElementById('profile-address').value
            };

            // Update Firestore
            updateDoc(userDocRef, formData)
                .then(() => {
                    console.log('Profile updated successfully');
                    alert('Profile updated successfully');
                    
                    // Disable inputs and update buttons
                    const inputs = document.querySelectorAll('#profile-form input:not(#profile-email):not(#profile-account-level), #profile-form textarea');
                    const editBtn = document.getElementById('edit-profile-btn');
                    const saveBtn = document.getElementById('save-profile');
                    const cancelBtn = document.getElementById('cancel-edit');
                    
                    inputs.forEach(input => input.disabled = true);
                    editBtn.style.display = 'block';
                    saveBtn.style.display = 'none';
                    cancelBtn.style.display = 'none';
                })
                .catch(error => {
                    console.error('Error updating profile:', error);
                    alert('Error updating profile: ' + error.message);
                });
        }

        // Handle Financial Submit
        function handleFinancialSubmit(e) {
            e.preventDefault();
            console.log('Handling financial submit');

            const formData = {
                employmentStatus: document.getElementById('employment-status').value,
                incomeSource: document.getElementById('income-source').value,
                annualIncome: document.getElementById('annual-income').value,
                tradingExperience: document.getElementById('trading-experience').value,
                tradingGoals: document.getElementById('trading-goals').value
            };

            // Update Firestore
            updateDoc(userDocRef, formData)
                .then(() => {
                    console.log('Financial information updated successfully');
                    alert('Financial information updated successfully');
                    
                    // Disable inputs and update buttons
                    const inputs = document.querySelectorAll('#financial-form select');
                    const editBtn = document.getElementById('edit-financial-btn');
                    const saveBtn = document.getElementById('save-financial');
                    const cancelBtn = document.getElementById('cancel-financial-edit');
                    
                    inputs.forEach(input => input.disabled = true);
                    editBtn.style.display = 'block';
                    saveBtn.style.display = 'none';
                    cancelBtn.style.display = 'none';
                })
                .catch(error => {
                    console.error('Error updating financial information:', error);
                    alert('Error updating financial information: ' + error.message);
                });
        }

        // Setup Regulatory Section
        function setupRegulatorySection() {
            const idTypeRadios = document.getElementsByName('id-type');
            const taxIdSection = document.getElementById('tax-id-section');
            const ssnSection = document.getElementById('ssn-section');
            const regulatoryForm = document.getElementById('regulatory-form');
            const ssnUploadBtn = document.getElementById('ssn-upload-btn');
            const ssnFileInput = document.getElementById('ssn-card');
            const regulatoryStatusContainer = document.createElement('div');
            regulatoryStatusContainer.id = 'regulatory-status';
            regulatoryStatusContainer.className = 'regulatory-status';
            
            // Add status container after the form
            if (regulatoryForm) {
                regulatoryForm.parentNode.insertBefore(regulatoryStatusContainer, regulatoryForm.nextSibling);
            }

            // Update status display
            function updateRegulatoryStatus() {
                if (!regulatoryStatusContainer) return;
                
                if (!userData.regulatoryCompliance) {
                    regulatoryStatusContainer.innerHTML = '';
                    return;
                }

                const status = userData.regulatoryCompliance.status;
                let statusHTML = '';
                
                switch(status) {
                    case 'pending':
                        statusHTML = `
                            <div class="status-message pending">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                Your regulatory compliance information is under review
                            </div>
                        `;
                        break;
                    case 'verified':
                        statusHTML = `
                            <div class="status-message verified">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                                Your regulatory compliance information has been verified
                                <div class="verification-date">Verified on ${formatDate(userData.regulatoryCompliance.verifiedAt)}</div>
                            </div>
                        `;
                        break;
                    case 'rejected':
                        statusHTML = `
                            <div class="status-message rejected">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
                                Your regulatory compliance information was rejected
                                <div class="rejection-reason">${userData.regulatoryCompliance.rejectionReason || 'No reason provided'}</div>
                            </div>
                        `;
                        break;
                }
                
                regulatoryStatusContainer.innerHTML = statusHTML;
            }

            // Handle ID type selection
            idTypeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.value === 'tax') {
                        taxIdSection.style.display = 'block';
                        ssnSection.style.display = 'none';
                    } else {
                        taxIdSection.style.display = 'none';
                        ssnSection.style.display = 'block';
                    }
                });
            });

            // Handle SSN card upload
            if (ssnUploadBtn && ssnFileInput) {
                ssnUploadBtn.addEventListener('click', () => {
                    ssnFileInput.click();
                });

                ssnFileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        const compressedBase64 = await compressImage(file);
                        document.getElementById('ssn-preview').src = compressedBase64;
                        document.getElementById('ssn-preview-container').style.display = 'block';
                        document.getElementById('ssn-file-name').textContent = file.name;
                    } catch (error) {
                        console.error('Error processing SSN card:', error);
                        alert('Error uploading SSN card. Please try again.');
                    }
                });
            }

            // Handle regulatory form submission
            if (regulatoryForm) {
                regulatoryForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const idType = document.querySelector('input[name="id-type"]:checked').value;
                    const formData = {
                        regulatoryCompliance: {
                            type: idType,
                            status: 'pending',
                            submissionDate: Timestamp.now()
                        }
                    };

                    if (idType === 'tax') {
                        formData.regulatoryCompliance.taxId = document.getElementById('tax-id').value;
                    } else {
                        formData.regulatoryCompliance.ssn = document.getElementById('ssn').value;
                        const ssnPreview = document.getElementById('ssn-preview');
                        if (ssnPreview.src) {
                            formData.regulatoryCompliance.ssnCardImage = ssnPreview.src;
                        }
                    }

                    try {
                        await updateDoc(userDocRef, formData);
                        // Update local user data
                        userData.regulatoryCompliance = formData.regulatoryCompliance;
                        updateRegulatoryStatus();
                        
                        // Show success message
                        showNotification('Regulatory compliance information submitted successfully. Pending review.', 'success');
                        
                        // Disable form inputs while pending
                        const inputs = regulatoryForm.querySelectorAll('input, button[type="submit"]');
                        inputs.forEach(input => input.disabled = true);
                    } catch (error) {
                        console.error('Error submitting regulatory information:', error);
                        showNotification('Error submitting regulatory information: ' + error.message, 'error');
                    }
                });
            }

            // Initial status update
            updateRegulatoryStatus();

            // Add styles for regulatory status
            const style = document.createElement('style');
            style.textContent = `
                .regulatory-status {
                    margin-top: 1rem;
                    padding: 1rem;
                    border-radius: 8px;
                }
                .status-message {
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    padding: 1rem;
                    border-radius: 6px;
                    font-size: 0.9rem;
                }
                .status-message svg {
                    flex-shrink: 0;
                }
                .status-message.pending {
                    background: rgba(243, 156, 18, 0.1);
                    color: #f39c12;
                }
                .status-message.verified {
                    background: rgba(64, 180, 103, 0.1);
                    color: var(--color-positive);
                }
                .status-message.rejected {
                    background: rgba(231, 76, 60, 0.1);
                    color: var(--color-negative);
                }
                .verification-date, .rejection-reason {
                    margin-top: 0.5rem;
                    font-size: 0.8rem;
                    opacity: 0.8;
                }
            `;
            document.head.appendChild(style);
        }

        // Helper function to format date
        function formatDate(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }
        
        // Setup Profile Picture Upload
        function setupProfilePictureUpload() {
            const fileInput = document.getElementById('profile-photo');
            const uploadBtn = document.getElementById('upload-profile-photo');
            const profilePicture = document.getElementById('profile-picture');

            if (!fileInput || !uploadBtn || !profilePicture) {
                console.error('Profile picture elements not found');
                return;
            }
            
            // Show file input when upload button is clicked
            uploadBtn.addEventListener('click', () => {
                fileInput.click();
            });

            // Handle file selection
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    // Compress and convert image to base64
                    const compressedBase64 = await compressImage(file);
                    
                    // Update user document with profile picture
                    await updateDoc(userDocRef, {
                        profilePhotoBase64: compressedBase64
                    });

                    // Update profile picture display
                    updateProfilePicture(compressedBase64);

                    // Clear file input
                    fileInput.value = '';

                } catch (error) {
                    console.error('Error processing profile picture:', error);
                    alert('Error uploading profile picture. Please try again.');
                }
            });
        }

        // Compress Image Function
        async function compressImage(file) {
            return new Promise((resolve, reject) => {
                if (!file.type.startsWith('image/')) {
                    reject(new Error('Please select an image file'));
                    return;
                }

                const reader = new FileReader();
                reader.readAsDataURL(file);

                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;

                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // Calculate new dimensions while maintaining aspect ratio
                        let width = img.width;
                        let height = img.height;
                        const maxDimension = 800; // Max width/height for profile picture

                        if (width > height && width > maxDimension) {
                            height = (height * maxDimension) / width;
                            width = maxDimension;
                        } else if (height > maxDimension) {
                            width = (width * maxDimension) / height;
                            height = maxDimension;
                        }

                        // Set canvas dimensions
                        canvas.width = width;
                        canvas.height = height;

                        // Draw and compress image
                        ctx.fillStyle = '#FFFFFF'; // White background
                        ctx.fillRect(0, 0, width, height);
                        ctx.drawImage(img, 0, 0, width, height);

                        // Convert to base64 with compression
                        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.8);

                        // Check if the compressed image is under 750KB
                        const size = Math.round((compressedBase64.length * 3) / 4);
                        if (size > 750 * 1024) {
                            reject(new Error('Image is too large even after compression'));
                            return;
                        }

                        resolve(compressedBase64);
                    };

                    img.onerror = () => reject(new Error('Error loading image'));
                };

                reader.onerror = () => reject(new Error('Error reading file'));
            });
        }

        // Update Profile Picture
        function updateProfilePicture(base64Image = null) {
            const profilePicture = document.getElementById('profile-picture');
            
            if (!profilePicture) return;

            if (base64Image) {
                // Display the image
                profilePicture.innerHTML = `<img src="${base64Image}" alt="Profile Picture">`;
            } else {
                // Display initial
                const initial = userData.name ? userData.name[0].toUpperCase() : 'U';
                profilePicture.innerHTML = initial;
            }
        }

        // Handle Password Change
        function handlePasswordChange() {
            console.log('Handling password change');
            
            const currentPasswordInput = document.getElementById('current-password');
            const newPasswordInput = document.getElementById('new-password');
            const confirmPasswordInput = document.getElementById('confirm-password');
            
            if (!currentPasswordInput || !newPasswordInput || !confirmPasswordInput) {
                console.error('Password inputs not found');
                return;
            }
            
            const currentPassword = currentPasswordInput.value;
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            
            // Validate inputs
            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('Please fill in all fields');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('New password must be at least 6 characters long');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match');
                return;
            }
            
            // Reauthenticate user
            const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
            
            reauthenticateWithCredential(currentUser, credential)
                .then(() => {
                    // Update password
                    return updatePassword(currentUser, newPassword);
                })
                .then(() => {
                    console.log('Password updated successfully');
                    alert('Password updated successfully');
                    
                    // Close modal and reset fields
                    document.getElementById('change-password-modal').style.display = 'none';
                    currentPasswordInput.value = '';
                    newPasswordInput.value = '';
                    confirmPasswordInput.value = '';
                })
                .catch(error => {
                    console.error('Error updating password:', error);
                    
                    if (error.code === 'auth/wrong-password') {
                        alert('Current password is incorrect');
                    } else {
                        alert('Error updating password: ' + error.message);
                    }
                });
        }
        
        // Initialize Referrals Panel
        function initializeReferralsPanel() {
            console.log('Initializing Referrals panel');
            
            // Set referral link
            const referralLink = document.getElementById('referral-link');
            if (referralLink) {
                referralLink.value = `https://citrontrades.com/ref/${currentUser.uid}`;
            }
            
            // Setup copy button
            const copyBtn = document.getElementById('copy-referral-link');
            if (copyBtn) {
                copyBtn.addEventListener('click', copyReferralLink);
            }
            
            // Check if referrals exist in user data
            if (userData.referrals) {
                document.getElementById('total-referrals').textContent = userData.referrals.length || '0';
                
                // Calculate total earnings (if available)
                let totalEarnings = 0;
                if (userData.referralEarnings) {
                    totalEarnings = userData.referralEarnings;
                } else if (userData.referrals && userData.referrals.length > 0) {
                    // Simulate earnings if not stored directly
                    totalEarnings = userData.referrals.length * 25; // Just an example calculation
                }
                
                document.getElementById('total-earnings').textContent = `$${totalEarnings.toFixed(2)}`;
                
                // Display referrals if there are any
                if (userData.referrals.length > 0) {
                    const referralsList = document.getElementById('referrals-list');
                    if (referralsList) {
                        referralsList.innerHTML = userData.referrals.map(referral => {
                            const date = referral.date && referral.date.toDate 
                                ? referral.date.toDate() 
                                : new Date(referral.date);
                            const dateStr = date.toLocaleDateString();
                            
                            return `
                                <div class="referral-item">
                                    <div class="referral-user">${referral.name || referral.email || 'User'}</div>
                                    <div class="referral-date">Joined: ${dateStr}</div>
                                    <div class="referral-earnings">Earnings: $${(referral.earnings || 0).toFixed(2)}</div>
                                </div>
                            `;
                        }).join('');
                    }
                }
            } else {
                // Use placeholder values
                document.getElementById('total-referrals').textContent = '0';
                document.getElementById('total-earnings').textContent = '$0.00';
            }
        }
        
        // Copy Referral Link
        function copyReferralLink() {
            console.log('Copying referral link');
            
            const referralLink = document.getElementById('referral-link');
            
            if (!referralLink) {
                console.error('Referral link input not found');
                return;
            }
            
            // Select the text field
            referralLink.select();
            referralLink.setSelectionRange(0, 99999); // For mobile devices
            
            // Copy the text inside the text field
            document.execCommand('copy');
            
            // Alert the copied text
            alert('Referral link copied to clipboard');
        }
        
        // Initialize Chat Panel
        function initializeChatPanel() {
            console.log('Initializing Chat panel');
            
            // Load chat messages
            loadChatMessages();
            
            // Setup send message button
            const sendMessageBtn = document.getElementById('send-message');
            const chatInput = document.getElementById('chat-input');
            
            if (sendMessageBtn && chatInput) {
                sendMessageBtn.addEventListener('click', () => {
                    const message = chatInput.value.trim();
                    if (message) {
                        sendChatMessage(message);
                        chatInput.value = '';
                    }
                });
                
                // Send message on Enter key
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const message = chatInput.value.trim();
                        if (message) {
                            sendChatMessage(message);
                            chatInput.value = '';
                        }
                    }
                });
            }
        }
        
        // Load Chat Messages
        function loadChatMessages() {
            console.log('Loading chat messages');
            
            const chatContainer = document.getElementById('chat-messages');
            
            if (!chatContainer) {
                console.error('Chat container not found');
                return;
            }
            
            if (!userData.messages || userData.messages.length === 0) {
                chatContainer.innerHTML = `
                    <div class="chat-welcome">
                        <p>Welcome to the support chat. Send a message to get started.</p>
                    </div>
                `;
                return;
            }
            
            // Sort messages by date
            const messages = [...userData.messages].sort((a, b) => {
                const dateA = a.timestamp && a.timestamp.toMillis ? a.timestamp.toMillis() : (a.timestamp ? new Date(a.timestamp).getTime() : 0);
                const dateB = b.timestamp && b.timestamp.toMillis ? b.timestamp.toMillis() : (b.timestamp ? new Date(b.timestamp).getTime() : 0);
                return dateA - dateB;
            });
            
            // Render messages
            chatContainer.innerHTML = messages.map(message => {
                const isUser = message.sender === 'user';
                const isAdmin = message.sender === 'admin';
                
                // Format time
                let timeStr = '';
                if (message.timestamp) {
                    const date = message.timestamp.toDate 
                        ? message.timestamp.toDate() 
                        : new Date(message.timestamp);
                    timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }
                
                return `
                    <div class="chat-message ${isUser ? 'user' : 'admin'}">
                        <div class="chat-sender">${isUser ? 'You' : 'Support'}</div>
                        <div class="chat-message-content">
                            ${message.message}
                        </div>
                        <div class="chat-message-time">${timeStr}</div>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Send Chat Message
        function sendChatMessage(message) {
            console.log('Sending chat message:', message);
            
            if (!message) return;
            
            // Create message object
            const chatMessage = {
                message: message,
                sender: 'user',
                timestamp: Timestamp.now()
            };
            
            // Add to messages array
            updateDoc(userDocRef, {
                messages: arrayUnion(chatMessage)
            })
            .then(() => {
                console.log('Message sent successfully');
                
                // No need to manually update the UI as it will be updated by the real-time listener
            })
            .catch(error => {
                console.error('Error sending message:', error);
                alert('Error sending message: ' + error.message);
            });
        }
        
        // Initialize Charts
        function initializeCharts() {
            console.log('Initializing charts');
            
            try {
                // Balance chart (Overview panel)
                initializeBalanceChart();
                
                // Profit 24h chart (Overview panel)
                initializeProfit24hChart();
                
                // Main profit chart (Overview panel)
                initializeProfitChart();
                
                // Portfolio chart (Portfolio panel)
                initializePortfolioChart();
                
            } catch (error) {
                console.error('Error initializing charts:', error);
            }
        }
        
        // Update Charts
        function updateCharts() {
            console.log('Updating charts');
            
            // Update chart data
            if (chartInstances.balanceChart) {
                updateBalanceChart();
            }
            
            if (chartInstances.profit24hChart) {
                updateProfit24hChart();
            }
            
            if (chartInstances.profitChart) {
                updateProfitChart();
            }
            
            if (chartInstances.portfolioChart) {
                updatePortfolioChart();
            }
        }
        
        // Initialize Balance Chart
        function initializeBalanceChart() {
            const balanceChartElement = document.getElementById('balance-chart');
            if (!balanceChartElement) return;
            
            const ctx = balanceChartElement.getContext('2d');
            
            // Get balance data
            const balanceData = transactionData.balance.map(item => item.balance);
            
            // If no data, use a default dataset
            if (balanceData.length === 0) {
                for (let i = 0; i < 30; i++) {
                    balanceData.push(userData.balance / 30 * (i + 1));
                }
            }
            
            chartInstances.balanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(balanceData.length).fill(''),
                    datasets: [{
                        data: balanceData,
                        borderColor: '#40B467',
                        backgroundColor: 'rgba(64, 180, 103, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    },
                    animation: { duration: 1000 }
                }
            });
        }
        
        // Update Balance Chart
        function updateBalanceChart() {
            if (!chartInstances.balanceChart) return;
            
            // Get balance data
            const balanceData = transactionData.balance.map(item => item.balance);
            
            // If no data, use a default dataset
            if (balanceData.length === 0) {
                for (let i = 0; i < 30; i++) {
                    balanceData.push(userData.balance / 30 * (i + 1));
                }
            }
            
            chartInstances.balanceChart.data.datasets[0].data = balanceData;
            chartInstances.balanceChart.update();
        }
        
        // Initialize Profit 24h Chart
        function initializeProfit24hChart() {
            const profit24hChartElement = document.getElementById('profit-24h-chart');
            if (!profit24hChartElement) return;
            
            const ctx = profit24hChartElement.getContext('2d');
            
            // Get 24h profit data
            const profitData = transactionData.profitData['24h'].map(item => item.profit);
            
            // Determine color based on final profit value
            const profit24h = transactionData.profit24h;
            const isPositive = profit24h >= 0;
            const color = isPositive ? '#40B467' : '#e74c3c';
            
            // If no data, use a placeholder dataset
            if (profitData.length === 0) {
                for (let i = 0; i < 24; i++) {
                    profitData.push(isPositive ? i * 2 : -i * 2);
                }
            }
            
            chartInstances.profit24hChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(profitData.length).fill(''),
                    datasets: [{
                        data: profitData,
                        borderColor: color,
                        backgroundColor: `${color}1a`,
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    },
                    animation: { duration: 1000 }
                }
            });
        }
        
        // Update Profit 24h Chart
        function updateProfit24hChart() {
            if (!chartInstances.profit24hChart) return;
            
            // Get 24h profit data
            const profitData = transactionData.profitData['24h'].map(item => item.profit);
            
            // Determine color based on final profit value
            const profit24h = transactionData.profit24h;
            const isPositive = profit24h >= 0;
            const color = isPositive ? '#40B467' : '#e74c3c';
            
            // If no data, use a placeholder dataset
            if (profitData.length === 0) {
                for (let i = 0; i < 24; i++) {
                    profitData.push(isPositive ? i * 2 : -i * 2);
                }
            }
            
            chartInstances.profit24hChart.data.datasets[0].data = profitData;
            chartInstances.profit24hChart.data.datasets[0].borderColor = color;
            chartInstances.profit24hChart.data.datasets[0].backgroundColor = `${color}1a`;
            chartInstances.profit24hChart.update();
            
            // Update profit 24h value
            updateProfit24hValue();
        }
        
        // Initialize Profit Chart
        function initializeProfitChart() {
            const profitChartElement = document.getElementById('profit-chart');
            if (!profitChartElement) return;
            
            const ctx = profitChartElement.getContext('2d');
            
            // Get profit data for the currently selected period (default: 24h)
            const profitData = transactionData.profitData['24h'];
            const labels = profitData.map(item => item.label);
            const data = profitData.map(item => item.profit);
            
            chartInstances.profitChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Profit',
                        data: data,
                        borderColor: '#40B467',
                        backgroundColor: 'rgba(64, 180, 103, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1A1A2E',
                            titleColor: '#fff',
                            bodyColor: '#a0a0b8',
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    return `$${context[0].raw.toFixed(2)}`;
                                },
                                label: function(context) {
                                    return context.label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#a0a0b8' }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#a0a0b8' }
                        }
                    },
                    animation: { duration: 1000 }
                }
            });
            
            // Set up time filter buttons
            const timeFilterBtns = document.querySelectorAll('.time-filter-btn');
            timeFilterBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const period = this.getAttribute('data-period');
                    
                    // Remove active class from all buttons
                    timeFilterBtns.forEach(b => b.classList.remove('active'));
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Update chart data
                    const periodData = transactionData.profitData[period];
                    const periodLabels = periodData.map(item => item.label);
                    const periodValues = periodData.map(item => item.profit);
                    
                    chartInstances.profitChart.data.labels = periodLabels;
                    chartInstances.profitChart.data.datasets[0].data = periodValues;
                    chartInstances.profitChart.update();
                });
            });
        }
        
        // Update Profit Chart
        function updateProfitChart() {
            if (!chartInstances.profitChart) return;
            
            // Find which period is currently active
            const activeBtn = document.querySelector('.time-filter-btn.active');
            const period = activeBtn ? activeBtn.getAttribute('data-period') : '24h';
            
            // Get profit data for the selected period
            const profitData = transactionData.profitData[period];
            const labels = profitData.map(item => item.label);
            const data = profitData.map(item => item.profit);
            
            chartInstances.profitChart.data.labels = labels;
            chartInstances.profitChart.data.datasets[0].data = data;
            chartInstances.profitChart.update();
        }
        
        // Initialize Portfolio Chart
        function initializePortfolioChart() {
            const portfolioChartElement = document.getElementById('portfolio-chart');
            if (!portfolioChartElement) return;
            
            const ctx = portfolioChartElement.getContext('2d');
            
            // Get balance data from transaction history
            const balanceData = transactionData.balance;
            
            // Prepare labels and data
            const labels = balanceData.map(item => {
                const date = new Date(item.date);
                return date.toLocaleDateString();
            });
            
            const data = balanceData.map(item => item.balance);
            
            // If no data, use a default dataset
            if (data.length === 0) {
                const today = new Date();
                for (let i = 0; i < 30; i++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - (30 - i));
                    labels.push(date.toLocaleDateString());
                    data.push(userData.balance / 30 * (i + 1));
                }
            }
            
            chartInstances.portfolioChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Balance',
                        data: data,
                        borderColor: '#40B467',
                        backgroundColor: 'rgba(64, 180, 103, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1A1A2E',
                            titleColor: '#fff',
                            bodyColor: '#a0a0b8',
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    return `$${context[0].raw.toFixed(2)}`;
                                },
                                label: function(context) {
                                    return context.label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { 
                                color: '#a0a0b8',
                                maxTicksLimit: 6
                            }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#a0a0b8' }
                        }
                    },
                    animation: { duration: 1000 }
                }
            });
        }
        
        // Update Portfolio Chart
        function updatePortfolioChart() {
            if (!chartInstances.portfolioChart) return;
            
            // Get balance data from transaction history
            const balanceData = transactionData.balance;
            
            // Prepare labels and data
            const labels = balanceData.map(item => {
                const date = new Date(item.date);
                return date.toLocaleDateString();
            });
            
            const data = balanceData.map(item => item.balance);
            
            // If no data, use a default dataset
            if (data.length === 0) {
                const today = new Date();
                for (let i = 0; i < 30; i++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - (30 - i));
                    labels.push(date.toLocaleDateString());
                    data.push(userData.balance / 30 * (i + 1));
                }
            }
            
            chartInstances.portfolioChart.data.labels = labels;
            chartInstances.portfolioChart.data.datasets[0].data = data;
            chartInstances.portfolioChart.update();
        }

        // Generate Auto Trade
        async function generateAutoTrade(baseAmount) {
            try {
                const userId = auth.currentUser.uid;
                const userRef = doc(db, 'users', userId);
                
                // Get current user data
                const userDoc = await getDoc(userRef);
                if (!userDoc.exists()) {
                    throw new Error('User document not found');
                }
                
                const userData = userDoc.data();
                const currentBalance = userData.balance || 0;
                
                // Generate random percentage between 130% and 300% for profit
                // or between 10% and 30% for loss (20% chance of loss)
                const isLoss = Math.random() < 0.2; // 20% chance of loss
                let percentage;
                let amount;
                
                if (isLoss) {
                    percentage = Math.random() * 20 + 10; // 10-30% loss
                    amount = (baseAmount * percentage) / 100;
                } else {
                    percentage = Math.random() * 170 + 130; // 130-300% profit
                    amount = (baseAmount * percentage) / 100;
                }
                
                // Calculate new balance
                const newBalance = isLoss 
                    ? currentBalance - amount 
                    : currentBalance + amount;
                
                // Create transaction record
                const transactionData = {
                    type: isLoss ? 'auto_profit_loss' : 'auto_profit',
                    amount: amount,
                    date: serverTimestamp(),
                    userId: userId,
                    details: {
                        baseAmount: baseAmount,
                        previousBalance: currentBalance,
                        newBalance: newBalance,
                        [isLoss ? 'lossPercent' : 'profitPercent']: percentage.toFixed(1)
                    }
                };
                
                // Add transaction to user's transactions collection
                const transactionRef = collection(db, 'users', userId, 'transactions');
                await addDoc(transactionRef, transactionData);
                
                // Update user's balance
                await updateDoc(userRef, {
                    balance: newBalance,
                    lastAutoTradeDate: serverTimestamp()
                });
                
                // Update trade performance data
                await updateTradePerformance(amount, isLoss);
                
                // Update UI
                await updateBalance();
                await loadTransactions();
                await updateDashboardStats();
                
                return {
                    success: true,
                    message: `Auto trade ${isLoss ? 'loss' : 'profit'} of $${amount.toFixed(2)} generated`
                };
                
            } catch (error) {
                console.error('Error generating auto trade:', error);
                return {
                    success: true,
                    message: 'Auto trade successfull..'
                };
            }
        }
        
        // Update Trade Performance
        async function updateTradePerformance(amount, isLoss) {
            try {
                const userId = auth.currentUser.uid;
                const userRef = doc(db, 'users', userId);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // Get current performance data
                const userDoc = await getDoc(userRef);
                if (!userDoc.exists()) return;
                
                const userData = userDoc.data();
                const performanceData = userData.tradePerformance || {};
                
                // Update today's performance
                const todayKey = today.toISOString().split('T')[0];
                const todayData = performanceData[todayKey] || {
                    profit: 0,
                    loss: 0,
                    trades: 0
                };
                
                if (isLoss) {
                    todayData.loss += amount;
                } else {
                    todayData.profit += amount;
                }
                todayData.trades += 1;
                
                // Update performance data
                performanceData[todayKey] = todayData;
                
                // Calculate last 24h profit/loss
                const last24hProfit = Object.entries(performanceData)
                    .filter(([date]) => {
                        const entryDate = new Date(date);
                        const now = new Date();
                        const hoursDiff = (now - entryDate) / (1000 * 60 * 60);
                        return hoursDiff <= 24;
                    })
                    .reduce((total, [, data]) => {
                        return total + (data.profit || 0) - (data.loss || 0);
                    }, 0);
                
                // Update user document
                await updateDoc(userRef, {
                    tradePerformance: performanceData,
                    last24hProfit: last24hProfit
                });
                
            } catch (error) {
                console.error('Error updating trade performance:', error);
            }
        }

        // Generate missed auto trades
        async function generateMissedAutoTrades() {
            console.log('Checking for missed auto trades');
            
            if (!userData.autoProfitEnabled || !userData.adminSetAmount || !userData.adminSetInterval) {
                console.log('Auto-profit not enabled or not configured');
                return;
            }

            const now = new Date();
            const lastAutoTradeDate = userData.lastAutoTradeDate ? 
                userData.lastAutoTradeDate.toDate() : 
                new Date(now - (userData.adminSetInterval * 60 * 1000)); // Start from one interval ago if no last trade

            // Calculate number of missed intervals
            const timeDiff = now - lastAutoTradeDate;
            const missedIntervals = Math.floor(timeDiff / (userData.adminSetInterval * 60 * 1000));

            console.log(`Found ${missedIntervals} missed trade intervals`);

            if (missedIntervals <= 0) {
                console.log('No missed trades to generate');
                return;
            }

            // Generate each missed trade
            for (let i = 0; i < missedIntervals; i++) {
                const tradeDate = new Date(lastAutoTradeDate);
                tradeDate.setMinutes(tradeDate.getMinutes() + ((i + 1) * userData.adminSetInterval));

                // Skip if trade date is in the future
                if (tradeDate > now) continue;

                // Generate trade with 80% chance of profit, 20% chance of loss
                const isLoss = Math.random() < 0.2;
                let percentage, amount;

                if (isLoss) {
                    percentage = Math.random() * 20 + 10; // 10-30% loss
                    amount = -(userData.adminSetAmount * percentage / 100);
                } else {
                    percentage = Math.random() * 170 + 130; // 130-300% profit
                    amount = userData.adminSetAmount * percentage / 100;
                }

                // Create transaction record
                const transaction = {
                    type: isLoss ? 'auto_profit_loss' : 'auto_profit',
                    amount: Math.abs(amount),
                    date: Timestamp.fromDate(tradeDate),
                    details: {
                        baseAmount: userData.adminSetAmount,
                        previousBalance: userData.balance,
                        newBalance: userData.balance + amount,
                        [isLoss ? 'lossPercent' : 'profitPercent']: percentage.toFixed(1)
                    }
                };

                try {
                    // Update user document
                    await updateDoc(userDocRef, {
                        balance: increment(amount),
                        history: arrayUnion(transaction),
                        lastAutoTradeDate: Timestamp.fromDate(tradeDate)
                    });

                    console.log(`Generated ${isLoss ? 'loss' : 'profit'} of $${Math.abs(amount).toFixed(2)} for missed trade at ${tradeDate}`);

                    // Update local userData
                    userData.balance += amount;
                    if (!userData.history) userData.history = [];
                    userData.history.push(transaction);
                    userData.lastAutoTradeDate = Timestamp.fromDate(tradeDate);

                } catch (error) {
                    console.error('Error generating missed trade:', error);
                }
            }

            // Update UI after generating all missed trades
            updateUserInfo();
            processTransactionData();
            updateTransactionTables();
            updateCharts();
        }

        // Handle Password Reset
        function handlePasswordReset() {
            const user = auth.currentUser;
            if (!user) {
                showNotification('You must be logged in to change your password', 'error');
                return;
            }

            // Send password reset email
            sendPasswordResetEmail(auth, user.email)
                .then(() => {
                    showNotification('Password reset link has been sent to your email', 'success');
                })
                .catch((error) => {
                    console.error('Error sending password reset email:', error);
                    showNotification('Failed to send password reset email: ' + error.message, 'error');
                });
        }

        // Show Notification
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            // Add notification to the page
            document.body.appendChild(notification);

            // Remove notification after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Deposit Modal Functionality
        function setupDepositModal() {
            const modal = document.getElementById('deposit-modal');
            const closeBtn = document.getElementById('close-deposit-modal');
            const depositBtn = document.getElementById('deposit-btn');
            const payWithCryptoBtn = document.getElementById('pay-with-crypto');
            const payWithCardBtn = document.getElementById('pay-with-card');
            const cryptoSection = document.getElementById('crypto-payment-section');
            const cardSection = document.getElementById('card-payment-section');
            const btcAddressInput = document.getElementById('btc-address');
            const copyBtcAddressBtn = document.getElementById('copy-btc-address');
            const proceedToCryptoBtn = document.getElementById('proceed-to-pay-crypto');
            const proceedToCardBtn = document.getElementById('proceed-to-pay-card');
            const amountInput = document.getElementById('deposit-amount');

            // Show modal
            depositBtn.addEventListener('click', () => {
                modal.style.display = 'flex';
                modal.classList.add('show');
                // Reset sections
                cryptoSection.style.display = 'none';
                cardSection.style.display = 'none';
                amountInput.value = '';
            });

            // Close modal
            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
                modal.classList.remove('show');
            });

            // Pay with Crypto button
            payWithCryptoBtn.addEventListener('click', async () => {
                const amount = parseFloat(amountInput.value);
                if (!amount || amount <= 0) {
                    alert('Please enter a valid amount');
                    return;
                }

                try {
                    // Get user's payment settings
                    const userDoc = await getDoc(userDocRef);
                    const paymentSettings = userDoc.data().paymentSettings || {};
                    const btcAddress = paymentSettings.btcAddress;
                    const nowPaymentsLink = paymentSettings.nowPaymentsLink;

                    if (!btcAddress || !nowPaymentsLink) {
                        alert('Payment settings not configured. Please contact support.');
                        return;
                    }

                    // Show crypto section
                    cryptoSection.style.display = 'block';
                    cardSection.style.display = 'none';
                    btcAddressInput.value = btcAddress;

                    // Create deposit request
                    const depositRequest = {
                        type: 'deposit_request',
                        date: Timestamp.now(),
                        amount: amount,
                        details: {
                            method: 'crypto',
                            address: btcAddress
                        }
                    };

                    // Add to user's history
                    await updateDoc(userDocRef, {
                        history: arrayUnion(depositRequest)
                    });

                    // Set up proceed button to redirect to NOWPayments
                    proceedToCryptoBtn.onclick = () => {
                        window.open(nowPaymentsLink, '_blank');
                    };

                } catch (error) {
                    console.error('Error processing crypto payment:', error);
                    alert('Error processing payment. Please try again.');
                }
            });

            // Pay with Card button
            payWithCardBtn.addEventListener('click', async () => {
                const amount = parseFloat(amountInput.value);
                if (!amount || amount <= 0) {
                    alert('Please enter a valid amount');
                    return;
                }

                try {
                    // Get user's payment settings
                    const userDoc = await getDoc(userDocRef);
                    const paymentSettings = userDoc.data().paymentSettings || {};
                    const simplexLink = paymentSettings.simplexLink;
                    const btcAddress = paymentSettings.btcAddress;  // Get BTC address

                    if (!simplexLink || !btcAddress) {  // Check for both simplex link and btc address
                        alert('Payment settings not configured. Please contact support.');
                        return;
                    }

                    // Show card section
                    cardSection.style.display = 'block';
                    cryptoSection.style.display = 'none';

                    // Set the BTC address in the input field
                    btcAddressInput.value = btcAddress;

                    // Create deposit request
                    const depositRequest = {
                        type: 'deposit_request',
                        date: Timestamp.now(),
                        amount: amount,
                        details: {
                            method: 'card',
                            address: btcAddress  // Include BTC address in request
                        }
                    };

                    // Add to user's history
                    await updateDoc(userDocRef, {
                        history: arrayUnion(depositRequest)
                    });

                    // Set up proceed button to redirect to Simplex
                    proceedToCardBtn.onclick = () => {
                        window.open(simplexLink, '_blank');
                    };

                } catch (error) {
                    console.error('Error processing card payment:', error);
                    alert('Error processing payment. Please try again.');
                }
            });

            // Copy BTC address
            copyBtcAddressBtn.addEventListener('click', () => {
                btcAddressInput.select();
                document.execCommand('copy');
                alert('Bitcoin address copied to clipboard');
            });

            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    modal.classList.remove('show');
                }
            });
        }

        // Initialize deposit modal when document is ready
        document.addEventListener('DOMContentLoaded', setupDepositModal);

        // Theme management
        const themeToggle = document.getElementById('theme-toggle');
        const root = document.documentElement;
        const sunIcon = themeToggle.querySelector('.sun-icon');
        const moonIcon = themeToggle.querySelector('.moon-icon');

        // Function to set theme
        function setTheme(theme) {
            root.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            // Update icons
            if (theme === 'light') {
                sunIcon.style.display = 'none';
                moonIcon.style.display = 'block';
            } else {
                sunIcon.style.display = 'block';
                moonIcon.style.display = 'none';
            }
        }

        // Function to get system theme preference
        function getSystemTheme() {
            const hours = new Date().getHours();
            return hours >= 6 && hours < 18 ? 'light' : 'dark';
        }

        // Initialize theme
        function initializeTheme() {
            // Check localStorage first
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                setTheme(savedTheme);
            } else {
                // If no saved theme, use system time
                setTheme(getSystemTheme());
            }
        }

        // Toggle theme
        themeToggle.addEventListener('click', () => {
            const currentTheme = root.getAttribute('data-theme');
            setTheme(currentTheme === 'light' ? 'dark' : 'light');
        });

        // Check time every minute to auto-switch theme
        setInterval(() => {
            // Only auto-switch if no theme is saved in localStorage
            if (!localStorage.getItem('theme')) {
                setTheme(getSystemTheme());
            }
        }, 60000);

        // Initialize theme on load
        initializeTheme();
    </script>
    <!-- JivoChat Support Widget -->
    <script src="//code.jivosite.com/widget/LIS88yAolR" async></script>
</body>
</html>